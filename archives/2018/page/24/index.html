<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>Archives: 2018 | 张慕晖的博客</title>
  
  

  <link rel="alternate" href="/atom.xml" title="张慕晖的博客">

  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  
  <!-- link -->
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.1/katex.min.css">

  
  
  <link rel="undefined" href>
  
  

  


  
  <link rel="stylesheet" href="/style.css">
  

  



  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
    <!-- ga -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-119345306-1', 'https://zhanghuimeng.github.io/');
      ga('send', 'pageview');
    </script><!-- hexo-inject:begin --><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css'><!-- hexo-inject:end -->
  
  
</head>

<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="loading-bar-wrapper">
  <div id="loading-bar" class="pure"></div>
</div>

    <script>setLoadingBarProgress(20)</script>
    <header class="l_header pure">
	<div class="wrapper">
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href="/">
        
          张慕晖的博客
        
      </a>
			<div class="menu">
				<ul class="h-list">
          
  					
  						<li>
								<a id="https:zhanghuimeng.github.io" class="nav flat-box" href="https://zhanghuimeng.github.io/">
									<i class="fas fa-home fa-fw"></i>&nbsp;主页
								</a>
							</li>
      			
  						<li>
								<a id="tags" class="nav flat-box" href="/tags/">
									<i class="fas fa-rss fa-fw"></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a id="archives" class="nav flat-box" href="/archives/">
									<i class="fas fa-archive fa-fw"></i>&nbsp;归档
								</a>
							</li>
      			
  						<li>
								<a id="categories" class="nav flat-box" href="/categories/">
									<i class="fas fa-users fa-fw"></i>&nbsp;分类
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索">
						<span class="icon"><i class="fas fa-search fa-fw"></i></span>
					</form>
				</div>
			
			<ul class="switcher h-list">
				
					<li class="s-search"><a class="fas fa-search fa-fw" href="javascript:void(0)"></a></li>
				
				<li class="s-menu"><a class="fas fa-bars fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>

		<div class="nav-sub container container--flex">
			<a class="logo flat-box"></a>
			<ul class="switcher h-list">
				<li class="s-comment"><a class="flat-btn fas fa-comments fa-fw" href="javascript:void(0)"></a></li>
				<li class="s-toc"><a class="flat-btn fas fa-list fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu">
      <ul>
          
              
                  <li>
										<a id="https:zhanghuimeng.github.io" class="nav flat-box" href="https://zhanghuimeng.github.io/">
											<i class="fas fa-home fa-fw"></i>&nbsp;主页
										</a>
                  </li>
              
                  <li>
										<a id="tags" class="nav flat-box" href="/tags/">
											<i class="fas fa-rss fa-fw"></i>&nbsp;标签
										</a>
                  </li>
              
                  <li>
										<a id="archives" class="nav flat-box" href="/archives/">
											<i class="fas fa-archive fa-fw"></i>&nbsp;归档
										</a>
                  </li>
              
                  <li>
										<a id="categories" class="nav flat-box" href="/categories/">
											<i class="fas fa-users fa-fw"></i>&nbsp;分类
										</a>
                  </li>
              
       
      </ul>
		</nav>
    </header>
	</aside>

    <script>setLoadingBarProgress(40);</script>
    <div class="l_body">
    <div class='container clearfix'>
        <div class='l_main'>
            
	
    <script>
        window.subData= { title:'year : 2018'}
    </script>




  <section class="post-list">
      



      

      

      
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/post/the-principles-and-implementation-of-miller-rabin-primality-test/">
              
                  Miller-Rabin素性检测的原理与实现
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://zhanghuimeng.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            张慕晖
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2018-06-29
          </a>
        </div>
      
      
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="miller-rabin素性检测的原理"><a class="markdownIt-Anchor" href="#miller-rabin素性检测的原理"></a> Miller-Rabin素性检测的原理</h2>
<p>按维基百科的说法，这个算法似乎本来是一个依赖于广义黎曼假设的确定性算法，后来经过改造，变成了一个依赖于二次剩余理论的非确定性算法。不过这个地方我也还没有完全搞懂，再说吧。</p>
<p>当然，即使不从历史角度出发，也是能比较清楚地搞懂这个算法的思路来源的。下面的介绍参考了相关的维基百科。<a href="#bib1" id="bib1ref"><sup>[1]</sup></a></p>
<p>首先介绍一个引理。<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>1</mn><mn>2</mn></msup><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>p</mi></mrow><annotation encoding="application/x-tex">1^2 \bmod p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mbin"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mo>−</mo><mn>1</mn><msup><mo>)</mo><mn>2</mn></msup><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>p</mi></mrow><annotation encoding="application/x-tex">(-1)^2 \bmod p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mbin"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span>总是得到1，我们称这两个数为1的“平凡平方根”。引理的内容是：当<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span>为素数且<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mo>&gt;</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">p&gt;2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>时，不存在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>p</mi></mrow><annotation encoding="application/x-tex">1 \bmod p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mbin"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span>的“非平凡平方根”。为了证明该引理，我们假设<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span>是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>p</mi></mrow><annotation encoding="application/x-tex">1 \bmod p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mbin"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span>的平方根，于是有</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>x</mi><mn>2</mn></msup><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>p</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">x^2 \equiv 1 (\bmod p)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8641079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">p</span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi>x</mi><mo>+</mo><mn>1</mn><mo>)</mo><mo>(</mo><mi>x</mi><mo>−</mo><mn>1</mn><mo>)</mo><mo>≡</mo><mn>0</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>p</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">(x + 1)(x - 1) \equiv 0 (\bmod p)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">p</span><span class="mclose">)</span></span></span></span></span></p>
<p>也就是说，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi>x</mi><mo>−</mo><mn>1</mn><mo>)</mo><mo>(</mo><mi>x</mi><mo>+</mo><mn>1</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">(x - 1)(x + 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>能够被素数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span>整除。根据欧几里得引理，必有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span>能够整除<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>或<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，即<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>p</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">x \equiv 1 (\bmod p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.46375em;vertical-align:0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">p</span><span class="mclose">)</span></span></span></span>或<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>≡</mo><mo>−</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>p</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">x \equiv -1 (\bmod p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.46375em;vertical-align:0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">p</span><span class="mclose">)</span></span></span></span>。因此，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>p</mi></mrow><annotation encoding="application/x-tex">1 \bmod p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mbin"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span>的平方根均为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span>的平凡平方根，引理得证。</p>
<p>下面我们进行一个信仰之跃，介绍Miller-Rabin算法的思路。假设<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>是一个奇素数，且<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>&gt;</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">n &gt; 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>，此时<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>必然为一个偶数，可以被表示为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mi>s</mi></msup><mo>×</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">2^s \times d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.747722em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span>的形式，其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">s</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span>均为正整数，且<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span>是奇数。由费马小定理，对于一个素数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>，有</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^{n-1} \equiv 1 (\bmod n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.864108em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>因此</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><msup><mn>2</mn><mi>s</mi></msup><mi>d</mi></mrow></msup><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^{2^s d} \equiv 1 (\bmod n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.92998em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.92998em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385428571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">s</span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">d</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>由上述引理，我们可以对上式取平方根，得到的必然为平凡平方根1或-1。假如我们得到的平方根为1，则继续取平方根，如此循环，最后必然会得到下列两种情况之一：</p>
<ol>
<li>得到某个<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>≤</mo><mi>r</mi><mo>≤</mo><mi>s</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0 \leq r \leq s -1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.78041em;vertical-align:-0.13597em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，它满足<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><msup><mn>2</mn><mi>r</mi></msup><mi>d</mi></mrow></msup><mo>≡</mo><mo>−</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^{2^r d} \equiv -1 (\bmod n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.87998em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.87998em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385428571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">d</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></li>
<li>发现对于任意<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>≤</mo><mi>r</mi><mo>≤</mo><mi>s</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0\leq r \leq s -1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.78041em;vertical-align:-0.13597em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，都满足<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><msup><mn>2</mn><mi>r</mi></msup><mi>d</mi></mrow></msup><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^{2^r d} \equiv 1 (\bmod n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.87998em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.87998em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385428571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">d</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>，即<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mi>d</mi></msup><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^d \equiv 1 (\bmod n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.849108em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></li>
</ol>
<p>Miller-Rabin素性检测就是上述原理的逆否：如果我们能找到这样一个<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span></span></span></span>，使得对任意<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>≤</mo><mi>r</mi><mo>≤</mo><mi>s</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0 \leq r \leq s - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.78041em;vertical-align:-0.13597em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，都满足以下两个式子：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><msup><mn>2</mn><mi>r</mi></msup><mi>d</mi></mrow></msup><mpadded width="0px"><mo></mo></mpadded><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^{2^r d} \not\equiv 1 (\bmod n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.12442em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.92998em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385428571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">d</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span><span class="base"><span class="strut" style="height:0.46375em;vertical-align:0em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mi>d</mi></msup><mpadded width="0px"><mo></mo></mpadded><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^d \not\equiv 1 (\bmod n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.093548em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span><span class="base"><span class="strut" style="height:0.46375em;vertical-align:0em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>则<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>必然不是一个素数。我们用记号<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>W</mi><mi>n</mi></msub><mo>(</mo><mi>a</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">W_n(a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mclose">)</span></span></span></span>表示<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span></span></span></span>满足上述条件，称<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span></span></span></span>是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为合数的一个凭证（witness to the compositeness of n）。</p>
<h2 id="miller-rabin素性检测的算法伪代码"><a class="markdownIt-Anchor" href="#miller-rabin素性检测的算法伪代码"></a> Miller-Rabin素性检测的算法伪代码</h2>
<p>下面给出一种Miller-Rabin素性检测的算法伪代码。<a href="#bib2" id="bib2ref"><sup>[2]</sup></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Miller-Rabin(n)</span><br><span class="line">    把n-1写成n-1 = 2^k * m，其中m是一个奇数</span><br><span class="line">    选取随机整数a，使得1 &lt;= a &lt;= n-1</span><br><span class="line">    b = a^m (mod n)</span><br><span class="line">    if b == 1 (mod n)</span><br><span class="line">        return (&quot;n is prime&quot;)</span><br><span class="line">    for i = 0 to k-1</span><br><span class="line">        if b == -1 (mod n)</span><br><span class="line">            return (&quot;n is prime&quot;)</span><br><span class="line">        else</span><br><span class="line">            b = b^2 (mod n)</span><br><span class="line">    return (&quot;n is composite&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="miller-rabin算法的正确性"><a class="markdownIt-Anchor" href="#miller-rabin算法的正确性"></a> Miller-Rabin算法的正确性</h2>
<p>上述证明虽然说明了Miller-Rabin算法能够在某些情况下证明<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>不是一个素数，但并没有证明这个算法对于素数不会做出错误判断，也没有说明这个算法能够给出正确判断的概率。事实上，上述算法是一个<strong>偏是</strong>的Monte-Carlo算法，且错误概率至多为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mn>1</mn><mn>4</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。</p>
<p>下面首先说明什么是“偏是的Monte-Carlo算法”（定义摘自<a href="#bib2" id="bib2ref"><sup>[2]</sup></a>）。第一个问题是，何为判定问题和随机算法？</p>
<blockquote>
<p>一个判定问题（decision problem）是指只能回答“是（yes）”或者“否（no）”的问题。一个随机算法是指任一使用了随机数的算法（反过来，一个算法没有使用随机数，称为确定的算法）。</p>
</blockquote>
<p>下面是对“判定问题的随机算法”的定义。</p>
<blockquote>
<p>对于一个判定问题的一个偏是（yes-biased）Monte Carlo算法是具有下列性质的一个概率算法：一个“是”回答总是正确的，但一个“否”回答也许是不正确的。类似地，可定义一个偏否的（no-biased）Monte Carlo算法。我们说一个偏是Monte Carlo算法具有错误概率<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">ϵ</span></span></span></span>，如果算法对任何回答应该为“是”的实例（instance）至多以<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">ϵ</span></span></span></span>的概率给出一个不正确的回答“否”（这个概率是对于给定的输入，通过算法产生所有可能的随机选择进行计算而得出的）。</p>
</blockquote>
<p>我们要回答的判定问题是这样的：给定一个正整数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>≥</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">n \geq 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>，问<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>是一个合数吗？</p>
<h3 id="证明miller-rabin算法是一个偏是的monte-carlo算法"><a class="markdownIt-Anchor" href="#证明miller-rabin算法是一个偏是的monte-carlo算法"></a> 证明Miller-Rabin算法是一个偏是的Monte Carlo算法</h3>
<p>使用反证法证明这一结论：假定上述算法对于某个素数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>回答了“<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为合数”，然后推出矛盾。由于算法回答“<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为合数”，必有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mi>m</mi></msup><mpadded width="0px"><mo></mo></mpadded><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^m \not\equiv 1 (\bmod n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span><span class="base"><span class="strut" style="height:0.46375em;vertical-align:0em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>。现在考虑在算法中检测的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span></span></span></span>的序列。由于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span></span></span></span>在<code>for</code>循环的每一步中都做平方运算，因此我们测试的值序列为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mi>m</mi></msup><mo separator="true">,</mo><msup><mi>a</mi><mrow><mn>2</mn><mi>m</mi></mrow></msup><mo separator="true">,</mo><msup><mi>a</mi><mrow><msup><mn>2</mn><mrow><mo>(</mo><mi>k</mi><mo>−</mo><mn>1</mn><mo>)</mo></mrow></msup><mi>m</mi></mrow></msup></mrow><annotation encoding="application/x-tex">a^m, a^{2m}, a^{2^{(k-1)}m}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2341399999999998em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0396999999999998em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9667142857142857em;"><span style="top:-2.966714285714285em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span></span></span></span></span>。由于算法回答“<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为合数”，可知对于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>≤</mo><mi>i</mi><mo>≤</mo><mi>k</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0 \leq i \leq k-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.78041em;vertical-align:-0.13597em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.79549em;vertical-align:-0.13597em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，都满足：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><msup><mn>2</mn><mi>i</mi></msup><mi>m</mi></mrow></msup><mpadded width="0px"><mo></mo></mpadded><mo>≡</mo><mo>−</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^{2^i m} \not\equiv -1 (\bmod n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2389em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.04446em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9020857142857143em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span><span class="base"><span class="strut" style="height:0.46375em;vertical-align:0em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>由于我们假设<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为素数，由于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>−</mo><mn>1</mn><mo>=</mo><msup><mn>2</mn><mi>k</mi></msup><mi>m</mi></mrow><annotation encoding="application/x-tex">n - 1 = 2^k m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.849108em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mord mathdefault">m</span></span></span></span>，由费马小定理可知：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><msup><mn>2</mn><mi>k</mi></msup><mi>m</mi></mrow></msup><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^{2^k m} \equiv 1 (\bmod n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0619199999999998em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0619199999999998em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9270285714285713em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>因此<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><msup><mn>2</mn><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msup><mi>m</mi></mrow></msup></mrow><annotation encoding="application/x-tex">a^{2^{k-1}m}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.01192em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.01192em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9270285714285714em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span></span></span></span></span>是模<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>的1的平方根。由于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为素数，由引理可知，模<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>的1的平方根只有两个，即<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>±</mo><mn>1</mn><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi></mrow><annotation encoding="application/x-tex">\pm 1 \bmod n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord">±</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mbin"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>。由算法执行过程，我们可以知道：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><msup><mn>2</mn><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msup><mi>m</mi></mrow></msup><mpadded width="0px"><mo></mo></mpadded><mo>≡</mo><mo>−</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^{2^{k-1} m} \not\equiv -1 (\bmod n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.25636em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.06192em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9270285714285714em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span><span class="base"><span class="strut" style="height:0.46375em;vertical-align:0em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>由此可得</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><msup><mn>2</mn><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msup><mi>m</mi></mrow></msup><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^{2^{k-1} m} \equiv 1 (\bmod n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06192em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.06192em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9270285714285714em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>因此<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mrow><msup><mn>2</mn><mrow><mi>k</mi><mo>−</mo><mn>2</mn></mrow></msup><mi>m</mi></mrow></msup></mrow><annotation encoding="application/x-tex">a^{2^{k-2}m}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.01192em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.01192em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9270285714285714em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span></span></span></span></span>是模<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>的1的平方根。以此类推，重复上述过程，我们最后可以得到：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>a</mi><mi>m</mi></msup><mo>≡</mo><mn>1</mn><mo>(</mo><mtext> </mtext><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">a^m \equiv 1 (\bmod n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7143919999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mopen">(</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.05555555555555555em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>但在这种情况下，算法一开始就会回答“<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为素数”，因此推出矛盾。</p>
<p>（好吧，其实我们并不是很需要这个证明，我只是把《密码学原理与实践》上的证明又抄了一遍而已……）</p>
<h3 id="证明miller-rabin的错误概率不大于14"><a class="markdownIt-Anchor" href="#证明miller-rabin的错误概率不大于14"></a> 证明Miller-Rabin的错误概率不大于1/4</h3>
<p>Rabin在1977年的论文<a href="#bib3" id="bib3ref"><sup>[3]</sup></a>中证明了下列定理：若<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为大约4的合数，则有</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>3</mn><mo>(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo>)</mo></mrow><mn>4</mn></mfrac><mo>≤</mo><mi>c</mi><mo>(</mo><mrow><mi>b</mi><mi mathvariant="normal">∣</mi><msub><mi>W</mi><mi>n</mi></msub><mo>(</mo><mi>b</mi><mo>)</mo></mrow><mo>)</mo></mrow><annotation encoding="application/x-tex">\frac{3(n-1)}{4} \leq c({b | W_n(b)})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">b</span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">b</span><span class="mclose">)</span></span><span class="mclose">)</span></span></span></span></span></p>
<p>其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>W</mi><mi>n</mi></msub><mo>(</mo><mi>b</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">W_n(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">b</span><span class="mclose">)</span></span></span></span>的意思上面已经讲过了，表示<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span></span></span></span>是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为合数的一个凭证；<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mo>(</mo><mi>S</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">c(S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mclose">)</span></span></span></span>表示集合<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span>中元素的数目。上述定理表明，在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mn>1</mn><mo separator="true">,</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[1, n-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>的整数中，最多只有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mn>1</mn><mn>4</mn></mfrac><mo>(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">\frac{1}{4}(n-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>个数不是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为合数的凭证。因此，在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>[</mo><mn>1</mn><mo separator="true">,</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo>]</mo></mrow><annotation encoding="application/x-tex">[1, n-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>中任选整数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span></span></span></span>进行测试，能够测试出<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为合数的概率<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>≤</mo><mfrac><mn>3</mn><mn>4</mn></mfrac></mrow><annotation encoding="application/x-tex">\leq \frac{3}{4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，即Miller-Rabin算法的错误概率不大于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mn>1</mn><mn>4</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。（证明太长了，懒得看也懒得写了，总之论文里什么都有）</p>
<p>我们可能因此认为，连续对某个合数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>进行<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span>次测试，无法发现<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>为合数的概率小于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mfrac><mn>1</mn><mn>4</mn></mfrac><msup><mo>)</mo><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">(\frac{1}{4})^N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span>。这个界当然是正确的，但它并不紧。事实上，有人<a href="#bib4" id="bib4ref"><sup>[4]</sup></a>证明了更紧的界：如果我们不断随机选取<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span>位（二进制位）的奇数，对这个数进行<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span></span></span></span>次互相独立的随机Miller-Rabin检测，，输出第一个通过所有测试的数，令<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi>k</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{k, t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>表示这个数是合数的概率，则<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi>k</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{k, t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>比<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>4</mn><mrow><mo>−</mo><mi>t</mi></mrow></msup></mrow><annotation encoding="application/x-tex">4^{-t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7935559999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span></span>小得多。事实上，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi>k</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{k, t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>满足下列公式：</p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi><mo>≥</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">k \geq 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83041em;vertical-align:-0.13597em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>时，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi>k</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub><mo>&lt;</mo><msup><mi>k</mi><mn>2</mn></msup><msup><mn>4</mn><mrow><mn>2</mn><mo>−</mo><msqrt><mi>k</mi></msqrt></mrow></msup></mrow><annotation encoding="application/x-tex">p_{k, t} &lt; k^2 4^{2 - \sqrt{k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8252079999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0194915em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0194915em;"><span style="top:-3.0630000000000006em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mbin mtight">−</span><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.937845em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.8978450000000002em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,
-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,
-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,
35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,
-221c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467
s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422
s-65,47,-65,47z M834 80H400000v40H845z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.102155em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>=</mo><mn>2</mn><mo separator="true">,</mo><mi>k</mi><mo>≥</mo><mn>88</mn></mrow><annotation encoding="application/x-tex">t = 2, k \geq 88</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span><span class="mord">8</span></span></span></span>或<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mo>≤</mo><mi>t</mi><mo>≤</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>9</mn><mo separator="true">,</mo><mi>k</mi><mo>≥</mo><mn>21</mn></mrow><annotation encoding="application/x-tex">3 \leq t \leq k/9, k \geq21</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.78041em;vertical-align:-0.13597em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">1</span></span></span></span>时，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi>k</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub><mo>&lt;</mo><msup><mi>k</mi><mrow><mn>3</mn><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msup><msup><mn>2</mn><mi>t</mi></msup><msup><mi>t</mi><mrow><mo>−</mo><mn>1</mn><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msup><msup><mn>4</mn><mrow><mn>2</mn><mo>−</mo><msqrt><mrow><mi>t</mi><mi>k</mi></mrow></msqrt></mrow></msup></mrow><annotation encoding="application/x-tex">p_{k, t} &lt; k^{3/2} 2^t t^{-1/2} 4^{2 -\sqrt{tk}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8252079999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0194915em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">/</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">/</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0194915em;"><span style="top:-3.0630000000000006em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mbin mtight">−</span><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.937845em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.8978450000000002em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,
-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,
-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,
35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,
-221c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467
s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422
s-65,47,-65,47z M834 80H400000v40H845z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.102155em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>≥</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>9</mn><mo separator="true">,</mo><mi>k</mi><mo>≥</mo><mn>21</mn></mrow><annotation encoding="application/x-tex">t \geq k/9, k \geq 21</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">1</span></span></span></span>时，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi>k</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub><mo>&lt;</mo><mfrac><mn>7</mn><mn>20</mn></mfrac><mi>k</mi><msup><mn>2</mn><mrow><mo>−</mo><mn>5</mn><mi>t</mi></mrow></msup><mo>+</mo><mfrac><mn>1</mn><mn>7</mn></mfrac><msup><mi>k</mi><mrow><mn>15</mn><mi mathvariant="normal">/</mi><mn>4</mn></mrow></msup><msup><mn>2</mn><mrow><mo>−</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>2</mn><mi>t</mi></mrow></msup><mo>+</mo><mn>12</mn><mi>k</mi><msup><mn>2</mn><mrow><mo>−</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>4</mn><mo>−</mo><mn>3</mn><mi>t</mi></mrow></msup></mrow><annotation encoding="application/x-tex">p_{k, t} &lt; \frac{7}{20} k 2^{-5t} + \frac{1}{7} k^{15/4} 2^{-k/2 - 2t} + 12k 2^{-k/4 - 3t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8252079999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">7</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">5</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.2329999999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">7</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span><span class="mord mtight">/</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mord mtight">/</span><span class="mord mtight">2</span><span class="mbin mtight">−</span><span class="mord mtight">2</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8879999999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mord mtight">/</span><span class="mord mtight">4</span><span class="mbin mtight">−</span><span class="mord mtight">3</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mo>≥</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>4</mn><mo separator="true">,</mo><mi>k</mi><mo>≥</mo><mn>21</mn></mrow><annotation encoding="application/x-tex">t \geq k/4, k \geq 21</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">1</span></span></span></span>时，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi>k</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub><mo>&lt;</mo><mfrac><mn>1</mn><mn>7</mn></mfrac><msup><mi>k</mi><mrow><mn>15</mn><mi mathvariant="normal">/</mi><mn>4</mn></mrow></msup><msup><mn>2</mn><mrow><mo>−</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>2</mn><mi>t</mi></mrow></msup></mrow><annotation encoding="application/x-tex">p_{k, t} &lt; \frac{1}{7} k^{15/4} 2^{-k/2 -2t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8252079999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2329999999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">7</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span><span class="mord mtight">/</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mord mtight">/</span><span class="mord mtight">2</span><span class="mbin mtight">−</span><span class="mord mtight">2</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></p>
<h2 id="miller-rabin算法的实现"><a class="markdownIt-Anchor" href="#miller-rabin算法的实现"></a> Miller-Rabin算法的实现</h2>
<p>实际上这是今年密码学的最后一个编程作业：要求生成若干个512bit的奇数并用Miller-Rabin算法验证它们是否为素数，可以用2000以下的素数进行试除。代码见<a href="https://gist.github.com/zhanghuimeng/e2305a5324c6705f4eba9d94f7308769" target="_blank" rel="noopener">https://gist.github.com/zhanghuimeng/e2305a5324c6705f4eba9d94f7308769</a>。</p>
<p>选择python进行程序编写是因为python自带长整型功能，很方便。但是仍然有一些需要注意的地方，比如除法的精度<a href="#bib5" id="bib5ref"><sup>[5]</sup></a>，我在这里debug了一段时间。如果需要验证自己生成的素数的正确性，可以参考这个网站<a href="#bib6" id="bib6ref"><sup>[6]</sup></a>，可以检测很大（512bit是可以的，再大没试过）的数的素性。</p>
<p>如果我们把这个验证问题看做是“不断生成长度为512bit的奇数并进行验证，直到得到一个素数为止；之后重新进行这一实验”的过程，则可以应用论文<a href="#bib4" id="bib4ref"><sup>[4]</sup></a>中给出的界：</p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mo>≤</mo><mi>t</mi><mo>≤</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>9</mn><mo separator="true">,</mo><mi>k</mi><mo>≥</mo><mn>21</mn></mrow><annotation encoding="application/x-tex">3 \leq t \leq k/9, k \geq21</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.78041em;vertical-align:-0.13597em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">1</span></span></span></span>时，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi>k</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub><mo>&lt;</mo><msup><mi>k</mi><mrow><mn>3</mn><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msup><msup><mn>2</mn><mi>t</mi></msup><msup><mi>t</mi><mrow><mo>−</mo><mn>1</mn><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msup><msup><mn>4</mn><mrow><mn>2</mn><mo>−</mo><msqrt><mrow><mi>t</mi><mi>k</mi></mrow></msqrt></mrow></msup></mrow><annotation encoding="application/x-tex">p_{k, t} &lt; k^{3/2} 2^t t^{-1/2} 4^{2 -\sqrt{tk}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8252079999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0194915em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">/</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">/</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0194915em;"><span style="top:-3.0630000000000006em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mbin mtight">−</span><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.937845em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.8978450000000002em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,
-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,
-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,
35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,
-221c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467
s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422
s-65,47,-65,47z M834 80H400000v40H845z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.102155em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>当<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi><mo>=</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">k = 512</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span></span></span></span>时，对于几个比较小的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span></span></span></span>，可以计算出上述概率界：</p>
<table>
<thead>
<tr>
<th><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">t</span></span></span></span></th>
<th><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi>k</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{k, t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2.1713</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>18</mn></mrow></msup></mrow><annotation encoding="application/x-tex">2.1713 \times 10^{-18}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord">.</span><span class="mord">1</span><span class="mord">7</span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>4</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>8.4138</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>22</mn></mrow></msup></mrow><annotation encoding="application/x-tex">8.4138 \times 10^{-22}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mord">.</span><span class="mord">4</span><span class="mord">1</span><span class="mord">3</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>5</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>9.1537</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>25</mn></mrow></msup></mrow><annotation encoding="application/x-tex">9.1537 \times 10^{-25}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">9</span><span class="mord">.</span><span class="mord">1</span><span class="mord">5</span><span class="mord">3</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>6</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2.0681</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>27</mn></mrow></msup></mrow><annotation encoding="application/x-tex">2.0681 \times 10^{-27}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord">.</span><span class="mord">0</span><span class="mord">6</span><span class="mord">8</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>7</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>8.1180</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>30</mn></mrow></msup></mrow><annotation encoding="application/x-tex">8.1180 \times 10^{-30}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">8</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">3</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>8</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>4.9304</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>32</mn></mrow></msup></mrow><annotation encoding="application/x-tex">4.9304 \times 10^{-32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mord">.</span><span class="mord">9</span><span class="mord">3</span><span class="mord">0</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>9</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>4.2755</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>34</mn></mrow></msup></mrow><annotation encoding="application/x-tex">4.2755 \times 10^{-34}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mord">.</span><span class="mord">2</span><span class="mord">7</span><span class="mord">5</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">3</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>10</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>4.9937</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>36</mn></mrow></msup></mrow><annotation encoding="application/x-tex">4.9937 \times 10^{-36}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mord">.</span><span class="mord">9</span><span class="mord">9</span><span class="mord">3</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">3</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>11</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>7.5175</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>38</mn></mrow></msup></mrow><annotation encoding="application/x-tex">7.5175 \times 10^{-38}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">7</span><span class="mord">.</span><span class="mord">5</span><span class="mord">1</span><span class="mord">7</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">3</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>12</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1.4097</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>39</mn></mrow></msup></mrow><annotation encoding="application/x-tex">1.4097 \times 10^{-39}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">4</span><span class="mord">0</span><span class="mord">9</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">3</span><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
<tr>
<td>13</td>
<td><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3.2047</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>41</mn></mrow></msup></mrow><annotation encoding="application/x-tex">3.2047 \times 10^{-41}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mord">.</span><span class="mord">2</span><span class="mord">0</span><span class="mord">4</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">4</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></td>
</tr>
</tbody>
</table>
<p>可以看出，取<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>=</mo><mn>13</mn></mrow><annotation encoding="application/x-tex">n = 13</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">3</span></span></span></span>已经能够保证错误概率<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>&lt;</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>40</mn></mrow></msup></mrow><annotation encoding="application/x-tex">&lt; 10^{-40}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">4</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span>了。事实上，计算机发生随机错误的概率大约是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1.8</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>24</mn></mrow></msup></mrow><annotation encoding="application/x-tex">1.8 \times 10^{-24}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span>，再增加迭代次数，将Miller-Rabin算法的准确度提得更高并无意义。<a href="#bib7" id="bib7ref"><sup>[7]</sup></a></p>
<h2 id="参考文献"><a class="markdownIt-Anchor" href="#参考文献"></a> 参考文献</h2>
<p><a id="bib1" href="#bib1ref"><sup>[1]</sup></a> 米勒-拉宾素性检验. <a href="https://zh.wikipedia.org/wiki/%E7%B1%B3%E5%8B%92-%E6%8B%89%E5%AE%BE%E6%A3%80%E9%AA%8C" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/米勒-拉宾检验</a><br>
<a id="bib2" href="#bib2ref"><sup>[2]</sup></a> 《密码学原理与实践》第二版 P154 5.4 素性检测.<br>
<a id="bib3" href="#bib3ref"><sup>[3]</sup></a> Probabilistic Algorithm for Testing Primality. <a href="https://ac.els-cdn.com/0022314X80900840/1-s2.0-0022314X80900840-main.pdf?_tid=a83dac24-31c7-42a4-bb29-f9ef85871027&amp;acdnat=1530269388_63d4d83bf5a9aebc8c2ddf333f080240" target="_blank" rel="noopener">https://ac.els-cdn.com/0022314X80900840/1-s2.0-0022314X80900840-main.pdf?_tid=a83dac24-31c7-42a4-bb29-f9ef85871027&amp;acdnat=1530269388_63d4d83bf5a9aebc8c2ddf333f080240</a><br>
<a id="bib4" href="#bib4ref"><sup>[4]</sup></a> Average case error estimates for the strong probable prime test. <a href="https://www.math.dartmouth.edu/~carlp/PDF/paper88.pdf" target="_blank" rel="noopener">https://www.math.dartmouth.edu/~carlp/PDF/paper88.pdf</a><br>
<a id="bib5" href="#bib5ref"><sup>[5]</sup></a> How to get the correct accuracy with big integer division in python. <a href="https://stackoverflow.com/questions/42709746/how-to-get-the-correct-accuracy-with-big-integer-division-in-python" target="_blank" rel="noopener">https://stackoverflow.com/questions/42709746/how-to-get-the-correct-accuracy-with-big-integer-division-in-python</a><br>
<a id="bib6" href="#bib6ref"><sup>[6]</sup></a> Integer factorization calculator. <a href="https://alpertron.com.ar/ECM.HTM" target="_blank" rel="noopener">https://alpertron.com.ar/ECM.HTM</a><br>
<a id="bib7" href="#bib7ref"><sup>[7]</sup></a> RSA and prime-generator algorithms. <a href="https://stackoverflow.com/questions/4159333/rsa-and-prime-generator-algorithms/4160517#4160517" target="_blank" rel="noopener">https://stackoverflow.com/questions/4159333/rsa-and-prime-generator-algorithms/4160517#4160517</a></p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Cryptography/"><i class="fas fa-hashtag fa-fw"></i>Cryptography</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/post/art-thou-poor-by-t-dekker/">
              
                  《英诗金库》I-54：Art thou poor, by T. Dekker
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://zhanghuimeng.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            张慕晖
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2018-06-26
          </a>
        </div>
      
      
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="作品基本信息"><a class="markdownIt-Anchor" href="#作品基本信息"></a> 作品基本信息</h2>
<p>作品名称：The Happy Heart（称心满意）<br>
作者：Thomas Dekker（托马斯·德克尔）<br>
出版年代：1603<br>
编注：德克尔（Thomas Dekker，1570?-1632），英国剧作家及散文家。这首诗选自他的喜剧《能忍受考验的格里丝尔》<a href="#bib1" id="bib1ref"><sup>[1]</sup></a>。</p>
<h2 id="作品原文"><a class="markdownIt-Anchor" href="#作品原文"></a> 作品原文</h2>
<p>Art thou<a href="#note1" id="note1ref"><sup>1</sup></a> poor, yet hast thou golden slumbers?<br>
O sweet content!<br>
Art thou rich, yet is thy mind perplexed?<br>
O punishment!<br>
Dost thou laugh to see how fools are vexed<br>
To add to golden numbers<a href="#note2" id="note2ref"><sup>2</sup></a>, golden numbers?<br>
O sweet content! O sweet, O sweet content!<br>
Work apace, apace, apace, apace;<br>
Honest labour bears a lovely face;<br>
Then hey nonny nonny, hey nonny nonny!</p>
<p>Canst drink the waters of the crisped<a href="#note3" id="note3ref"><sup>3</sup></a> spring?<br>
O sweet content!<br>
Swimm’st thou in wealth, yet sink’st in thine own tears?<br>
O punishment!<br>
Then he that patiently want’s burden bears<br>
No burden bears, but is a king, a king!<br>
O sweet content! O sweet, O sweet content!<br>
Work apace, apace, apace, apace;<br>
Honest labour bears a lovely face;<br>
Then hey nonny nonny, hey nonny nonny!</p>
<h2 id="译文"><a class="markdownIt-Anchor" href="#译文"></a> 译文</h2>
<h3 id="戴镏龄-译"><a class="markdownIt-Anchor" href="#戴镏龄-译"></a> 戴镏龄 译</h3>
<p>你没有钱，却睡得甜丝丝？<br>
哦，知足常乐！<br>
你富裕，莫非却惶惑不安？<br>
哦，惩罚谴责！<br>
愚人为钱上堆钱而忧烦，<br>
你看见是不是觉得这可笑？<br>
哦，知足常乐，知足常常乐！<br>
加快工作呀，加快，加快，<br>
认真干活，就面容可爱；<br>
啷哩，咳，啷哩，咳，啷哩啊啷哩！</p>
<p>泉水涟漪，将它酌来品尝？<br>
哦，知足常乐！<br>
钱里翻滚，又泪水中浸泡？<br>
哦，惩罚谴责！<br>
贫穷的担子咬紧牙根挑，<br>
这种人没负担，是南面王！<br>
哦，知足常乐，知足常常乐！<br>
加快工作呀，加快，加快，<br>
认真干活，就面容可爱；<br>
啷哩，咳，啷哩，咳，啷哩啊啷哩！</p>
<h2 id="我的感想"><a class="markdownIt-Anchor" href="#我的感想"></a> 我的感想</h2>
<p>在<a href="/post/prothalamion-by-e-spenser">Prothalamion</a>那里卡了得有一个多月了，除了很忙之外，主要还是因为这首诗太长，读不完。所以先从下一首开始了。</p>
<p>有人（Amy Marcy Cheney Beach）曾经把这首歌改编成曲子。Youtube上有这首歌的演唱版本<a href="#bib2" id="bib2ref"><sup>[2]</sup></a>，好像还不难听。不过更神奇的是，我发现这首歌曾经被Beatles（或者更准确的说是Paul McCartney）改编成一首叫&quot;Golden Slumbers / Carry That Weight / The End&quot;的歌，真是令人惊讶……</p>
<p>好吧，其实看了这首诗，我心里还是挺不舒服的，不知道是当时的作者太不食人间烟火，还是现代社会已经彻底的变了。至少现在人们已经不喜欢“没有钱，却睡得好”这种说法了，没有钱，必定要天天焦虑，日日焦虑；而有了钱，心里就有了底气，可以每日睡得安稳了（虽然可能还是会焦虑自己的钱不如别人多）。（我不是说别人，我就是说“新世相”那个公众号）</p>
<p>所以Beatles改编的歌词还是很棒啊……至少感觉稍微更加温暖一些。</p>
<blockquote>
<p>Once there was a way,<br>
To get back homeward.<br>
Once there was a way<br>
To get back home.<br>
Sleep, pretty darling,<br>
Dot not cry<br>
And I will sing a lullaby.<br>
Golden slumbers,<br>
Fill your eyes<br>
Smiles await you when you rise<br>
Sleep pretty darling<br>
Do not cry<br>
And I will sing a lullaby.<br>
Once there was a way<br>
To get back homeward<br>
Once there was a way<br>
To get back home<br>
Sleep, pretty darling<br>
Do not cry<br>
And I will sing a lullaby.<br>
Once, there was a way to get back homeward<br>
Once, there was a way to get back home<br>
Sleep, pretty darling, do not cry<br>
And I will sing a lullaby<br>
Boy, you’re going to carry that weight,<br>
Carry that weight a long time<br>
Boy, you’re going to carry that weight<br>
Carry that weight a long time<br>
I never give you my pillow<br>
I only send you my invitations<br>
And in the middle of the celebrations<br>
I break, I break, I break down<br>
Boy, you’re going to carry that weight<br>
Carry that weight a long time<br>
Boy, you’re going to carry that weight<br>
Carry that weight a long time<br>
Once, there was a way to get back homeward<br>
Once, there was a way to get back home<br>
Sleep, pretty darling, do not cry<br>
And I will sing a lullaby</p>
</blockquote>
<h2 id="参考文献"><a class="markdownIt-Anchor" href="#参考文献"></a> 参考文献</h2>
<p><a id="bib1" href="#bib1ref"><sup>[1]</sup></a> Patient Grissel. <a href="https://en.wikipedia.org/wiki/Patient_Grissel" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Patient_Grissel</a><br>
<a id="bib2" href="#bib2ref"><sup>[2]</sup></a> O Sweet Content. <a href="https://www.youtube.com/watch?v=nyu1nTkqxiE" target="_blank" rel="noopener">https://www.youtube.com/watch?v=nyu1nTkqxiE</a><br>
<a id="bib3" href="#bib3ref"><sup>[3]</sup></a> Golden Slumbers / Carry That Weight / The End. <a href="https://www.youtube.com/watch?v=6qrDlRsARwk" target="_blank" rel="noopener">https://www.youtube.com/watch?v=6qrDlRsARwk</a></p>
<h2 id="脚注"><a class="markdownIt-Anchor" href="#脚注"></a> 脚注</h2>
<p><a id="note1" href="#note1ref"><sup>1</sup></a><em>thou</em>: i.e. the reader; the second and fourth lines are exclamations, not addresses.（“你”指的是读者；第二行和第四行是感叹，不是对读者说的话。）<br>
<a id="note2" href="#note2ref"><sup>2</sup></a><em>golden numbers</em>: ‘large sums of gold.’（很多金钱。）<br>
<a id="note3" href="#note3ref"><sup>3</sup></a><em>crisped</em>: lit. ‘curled,’ so ‘ruffled.’（卷曲而褶皱的。）</p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/GoldenTreasury/"><i class="fas fa-hashtag fa-fw"></i>GoldenTreasury</a>
                
                    <a href="/tags/戴镏龄/"><i class="fas fa-hashtag fa-fw"></i>戴镏龄</a>
                
                    <a href="/tags/T-Dekker/"><i class="fas fa-hashtag fa-fw"></i>T.Dekker</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/post/system-analysis-and-control-chapter-1-exercise/">
              
                  《系统分析与控制》第一章习题
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://zhanghuimeng.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            张慕晖
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2018-06-22
          </a>
        </div>
      
      
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="本章内容"><a class="markdownIt-Anchor" href="#本章内容"></a> 本章内容</h2>
<p>这一章的内容可以说是比较简单的。习题已经概括了绝大多数的概念，因此不再赘述了。</p>
<h2 id="习题"><a class="markdownIt-Anchor" href="#习题"></a> 习题</h2>
<h3 id="1"><a class="markdownIt-Anchor" href="#1"></a> 1</h3>
<p>什么是开环控制、闭环控制和复合控制？它们各有什么优缺点？</p>
<hr>
<p>若控制器与控制对象之间<strong>只有正向作用而没有反向联系</strong>，这样的控制过程称为开环控制。开环控制的优点是结构简单、成本低廉、工作稳定；缺点是控制精度不高。</p>
<p><img src="open-loop-control.png" alt="开环控制示意图"></p>
<p>若控制器与控制对象之间<strong>既有正向作用又有反向联系</strong>，这样的控制过程称为闭环控制。控制对象对控制器的反向作用通常称为反馈，因此闭环控制也称反馈控制。闭环控制的优点是系统响应对外扰和系统参数变化不敏感；缺点是易引起过调，“振荡”和“发散”。</p>
<p><img src="close-loop-control.png" alt="闭环控制示意图"></p>
<p>复合控制是将开环控制和闭环控制相结合的一种控制方式。它吸取了两者的长处，从而可达到较高的控制性能。</p>
<h3 id="2"><a class="markdownIt-Anchor" href="#2"></a> 2</h3>
<p>什么叫正反馈？什么叫负反馈？怎样判断反馈的极性？</p>
<hr>
<p>负反馈：在反馈控制中，误差的调节作用使得误差减小或消除。</p>
<p>正反馈：在反馈控制中，误差的调节作用使得误差进一步增加。</p>
<p>判断反馈极性的方法：在闭环系统的环路上任取一处a点断开，如下图所示。在断开处a加一小的扰动输入，然后检测或分析在断点的另一端a’所产生的输出信号，如果a’的信号与a点的信号极性相反，则说明原来的连接为负反馈，反之则为正反馈。</p>
<p><img src="feedback-polarity.jpg" alt></p>
<h3 id="3"><a class="markdownIt-Anchor" href="#3"></a> 3</h3>
<p>从功能分，闭环控制系统由哪些基本环节组成？它们各起什么作用？</p>
<hr>
<ul>
<li>给定装置：用来产生参考输入</li>
<li>比较装置：将参考输入与反馈信号进行比较</li>
<li>校正装置：用来改善闭环系统的稳定性和其他性能</li>
<li>放大装置：信号放大及变换</li>
<li>执行装置：具体产生控制作用的装置</li>
<li>控制对象：实际被控过程</li>
<li>量测装置：量测输出量，产生所需要的反馈量</li>
</ul>
<p><img src="close-loop-parts.jpg" alt></p>
<h3 id="4"><a class="markdownIt-Anchor" href="#4"></a> 4</h3>
<p>什么叫调节系统？什么叫跟踪系统？分别举例予以说明。</p>
<hr>
<p>调节系统：参考输入为定值或很少变化，性能要求主要是抗干扰。例：温度控制系统，压力控制系统。</p>
<p>跟踪系统：参考输入随时间变化，要求输出量紧紧跟随输入量的变化而变化，同时也要求具有抗干扰性能；又称跟踪系统、随动系统或伺服系统。例：雷达天线跟踪目标的控制系统，弧焊机器人末端跟踪焊缝的控制系统。</p>
<h3 id="5"><a class="markdownIt-Anchor" href="#5"></a> 5</h3>
<p>什么叫有静差？什么叫无静差？分别举例予以说明。</p>
<hr>
<p>无静差：系统进入稳态后，原理上输出量的稳态误差为零。</p>
<p>有静差：依靠反馈控制只能减小误差而不能完全消除误差。</p>
<h3 id="6"><a class="markdownIt-Anchor" href="#6"></a> 6</h3>
<p>下图为4个控制系统的原理图。</p>
<p><img src="06.jpg" alt="图1.18~1.21"></p>
<ol>
<li>指出系统的控制对象、被控制量、给定量及主要的干扰。</li>
<li>画出系统的原理结构图，并指出各个组成元件的基本职能。</li>
<li>说明如何改变系统的给定量输入。</li>
<li>判断对于给定量输入及主要的干扰是否有静差。</li>
</ol>
<h3 id="7"><a class="markdownIt-Anchor" href="#7"></a> 7</h3>
<p>下图是一个测量电阻值的平衡电桥，其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mn>1</mn></msub><mo>=</mo><msub><mi>R</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">R_1 = R_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为已知标准电阻，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span>是可变电阻，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">R_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>是待测电阻。电桥的平衡条件是：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mn>1</mn></msub><mo>:</mo><msub><mi>R</mi><mn>2</mn></msub><mo>=</mo><mi>R</mi><mo>:</mo><msub><mi>R</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">R_1 : R_2 = R : R_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，这时A、B两点的电位差为0。当电桥不平衡时，检流计G的光点便不指零，这时需改变可调电阻R的滑臂的位置，当G重新指零时表示<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi><mo>=</mo><msub><mi>R</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">R = R_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，于是可以从标尺A上读出<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">R_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的电阻值。</p>
<p>现要求将该电桥设计成一个自动平衡电桥，它能根据<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>R</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">R_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的阻值自动地改变<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span>的滑臂的位置，从而达到自动测量电阻的目的。画出它的简化原理图和原理结构图。</p>
<p><img src="07.jpg" alt></p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/SystemAnalysis-Control/"><i class="fas fa-hashtag fa-fw"></i>SystemAnalysis&amp;Control</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/post/like-as-the-waves-make-towards-the-pebbled-shore-by-w-shakespeare/">
              
                  《英诗金库》I-30：Like as the waves make towards the pebbled shore, by W. Shakespeare
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://zhanghuimeng.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            张慕晖
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2018-05-31
          </a>
        </div>
      
      
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="作品基本信息"><a class="markdownIt-Anchor" href="#作品基本信息"></a> 作品基本信息</h2>
<p>作品名称：Revolutions（循环）<br>
作者：William Shakespeare（威廉·莎士比亚）<br>
出版年代：1609<br>
编注：此诗系莎氏十四行诗第六〇首。</p>
<h2 id="作品原文"><a class="markdownIt-Anchor" href="#作品原文"></a> 作品原文</h2>
<p>Like as the waves make towards the pebbled shore,<br>
So do our minutes hasten to their end;<br>
Each changing place with that which goes before,<br>
In sequent<a href="#note1" id="note1ref"><sup>1</sup></a> toil all forwars do contend.</p>
<p>Nativity, once in the main of light,<br>
Crawls to maturity, wherewith being crown’d,<br>
Crooked eclipses 'gainst his glory fight,<br>
And Time that gave doth now his gift confound.</p>
<p>Time doth transfix the flourish<a href="#note2" id="note2ref"><sup>2</sup></a> set on youth,<br>
And delves the parellels in beauty’s brow;<br>
Feeds on the rarities of nature’s truth,<br>
And nothing stands but for his scythe to mow:</p>
<p>And yet, to times in hope<a href="#note3" id="note3ref"><sup>3</sup></a>, my verse shall stand<br>
Praising thy worth, despite his cruel hand.</p>
<h2 id="译文"><a class="markdownIt-Anchor" href="#译文"></a> 译文</h2>
<h3 id="梁宗岱-译"><a class="markdownIt-Anchor" href="#梁宗岱-译"></a> 梁宗岱 译</h3>
<p>象波浪滔滔不息地滚向沙滩：<br>
我们的光阴息息奔赴着终点；<br>
后浪和前浪不断地循环替换，<br>
前推后拥，一个个在奋勇争先。</p>
<p>生辰，一度涌现于光明的金海，<br>
爬行到壮年，然后，既登上极顶，<br>
凶冥的日蚀便遮没它的光彩，<br>
时光又撕毁了它从前的赠品。</p>
<p>时光戳破了青春颊上的光艳，<br>
在美的前额挖下深陷的战壕，<br>
自然的至珍都被它肆意狂啖，<br>
一切挺立的都难逃它的镰刀：</p>
<p>可是我的诗未来将屹立千古，<br>
歌颂你的美德，不管它多残酷！</p>
<h2 id="我的感想"><a class="markdownIt-Anchor" href="#我的感想"></a> 我的感想</h2>
<p>这又是莎士比亚的常见题材了。人生匆匆流逝，一切美好的事物都会被带走，所以不知道人生的意义在何处。但是歌颂美好事物的诗是永存的。这句话听起来很像陈词滥调，但我现在觉得莎士比亚可能真是这么想的了。</p>
<h2 id="参考文献"><a class="markdownIt-Anchor" href="#参考文献"></a> 参考文献</h2>
<h2 id="脚注"><a class="markdownIt-Anchor" href="#脚注"></a> 脚注</h2>
<p><a id="note1" href="#note1ref"><sup>1</sup></a><em>sequent</em>: ‘following one another.’ （接连发生的。）<br>
<a id="note2" href="#note2ref"><sup>2</sup></a><em>transfix the flourish</em>: ‘pierce through the gloss.’（戳穿了光彩。）<br>
<a id="note3" href="#note3ref"><sup>3</sup></a><em>times in hope</em>: ‘ages yet to come.’（尚未来临的日子。）</p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/GoldenTreasury/"><i class="fas fa-hashtag fa-fw"></i>GoldenTreasury</a>
                
                    <a href="/tags/W-Shakespeare/"><i class="fas fa-hashtag fa-fw"></i>W.Shakespeare</a>
                
                    <a href="/tags/Sonnet/"><i class="fas fa-hashtag fa-fw"></i>Sonnet</a>
                
                    <a href="/tags/梁宗岱/"><i class="fas fa-hashtag fa-fw"></i>梁宗岱</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/post/farewell-thou-art-too-dear-for-my-possessing-by-w-shakespeare/">
              
                  《英诗金库》I-31：Farewell! thou art too dear for my possessing, by W. Shakespeare
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://zhanghuimeng.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            张慕晖
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2018-05-31
          </a>
        </div>
      
      
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="作品基本信息"><a class="markdownIt-Anchor" href="#作品基本信息"></a> 作品基本信息</h2>
<p>作品名称：Farewell! thou art too dear for my possessing<br>
作者：William Shakespeare（威廉·莎士比亚）<br>
出版年代：1609<br>
编注：此诗系莎氏十四行诗第八七首。译者原有这样的译解：“诗人向爱友告别，并且撤销了他们以前因错误而订的盟约，但诗人似乎仍希望能从这种完全的解约而引起爱友的回心转意。”</p>
<h2 id="作品原文"><a class="markdownIt-Anchor" href="#作品原文"></a> 作品原文</h2>
<p>Farewell! thou art too dear for my possessing,<br>
And like enough thou know’st thy estimate:<br>
The charter<a href="#note1" id="note1ref"><sup>1</sup></a> of thy worth gives thee releasing;<br>
My bonds in thee are all determinate.</p>
<p>For how do I hold thee but thy granting?<br>
And for that riches where is my deserving?<br>
The cause of this fair gift in me is wanting,<br>
And so my patent<a href="#note2" id="note2ref"><sup>2</sup></a> back again is swerving.</p>
<p>Thyself thou gav’st, thy own worth then not knowing,<br>
Or me, to whom thou gav’st it, else mistaking;<br>
So thy great gift, upon misprision growing<a href="#note3" id="note3ref"><sup>3</sup></a>,<br>
Comes home again, on better judgement making.</p>
<p>Thus have I had thee as a dream doth flatter;<br>
In sleep, a king; but waking, no such matter.</p>
<h2 id="译文"><a class="markdownIt-Anchor" href="#译文"></a> 译文</h2>
<h3 id="屠岸-译"><a class="markdownIt-Anchor" href="#屠岸-译"></a> 屠岸 译</h3>
<p>再会！你太贵重了，我没法保有你，<br>
你也多半明白你自己的价值：<br>
你的才德给予你自由的权利；<br>
我跟你订的盟约就到此为止。</p>
<p>你不答应，我怎能把你占有？<br>
对于这样的福气，我哪儿相配？<br>
我没有接受这美好礼物的理由，<br>
给我的特许证因而就掉头而归。</p>
<p>你当时不知道自己的身价有多大，<br>
或者是把我看错了，才给我深情；<br>
所以，你这份厚礼，送错了人家，<br>
终于回家了，算得是明智的决定。</p>
<p>我曾经有过你，象一场阿谀的迷梦，<br>
我在那梦里称了王，醒来一场空。</p>
<h2 id="我的感想"><a class="markdownIt-Anchor" href="#我的感想"></a> 我的感想</h2>
<p>真的好惨。就现代的想法来看，那就是恋爱双方中一方前进得太快了，另一方跟不上；或者说，一方本来是年轻貌美，善解人意的，另一方配不上，却因为种种原因还是在一起了。不相配的人是不可能长久下去的。当然，这样也实在是太自卑了。</p>
<p>当然曾经也是很感动的。把这么优秀的自己送给了我，真是一份重礼啊。总之这首诗苦乐参半，其实也没有想象中那么惨。</p>
<p>最后两句写得很顺耳，节奏很棒。</p>
<p>刚才阅读了一些其他的解读。不过恕我直言，这里的爱人恐怕还是那位可爱的年轻男性。</p>
<p>TODO（我以前写的都是什么破烂解析？）</p>
<h2 id="参考文献"><a class="markdownIt-Anchor" href="#参考文献"></a> 参考文献</h2>
<h2 id="脚注"><a class="markdownIt-Anchor" href="#脚注"></a> 脚注</h2>
<p><a id="note1" href="#note1ref"><sup>1</sup></a><em>charter</em>: properly a written grant of rights by the Sovereign; here his lady’s worth had given her such rights. （实际上是统治者对权利作出的书面保证；此处，这位夫人的价值给了她这样的权力。其实我也没看懂这个注解。）<br>
<a id="note2" href="#note2ref"><sup>2</sup></a><em>patent</em>: a right similarly granted to the exclusive enjoyment of some privilege.<br>
<a id="note3" href="#note3ref"><sup>3</sup></a><em>upon misprision growing</em>: ‘being based upon a misconception of your own value.’ The word is derived from the verb to misprize, and must not be confounded with the legal term misprision (akin to the French méprendre), meaning a wrongful act or omission.</p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/GoldenTreasury/"><i class="fas fa-hashtag fa-fw"></i>GoldenTreasury</a>
                
                    <a href="/tags/W-Shakespeare/"><i class="fas fa-hashtag fa-fw"></i>W.Shakespeare</a>
                
                    <a href="/tags/屠岸/"><i class="fas fa-hashtag fa-fw"></i>屠岸</a>
                
                    <a href="/tags/Sonnet/"><i class="fas fa-hashtag fa-fw"></i>Sonnet</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/post/wir-sind-helden-song-translation-1-guten-tag-die-konkurrenz/">
              
                  Wir Sind Helden歌词翻译（1）：Guten Tag &amp; Die Konkurrenz
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://zhanghuimeng.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            张慕晖
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2018-05-26
          </a>
        </div>
      
      
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <p>好不容易熬过了操作系统期末考试（虽然考得真的很糟，因为忙于维护博客而忽略了一些重要的知识点，比如RAID之类的，不过毕竟这是自己选择的结果，也没有啥好说的），决定干点轻松愉快的事情——翻译德语歌词！</p>
<p><a href="https://en.wikipedia.org/wiki/Wir_sind_Helden" target="_blank" rel="noopener">Wir Sind Helden</a>是一支我相当喜欢的德国乐队。他们已经在2012年宣布无限期停止活动了，但是这并不影响我继续听他们的歌。他们的<a href="https://en.wikipedia.org/wiki/Judith_Holofernes" target="_blank" rel="noopener">主唱</a>声音很萌（特别像小姑娘，好萌……），歌曲风格轻快活泼，歌词内容经常令人莫名其妙，和曲风形成了鲜明的对比。</p>
<p>我的德语水平并不怎么样，所以这些歌词都是对着德语原文和英语翻译转译过来的。虽然我希望自己未来还能有时间好好学习德语，但我觉得制约我的翻译的瓶颈实际上是中文水平。</p>
<h2 id="die-konkurrenz"><a class="markdownIt-Anchor" href="#die-konkurrenz"></a> Die Konkurrenz</h2>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=19824455&auto=1&height=66"></iframe>
<p>这首歌的歌词是2017年3月翻译的，稍微有点久远了。谷歌了一下，当时似乎参考了<a href="http://lyrics.wikia.com/wiki/Wir_Sind_Helden:Die_Konkurrenz/en" target="_blank" rel="noopener">Wir Sind Helden:Die Konkurrenz/en Lyrics</a>的歌词和翻译。</p>
<table>
<thead>
<tr>
<th>歌词</th>
<th>翻译</th>
</tr>
</thead>
<tbody>
<tr>
<td>Du fährst dein Rad am Straßenrand</td>
<td>你在大马路上骑着自行车</td>
</tr>
<tr>
<td>begehrst nicht andrer Weib noch Land</td>
<td>你既不要别人的女人也不要土地</td>
</tr>
<tr>
<td>Begehren ist dir einerlei</td>
<td>欲望对你来说毫无意义</td>
</tr>
<tr>
<td>Du pfeifst und singst und fühlst dich frei</td>
<td>你吹着口哨唱着歌，感到无比自由</td>
</tr>
<tr>
<td>Du pfeifst und singst und fühlst dich frei</td>
<td>你吹着口哨唱着歌，感到无比自由</td>
</tr>
<tr>
<td>da zieht wer links an dir vorbei!</td>
<td>突然有人从左边超了你的车</td>
</tr>
<tr>
<td>Vorbeiziehen ist mir einerlei</td>
<td>“我才不在乎是不是被人超车！”</td>
</tr>
<tr>
<td>sagst du und wirst ganz blass dabei</td>
<td>你这样说的时候脸色却变白了</td>
</tr>
<tr>
<td>Die Konkurrenz schläft nicht (×4)</td>
<td>竞争永不息！(×4)</td>
</tr>
<tr>
<td>Sag’s mir, Hippiekind!</td>
<td>告诉我，嬉皮小孩</td>
</tr>
<tr>
<td>Jetzt stehst du auf dem Dach der Welt</td>
<td>现在你正站在世界之巅</td>
</tr>
<tr>
<td>Die Welt hält still und dir gefällt sie</td>
<td>你喜欢这世界停滞不前</td>
</tr>
<tr>
<td>Du atmest tief und fühlst dich hier</td>
<td>你深吸一口气，感觉在此处</td>
</tr>
<tr>
<td>Du fühlst dich eins mit Welt und dir</td>
<td>你自己和世界合为一体</td>
</tr>
<tr>
<td>Du fühlst dich eins mit Welt und hier</td>
<td>你感到和此处的世界合为一体</td>
</tr>
<tr>
<td>Steht plötzlich einer neben dir!</td>
<td>突然有人站到了你旁边</td>
</tr>
<tr>
<td>Bist eins mit dir und mit der Welt</td>
<td>你本来认为你和世界合为一体</td>
</tr>
<tr>
<td>Bis einer sich für einser hält</td>
<td>直到有人硬塞到你们中间</td>
</tr>
<tr>
<td>Die Konkurrenz schläft nicht (×4)</td>
<td>竞争永不息！(×4)</td>
</tr>
<tr>
<td>Sag’s mir, kleiner Punk!</td>
<td>告诉我，小朋克</td>
</tr>
<tr>
<td>Da zieht wer links an dir vorbei</td>
<td>有人从左边超了你的车</td>
</tr>
<tr>
<td>Sag, was macht das mit dir?</td>
<td>（告诉我，你感觉怎么样？）</td>
</tr>
<tr>
<td>Dem ist dein Pfeifen einerlei</td>
<td>没人真在乎你吹的口哨</td>
</tr>
<tr>
<td>Sag was macht das mit dir?</td>
<td>（告诉我，你感觉怎么样？）</td>
</tr>
<tr>
<td>Da steht ein andrer neben dir und fühlt sich eins</td>
<td>有人站到了你旁边，他感到和世界合为一体</td>
</tr>
<tr>
<td>Mit dem was deins war</td>
<td>可世界曾是我的</td>
</tr>
<tr>
<td>Nicht seins</td>
<td>不是他的</td>
</tr>
<tr>
<td>Sag, was macht die Konkurrenz?</td>
<td>告诉我，竞争都做了些什么</td>
</tr>
<tr>
<td>Du tust die Arbeit Hand in Hand</td>
<td>你们手拉手地干着活</td>
</tr>
<tr>
<td>Seit’ an Seite bestellst das Land</td>
<td>你们肩并肩地犁着地</td>
</tr>
<tr>
<td>Am Morgen geht’s einig und früh aus der Falle</td>
<td>你们早晨起床起得又快又早</td>
</tr>
<tr>
<td>Und ihr singt: Alle für einen! Einer für Alle</td>
<td>你们唱道：“人人为我，我为人人！”</td>
</tr>
<tr>
<td>Ihr singt: Alle für einen! Einer für Alle</td>
<td>你们唱道：“人人为我，我为人人！”</td>
</tr>
<tr>
<td>und dann kommt einer und macht alle Anderen alle</td>
<td>然后有人夺去所有收获，其他人空手而归</td>
</tr>
<tr>
<td>Am morgen geht’s eilig und früh aus der Falle</td>
<td>你早晨起床起得又快又早</td>
</tr>
<tr>
<td>Und du singst: jetzt bin ich der eine und ihr Anderen seid Alle</td>
<td>你唱道：“人人为的是我，我却不必为人人！”</td>
</tr>
<tr>
<td>Die Konkurrenz, sie schläft nicht</td>
<td>竞争永不息！</td>
</tr>
<tr>
<td>Die Konkurrenz schläft nicht</td>
<td>竞争永不息！</td>
</tr>
<tr>
<td>Die Konkurrenz, sie schläft nicht</td>
<td>竞争它永不停息！</td>
</tr>
</tbody>
</table>
<p>说实话，我对这个翻译还挺满意的，唯一觉得自己傻的一点是，在网易云音乐里上传的版本里，把那些德语歌词中没有体现出来的语气词也给照样翻译出来了，这确实有点尴尬。</p>
<p>一年过去了，现在看到歌词里的“人人为我，我为人人！”，以及“从左边”超车，总觉得有点什么政治隐喻在里面。</p>
<h2 id="guten-tag"><a class="markdownIt-Anchor" href="#guten-tag"></a> Guten Tag</h2>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=19824269&auto=1&height=66"></iframe>
<p>下面这个歌词只是预览版，还没有最后上传，还需要一些修改。</p>
<table>
<thead>
<tr>
<th>歌词</th>
<th>翻译</th>
</tr>
</thead>
<tbody>
<tr>
<td>Meine Stimme gegen Dein Mobiltelefon</td>
<td>用我的声音换你们的移动电话</td>
</tr>
<tr>
<td>Meine Fäuste gegen Eure Nagelpflegelotion</td>
<td>用我的拳头换你们的美甲乳液</td>
</tr>
<tr>
<td>Meine Zähne gegen die von Doktor Best und seinem Sohn</td>
<td>用我的牙齿换贝斯特博士的牙齿护理产品</td>
</tr>
<tr>
<td>Meine Seele gegen Eure sanfte Epilation</td>
<td>用我的灵魂换你们的无痛脱毛药水</td>
</tr>
<tr>
<td>Es war im Ausverkauf im Angebot die Sonderaktion</td>
<td>当时所有的产品都在促销</td>
</tr>
<tr>
<td>Tausche blödes altes Leben gegen neue Version</td>
<td>我把愚蠢的旧生活升级成了新版本</td>
</tr>
<tr>
<td>Ich hatte es kaum zu Hause ausprobiert da wusste ich schon</td>
<td>结果在家试了几种东西之后我就发现</td>
</tr>
<tr>
<td>an dem Produkt ist was kaputt - das ist die Reklamation</td>
<td>你们的产品全都是坏的！我要投诉！</td>
</tr>
<tr>
<td>Ich will</td>
<td>我想</td>
</tr>
<tr>
<td>Ich tausch nicht mehr ich will mein Leben zurück (×3)</td>
<td>我不要再交换了！我要回到原来的生活！</td>
</tr>
<tr>
<td>Guten Tag, ich will mein Leben zurück</td>
<td>你好，我要回到原来的生活！</td>
</tr>
<tr>
<td>(Ich tausch nicht mehr)Guten Tag, guten Tag, ich will mein Leben zurück</td>
<td>你好，你好，我要回到原来的生活！</td>
</tr>
<tr>
<td>(Ich tausch nicht mehr)Guten Tag, guten Tag, ich will mein Leben zurück</td>
<td>你好，你好，我要回到原来的生活！</td>
</tr>
<tr>
<td>Guten Tag ich gebe zu ich war am Anfang entzückt</td>
<td>你好，我承认我开始时被吸引了</td>
</tr>
<tr>
<td>aber euer Leben zwickt und drückt nur dann nicht wenn man sich bückt -</td>
<td>可这种扭曲的生活不断逼迫着我屈服于它！</td>
</tr>
<tr>
<td>Guten Tag</td>
<td>你好</td>
</tr>
<tr>
<td>Meine Stimme gegen die der ganzen Talkshownation</td>
<td>用我的声音换整个国家的脱口秀</td>
</tr>
<tr>
<td>Meine Fäuste für ein müdes Halleluja und Bohnen</td>
<td>用我的拳头换疲惫的哈利路亚与豆子</td>
</tr>
<tr>
<td>Meine Zähne gegen Eure zahme Revolution</td>
<td>用我的牙齿换你们的“驯服革命”</td>
</tr>
<tr>
<td>Visionen gegen die totale Television</td>
<td>用我的眼睛换一台电视机</td>
</tr>
<tr>
<td>Es war im Ausverkauf im Angebot die Sonderaktion</td>
<td>当时所有的产品都在促销</td>
</tr>
<tr>
<td>Tausche blödes altes Leben gegen neue Version</td>
<td>我把愚蠢的旧生活升级成了新版本</td>
</tr>
<tr>
<td>Ich hatte es kaum zu Hause ausprobiert da wusste ich schon</td>
<td>结果在家试了几种东西之后我就发现</td>
</tr>
<tr>
<td>an dem Produkt ist was kaputt - das ist die Reklamation</td>
<td>你们的产品全都是坏的！我要投诉！</td>
</tr>
<tr>
<td>Ich will</td>
<td>我想</td>
</tr>
<tr>
<td>Ich tausch nicht mehr ich will mein Leben zurück (×3)</td>
<td>我不要再交换了！我要回到原来的生活！</td>
</tr>
<tr>
<td>Guten Tag, ich will mein Leben zurück</td>
<td>你好，我要回到原来的生活！</td>
</tr>
<tr>
<td>(Ich tausch nicht mehr)Guten Tag, guten Tag, ich will mein Leben zurück</td>
<td>你好，你好，我要回到原来的生活！</td>
</tr>
<tr>
<td>(Ich tausch nicht mehr)Guten Tag, guten Tag, ich will mein Leben zurück</td>
<td>你好，你好，我要回到原来的生活！</td>
</tr>
<tr>
<td>Guten Tag ich gebe zu ich war am Anfang entzückt</td>
<td>你好，我承认我开始时被吸引了</td>
</tr>
<tr>
<td>aber euer Leben zwickt und drückt nur dann nicht wenn man sich bückt -</td>
<td>可这种扭曲的生活不断逼迫着我屈服于它！</td>
</tr>
<tr>
<td>Guten Tag</td>
<td>你好</td>
</tr>
<tr>
<td>Mobiltelefon</td>
<td>移动电话</td>
</tr>
<tr>
<td>Von Doktor Best und seinem Sohn</td>
<td>贝斯特博士的牙齿护理套装</td>
</tr>
<tr>
<td>Sonderaktion</td>
<td>促销</td>
</tr>
<tr>
<td>Das ist die Reklamation</td>
<td>这是投诉！</td>
</tr>
<tr>
<td>Der ganzen Talkshownation</td>
<td>充满脱口秀的国家</td>
</tr>
<tr>
<td>Revolution</td>
<td>革命</td>
</tr>
<tr>
<td>Visionen gegen die totale Television</td>
<td>用眼睛换一台电视机</td>
</tr>
<tr>
<td>Es war im Ausverkauf im Angebot die Sonderaktion</td>
<td>当时所有的产品都在促销</td>
</tr>
<tr>
<td>Tausche blödes altes Leben gegen neue Version</td>
<td>我把愚蠢的旧生活升级成了新版本</td>
</tr>
<tr>
<td>Ich hatte es kaum zu Hause ausprobiert da wusste ich schon</td>
<td>结果在家试了几种东西之后我就发现</td>
</tr>
<tr>
<td>an dem Produkt ist was kaputt - das ist die Reklamation</td>
<td>你们的产品全都是坏的！我要投诉！</td>
</tr>
<tr>
<td>Ich will</td>
<td>我想</td>
</tr>
<tr>
<td>Ich tausch nicht mehr ich will mein Leben zurück (×7)</td>
<td>我不要再交换了！我要回到原来的生活！</td>
</tr>
<tr>
<td>Guten Tag, ich will mein Leben zurück</td>
<td>你好，我要回到原来的生活！</td>
</tr>
<tr>
<td>(Ich tausch nicht mehr)Guten Tag, guten Tag, ich will mein Leben zurück</td>
<td>你好，你好，我要回到原来的生活！</td>
</tr>
<tr>
<td>(Ich tausch nicht mehr)Guten Tag, guten Tag, ich will mein Leben zurück</td>
<td>你好，你好，我要回到原来的生活！</td>
</tr>
<tr>
<td>Guten Tag ich gebe zu ich war am Anfang entzückt</td>
<td>你好，我承认我开始时被吸引了</td>
</tr>
<tr>
<td>aber euer Leben zwickt und drückt nur dann nicht wenn man sich bückt -</td>
<td>可这种扭曲的生活不断逼迫着我屈服于它！</td>
</tr>
<tr>
<td>Guten Tag (×4)</td>
<td>你好</td>
</tr>
<tr>
<td>Guten</td>
<td>你</td>
</tr>
<tr>
<td>Tag</td>
<td>好</td>
</tr>
</tbody>
</table>
<p>一些说明：</p>
<ol>
<li><a href="https://de.wikipedia.org/wiki/Dr._Best" target="_blank" rel="noopener">Doktor Best und seinem Sohn</a>似乎是德国一个有名的牙齿护理产品，现在下属于葛兰素史克。于是我翻译成“贝斯特博士”了。</li>
<li>我也不太清楚“Halleluja und Bohnen”到底应该是什么意思。可能和<a href="https://de.wikipedia.org/wiki/Blaue_Bohnen_f%C3%BCr_ein_Halleluja" target="_blank" rel="noopener">这部电影</a>有关。</li>
<li><a href="https://www.amazon.com/Die-zahme-Revolution-davon-German/dp/3800036797" target="_blank" rel="noopener">zahme Revolution</a>是一本书，作者是<a href="https://de.wikipedia.org/wiki/Paulus_Ebner" target="_blank" rel="noopener">Paulus Ebner</a>，但我不太明白这本书说的是什么，以及在这里引用它的意义……</li>
</ol>
<p>总的来说，这首歌的语气好像一个人在给某家“公司”打电话投诉，声称现代消费主义带来的生活虽然开始时令人眼花缭乱，但实质上是令人痛苦而迷茫的，因此他要求退货，换回到原来的旧生活。想到这首歌是2003年发布的，不由得有种恍如隔世之感。</p>
<p>可是，还是回不去了啊。</p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Translation/"><i class="fas fa-hashtag fa-fw"></i>Translation</a>
                
                    <a href="/tags/Lyric/"><i class="fas fa-hashtag fa-fw"></i>Lyric</a>
                
                    <a href="/tags/artist-Wir-Sind-Helden/"><i class="fas fa-hashtag fa-fw"></i>artist:Wir Sind Helden</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/post/os-mooc-lecture-14-summary/">
              
                  《操作系统》第14讲：“实验5-用户线程管理”总结
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://zhanghuimeng.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            张慕晖
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2018-05-25
          </a>
        </div>
      
      
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="课程内容概述"><a class="markdownIt-Anchor" href="#课程内容概述"></a> 课程内容概述</h2>
<p>TODO</p>
<h2 id="练习"><a class="markdownIt-Anchor" href="#练习"></a> 练习</h2>
<p>来自<a href="https://github.com/chyyuu/os_course_exercises/blob/2018spring/all/05-4-lab5-quiz.md" target="_blank" rel="noopener">lab5 用户进程 在线练习</a>和<a href="https://github.com/chyyuu/os_course_exercises/blob/2018spring/all/05-4-lab5-spoc-discussion.md" target="_blank" rel="noopener">lab5 spoc 思考题</a>。</p>
<h3 id="选择填空题"><a class="markdownIt-Anchor" href="#选择填空题"></a> 选择填空题</h3>
<p><strong>下列叙述中正确的是()</strong></p>
<ul>
<li>lab5建立了用户进程，且0~3GB都是用户可访问空间，用户进程可进行正常读写</li>
<li>lab5建立了用户进程，且3GB~4GB都是内核可访问空间，内核可进行正常读写</li>
<li><strong>lab5中的第一个用户进程是内核创建的。</strong></li>
<li><strong>lab5中的用户进程可通过fork创建新的用户进程。</strong></li>
</ul>
<p>lab5中建立了用户进程这一点没啥问题。用户和内核可访问的空间这点有问题。简单来说，内核虚拟内存空间处于0xC0000000<sub>0xF8000000位置（KERNBASE</sub>KERNTOP），用户进程可访问的虚拟内存空间位于0x0080000<sub>-0xB0000000位置（UTEXT</sub>USERTOP）。</p>
<blockquote>
<p>这样ucore把用户进程的虚拟地址空间分了两块，一块与内核线程一样，是所有用户进程都共享的内核虚拟地址空间，映射到同样的物理内存空间中，这样在物理内存中只需放置一份内核代码，使得用户进程从用户态进入核心态时，内核代码可以统一应对不同的内核程序；另外一块是用户虚拟地址空间，虽然虚拟地址范围一样，但映射到不同且没有交集的物理内存空间中。这样当ucore把用户进程的执行代码（ 即应用程序的执行代码） 和数据（ 即应用程序的全局变量等） 放到用户虚拟地址空间中时，确保了各个进程不会“非法”访问到其他进程的物理内存空间。</p>
</blockquote>
<hr>
<p><strong>lab5通过<code>do_execve</code>函数执行新的程序，为此需要完成（）</strong></p>
<ul>
<li><strong>更新用户进程的context</strong></li>
<li><strong>更新用户进程的代码内容</strong></li>
<li><strong>更新用户进程的数据内容</strong></li>
<li><strong>更新用户进程的页表基址</strong></li>
</ul>
<p>Lab5中的<code>do_execve</code>函数的主要功能就是，放弃当前程序的一切内存空间等资源，将新的程序填充到自己里面。所以显然上述内容都要更新。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// do_execve - call exit_mmap(mm)&amp;put_pgdir(mm) to reclaim memory space of current process</span><br><span class="line">//           - call load_icode to setup new memory space accroding binary prog.</span><br><span class="line">int</span><br><span class="line">do_execve(const char *name, size_t len, unsigned char *binary, size_t size) &#123;</span><br><span class="line">    struct mm_struct *mm = current-&gt;mm;</span><br><span class="line">    if (!user_mem_check(mm, (uintptr_t)name, len, 0)) &#123;</span><br><span class="line">        return -E_INVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    if (len &gt; PROC_NAME_LEN) &#123;</span><br><span class="line">        len = PROC_NAME_LEN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    char local_name[PROC_NAME_LEN + 1];</span><br><span class="line">    memset(local_name, 0, sizeof(local_name));</span><br><span class="line">    memcpy(local_name, name, len);</span><br><span class="line"></span><br><span class="line">    if (mm != NULL) &#123;</span><br><span class="line">        lcr3(boot_cr3);</span><br><span class="line">        if (mm_count_dec(mm) == 0) &#123;</span><br><span class="line">            exit_mmap(mm);</span><br><span class="line">            put_pgdir(mm);</span><br><span class="line">            mm_destroy(mm);</span><br><span class="line">        &#125;</span><br><span class="line">        current-&gt;mm = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    int ret;</span><br><span class="line">    if ((ret = load_icode(binary, size)) != 0) &#123;</span><br><span class="line">        goto execve_exit;</span><br><span class="line">    &#125;</span><br><span class="line">    set_proc_name(current, local_name);</span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">execve_exit:</span><br><span class="line">    do_exit(ret);</span><br><span class="line">    panic(&quot;already exit: %e.\n&quot;, ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ucore docs中指出，此函数的主要工作流程如下：</p>
<blockquote>
<p>首先为加载新的执行码做好用户态内存空间清空准备。如果mm不为NULL，则设置页表为内核空间页表，且进一步判断mm的引用计数减1后是否为0，如果为0，则表明没有进程再需要此进程所占用的内存空间，为此将根据mm中的记录，释放进程所占用户空间内存和进程页表本身所占空间。最后把当前进程的mm内存管理指针为空。由于此处的initproc是内核线程，所以mm为NULL，整个处理都不会做。<br>
接下来的一步是加载应用程序执行码到当前进程的新创建的用户态虚拟空间中。这里涉及到读ELF格式的文件，申请内存空间，建立用户态虚存空间，加载应用程序执行码等。load_icode函数完成了整个复杂的工作。</p>
</blockquote>
<hr>
<p><strong>lab5通过<code>do_icode</code>函数执行新的程序，为此需要完成（）</strong></p>
<ul>
<li><strong>设置用户堆栈</strong></li>
<li><strong>修改页表</strong></li>
<li><strong>根据ELF执行文件的格式描述分配内存并填写内容</strong></li>
<li><strong>设置用户态的EFLAG寄存器不可屏蔽中断</strong></li>
</ul>
<p>ucore docs中给出的函数工作流程：</p>
<blockquote>
<ol>
<li>调用mm_create函数来申请进程的内存管理数据结构mm所需内存空间，并对mm进行初始化；</li>
</ol>
</blockquote>
<ol start="2">
<li>调用setup_pgdir来申请一个页目录表所需的一个页大小的内存空间，并把描述ucore内核虚空间映射的内核页表（ boot_pgdir所指） 的内容拷贝到此新目录表中，最后让mm-&gt;pgdir指向此页目录表，这就是进程新的页目录表了，且能够正确映射内核虚空间；</li>
<li>根据应用程序执行码的起始位置来解析此ELF格式的执行程序，并调用mm_map函数根据ELF格式的执行程序说明的各个段（代码段、数据段、BSS段等） 的起始位置和大小建立对应的vma结构，并把vma插入到mm结构中，从而表明了用户进程的合法用户态虚拟地址空间；</li>
<li>调用根据执行程序各个段的大小分配物理内存空间，并根据执行程序各个段的起始位置确定虚拟地址，并在页表中建立好物理地址和虚拟地址的映射关系，然后把执行程序各个段的内容拷贝到相应的内核虚拟地址中，至此应用程序执行码和数据已经根据编译时设定地址放置到虚拟内存中了；</li>
<li>需要给用户进程设置用户栈，为此调用mm_mmap函数建立用户栈的vma结构，明确用户栈的位置在用户虚空间的顶端，大小为256个页，即1MB，并分配一定数量的物理内存且建立好栈的虚地址&lt;–&gt;物理地址映射关系；</li>
<li>至此,进程内的内存管理vma和mm数据结构已经建立完成，于是把mm-&gt;pgdir赋值到cr3寄存器中，即更新了用户进程的虚拟内存空间，此时的initproc已经被hello的代码和数据覆盖，成为了第一个用户进程，但此时这个用户进程的执行现场还没建立好；</li>
<li>先清空进程的中断帧，再重新设置进程的中断帧，使得在执行中断返回指令“iret”后，能够让CPU转到用户态特权级，并回到用户态内存空间，使用用户态的代码段、数据段和堆栈，且能够跳转到用户进程的第一条指令执行，并确保在用户态能够响应中断；</li>
</ol>
<p>其中设置中断帧这一步是Lab5的练习1。</p>
<hr>
<p><strong>关于进程管理的COW(Copy On Write)机制叙述正确的是（）</strong></p>
<ul>
<li>父进程创建子进程需要复制父进程的内存空间</li>
<li>父进程创建子进程需要给子进程分配内核堆栈</li>
<li>父进程创建子进程需要给子进程分配用户堆栈</li>
<li><strong>父进程创建子进程需要创建子进程的页表,但不复制父进程内存空间</strong></li>
</ul>
<p>总之不需要复制也不需要分配，只是创建一个新的页表，然后和父进程页表指向相同位置。需要进行写时就新创建一页。</p>
<h3 id="简答题"><a class="markdownIt-Anchor" href="#简答题"></a> 简答题</h3>
<p><strong>第一个用户进程创建有什么特殊的？</strong></p>
<blockquote>
<p>用户态代码段的初始化</p>
</blockquote>
<p>好吧，答案是这么说的，但是我并不认同……总之，本实验中第一个用户进程是由第二个内核线程initproc通过把hello应用程序执行<br>
码覆盖到initproc的用户虚拟内存空间来创建的。具体的大概方法是调用<code>kernel_execve()</code>函数，触发<code>SYS_exec</code>系统中断，然后继续调用<code>do_execve()</code>和<code>load_icode()</code>函数完成这一过程。其他用户进程是用户进程通过<code>SYS_fork</code>系统调用创建的（大概）。</p>
<hr>
<p><strong>系统调用的参数传递过程？</strong></p>
<p>参见：用户态函数syscall()中的汇编代码。下面的代码摘自<code>user/libs/syscall.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span></span><br><span class="line">syscall(<span class="keyword">int</span> num, ...) &#123;</span><br><span class="line">    va_list ap;</span><br><span class="line">    va_start(ap, num);</span><br><span class="line">    <span class="keyword">uint32_t</span> a[MAX_ARGS];</span><br><span class="line">    <span class="keyword">int</span> i, ret;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_ARGS; i ++) &#123;</span><br><span class="line">        a[i] = va_arg(ap, <span class="keyword">uint32_t</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    va_end(ap);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">"int %1;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">        : <span class="string">"=a"</span> (ret)</span></span></span><br><span class="line"><span class="function"><span class="params">        : <span class="string">"i"</span> (T_SYSCALL),</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="string">"a"</span> (num),</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="string">"d"</span> (a[<span class="number">0</span>]),</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="string">"c"</span> (a[<span class="number">1</span>]),</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="string">"b"</span> (a[<span class="number">2</span>]),</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="string">"D"</span> (a[<span class="number">3</span>]),</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="string">"S"</span> (a[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"><span class="params">        : <span class="string">"cc"</span>, <span class="string">"memory"</span>)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很显然，参数是这样传递的：</p>
<ul>
<li>触发INT 0x80中断（T_SYSCALL）</li>
<li>eax中存放系统调用号</li>
<li>edx、ecx、ebx、edi、esi中按照顺序存放前五个参数</li>
<li>返回值存放在eax中</li>
</ul>
<p>令人感到奇怪的是，这与Linux系统在x86架构下一般的习惯并不相符。（<a href="https://stackoverflow.com/questions/2535989/what-are-the-calling-conventions-for-unix-linux-system-calls-on-i386-and-x86-6" target="_blank" rel="noopener">https://stackoverflow.com/questions/2535989/what-are-the-calling-conventions-for-unix-linux-system-calls-on-i386-and-x86-6</a>，其中给出的顺序是ebx、ecx、edx、esi、edi）。不过这并不是很重要，总之这个顺序与<code>kern/syscall/syscall.c</code>中对应的代码是相符的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">syscall(void) &#123;</span><br><span class="line">    struct trapframe *tf = current-&gt;tf;</span><br><span class="line">    uint32_t arg[5];</span><br><span class="line">    int num = tf-&gt;tf_regs.reg_eax;</span><br><span class="line">    if (num &gt;= 0 &amp;&amp; num &lt; NUM_SYSCALLS) &#123;</span><br><span class="line">        if (syscalls[num] != NULL) &#123;</span><br><span class="line">            arg[0] = tf-&gt;tf_regs.reg_edx;</span><br><span class="line">            arg[1] = tf-&gt;tf_regs.reg_ecx;</span><br><span class="line">            arg[2] = tf-&gt;tf_regs.reg_ebx;</span><br><span class="line">            arg[3] = tf-&gt;tf_regs.reg_edi;</span><br><span class="line">            arg[4] = tf-&gt;tf_regs.reg_esi;</span><br><span class="line">            tf-&gt;tf_regs.reg_eax = syscalls[num](arg);</span><br><span class="line">            return ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    print_trapframe(tf);</span><br><span class="line">    panic(&quot;undefined syscall %d, pid = %d, name = %s.\n&quot;,</span><br><span class="line">            num, current-&gt;pid, current-&gt;name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ref: <a href="https://www.ibm.com/developerworks/library/l-ia/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/library/l-ia/index.html</a></p>
<hr>
<p><strong>getpid的返回值放在什么地方了？</strong></p>
<blockquote>
<p>参见：用户态函数syscall()中的汇编代码</p>
</blockquote>
<p>这个问题很平凡，只是放在eax里面了而已。（又不是fork……）</p>
<hr>
<p><strong>ucore的内存布局中，页表、用户栈、内核栈在逻辑地址空间中的位置？</strong></p>
<p>参见<code>kern/mm/memlayout.h</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#define VPT 0xFAC00000</span><br><span class="line"></span><br><span class="line">#define KSTACKPAGE 2 // # of pages in kernel stack</span><br><span class="line"></span><br><span class="line">#define KSTACKSIZE (KSTACKPAGE * PGSIZE) // sizeof kernel stack</span><br><span class="line"></span><br><span class="line">#define USERTOP 0xB0000000</span><br><span class="line"></span><br><span class="line">#define USTACKTOP USERTOP</span><br><span class="line"></span><br><span class="line">#define USTACKPAGE 256 // # of pages in user stack</span><br><span class="line"></span><br><span class="line">#define USTACKSIZE (USTACKPAGE * PGSIZE) // sizeof user stack</span><br></pre></td></tr></table></figure>
<p>事实上，页表位于内核虚拟空间0xFAC00000<sub>0xFB000000位置，用户栈位于用户虚拟空间?</sub>0xB0000000位置（因为栈是向下增长的），内核栈位于内核虚拟空间……诶怎么没说内核栈在什么位置？我猜是在~0xF8000000位置吧。</p>
<p>这个字符画的水平十分高超：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/* *</span><br><span class="line"> * Virtual memory map:                                          Permissions</span><br><span class="line"> *                                                              kernel/user</span><br><span class="line"> *</span><br><span class="line"> *     4G ------------------&gt; +---------------------------------+</span><br><span class="line"> *                            |                                 |</span><br><span class="line"> *                            |         Empty Memory (*)        |</span><br><span class="line"> *                            |                                 |</span><br><span class="line"> *                            +---------------------------------+ 0xFB000000</span><br><span class="line"> *                            |   Cur. Page Table (Kern, RW)    | RW/-- PTSIZE</span><br><span class="line"> *     VPT -----------------&gt; +---------------------------------+ 0xFAC00000</span><br><span class="line"> *                            |        Invalid Memory (*)       | --/--</span><br><span class="line"> *     KERNTOP -------------&gt; +---------------------------------+ 0xF8000000</span><br><span class="line"> *                            |                                 |</span><br><span class="line"> *                            |    Remapped Physical Memory     | RW/-- KMEMSIZE</span><br><span class="line"> *                            |                                 |</span><br><span class="line"> *     KERNBASE ------------&gt; +---------------------------------+ 0xC0000000</span><br><span class="line"> *                            |        Invalid Memory (*)       | --/--</span><br><span class="line"> *     USERTOP -------------&gt; +---------------------------------+ 0xB0000000</span><br><span class="line"> *                            |           User stack            |</span><br><span class="line"> *                            +---------------------------------+</span><br><span class="line"> *                            |                                 |</span><br><span class="line"> *                            :                                 :</span><br><span class="line"> *                            |         ~~~~~~~~~~~~~~~~        |</span><br><span class="line"> *                            :                                 :</span><br><span class="line"> *                            |                                 |</span><br><span class="line"> *                            ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"> *                            |       User Program &amp; Heap       |</span><br><span class="line"> *     UTEXT ---------------&gt; +---------------------------------+ 0x00800000</span><br><span class="line"> *                            |        Invalid Memory (*)       | --/--</span><br><span class="line"> *                            |  - - - - - - - - - - - - - - -  |</span><br><span class="line"> *                            |    User STAB Data (optional)    |</span><br><span class="line"> *     USERBASE, USTAB------&gt; +---------------------------------+ 0x00200000</span><br><span class="line"> *                            |        Invalid Memory (*)       | --/--</span><br><span class="line"> *     0 -------------------&gt; +---------------------------------+ 0x00000000</span><br><span class="line"> * (*) Note: The kernel ensures that &quot;Invalid Memory&quot; is *never* mapped.</span><br><span class="line"> *     &quot;Empty Memory&quot; is normally unmapped, but user programs may map pages</span><br><span class="line"> *     there if desired.</span><br><span class="line"> *</span><br><span class="line"> * */</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>在do_execve中的的当前进程如何清空地址空间内容的？在什么时候开始使用新加载进程的地址空间？</strong></p>
<blockquote>
<p>清空进程地址空间是在initproc所在进程地址空间<br>
CR3设置成新建好的页表地址后，开始使用新的地址空间</p>
</blockquote>
<p>这个答案简直语无伦次……总之上面已经说过<code>do_execve()</code>函数的流程了。清空地址空间是通过释放<code>mm_struct</code>结构完成的（虽然initproc并不会这么做，因为它直接用的是内核的<code>mm_struct</code>）。至于页表，<code>do_execve()</code>在释放<code>mm_struct</code>之前会先换成内核自己的页表；<code>load_icode()</code>中，设置进程的新<code>mm_struct</code>时会加载新页表（第5步）。</p>
<hr>
<p><strong>新加载进程的第一级页表的建立代码在哪？</strong></p>
<p>在<code>load_icode()</code>的第2步中，调用了<code>setup_pgdir(mm)</code>。</p>
<hr>
<p><strong>do_execve在处理中是如何正确区分出用户进程和线程的？并为此采取了哪些不同的处理？</strong></p>
<p>我猜这道题说的是内核线程吧。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mm != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    lcr3(boot_cr3);</span><br><span class="line">    <span class="keyword">if</span> (mm_count_dec(mm) == <span class="number">0</span>) &#123;</span><br><span class="line">        exit_mmap(mm);</span><br><span class="line">        put_pgdir(mm);</span><br><span class="line">        mm_destroy(mm);</span><br><span class="line">    &#125;</span><br><span class="line">    current-&gt;mm = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内核线程的<code>mm</code>直接借用了内核自己的<code>mm</code>，所以这里处理了这一点。</p>
<hr>
<p><strong>第一个内核线程和第一个用户进程的创建有什么不同？</strong></p>
<ul>
<li>相应线程的内核栈创建时，多了SS和ESP的设置；</li>
<li>用户进程需要创建用户地址空间，并把用户代码复制到用户地址空间；</li>
</ul>
<p>设置ss和esp对应lab5的练习1：在用户进程的内核栈中存放的<code>trapframe</code>中填写对应的寄存器。其次就是要<code>load_icode</code>了，不能直接调用内核中的函数。而且不能和内核共用页表，要新建自己的页表。</p>
<hr>
<p><strong>尝试跟踪分析新创建的用户进程的开始执行过程？</strong></p>
<p>……反正我写的实验报告中是这么说的：</p>
<p><code>load_icode</code>函数成功结束运行后，系统中断返回到<code>exit</code>的第一行代码。<code>exit</code>本身的执行过程在此暂时忽略。</p>
<p><code>exit</code>线程执行结束之后，系统切换到<code>initproc</code>线程，它进行检查并退出。</p>
<p>差不多吧。</p>
<hr>
<p><strong>为什么新进程的内核堆栈可以先于进程地址空间复制进行创建？</strong></p>
<p>内核栈在进程的内核地址空间，而各进程的内核地址空间是共享的。</p>
<hr>
<p><strong>进程复制的代码在哪？复制了哪些内容？</strong></p>
<p>以下代码来自<code>lab5/kern/process/proc.c</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">do_fork(uint32_t clone_flags, uintptr_t stack, struct trapframe *tf) &#123;</span><br><span class="line">    int ret = -E_NO_FREE_PROC;</span><br><span class="line">    struct proc_struct *proc;</span><br><span class="line">    if (nr_process &gt;= MAX_PROCESS) &#123;</span><br><span class="line">        goto fork_out;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">    //    1. call alloc_proc to allocate a proc_struct</span><br><span class="line">	proc = alloc_proc();</span><br><span class="line">	if (proc == NULL) &#123;  // 参考答案添加了错误处理</span><br><span class="line">		goto fork_out;</span><br><span class="line">	&#125;</span><br><span class="line">	proc-&gt;parent = current;  // 参考了答案</span><br><span class="line">	//    2. call setup_kstack to allocate a kernel stack for child process</span><br><span class="line">	if (setup_kstack(proc) != 0) &#123;  // 参考答案添加了错误处理</span><br><span class="line">		goto bad_fork_cleanup_proc;</span><br><span class="line">	&#125;</span><br><span class="line">	//    3. call copy_mm to dup OR share mm according clone_flag</span><br><span class="line">	// CLONE_VM表示分享；实际上因为都在内核态所以什么都没做，只是assert NULL了</span><br><span class="line">	if (copy_mm(clone_flags, proc) != 0) &#123;  // 参考答案添加了错误处理</span><br><span class="line">		goto bad_fork_cleanup_kstack;</span><br><span class="line">	&#125;</span><br><span class="line">	//    4. call copy_thread to setup tf &amp; context in proc_struct</span><br><span class="line">	copy_thread(proc, stack, tf);</span><br><span class="line">	//    5. insert proc_struct into hash_list &amp;&amp; proc_list</span><br><span class="line">	// 参考了答案：关中断的原因是，进程号要求唯一性，此操作需要为原子操作，防止被打断而重复添加</span><br><span class="line">	// 所以参考答案是很有必要的。但是我认为在实验指导书中也应该说明一下。</span><br><span class="line">	bool intr_flag;</span><br><span class="line">	local_intr_save(intr_flag);</span><br><span class="line">	&#123;</span><br><span class="line">		proc-&gt;pid = get_pid();</span><br><span class="line">		hash_proc(proc);</span><br><span class="line">		// list_add_before(&amp;proc_list, &amp;proc-&gt;list_link);</span><br><span class="line">		set_links(proc);</span><br><span class="line">	&#125;</span><br><span class="line">	local_intr_restore(intr_flag);</span><br><span class="line">	//    6. call wakeup_proc to make the new child process RUNNABLE</span><br><span class="line">	wakeup_proc(proc);</span><br><span class="line">	//    7. set ret vaule using child proc&apos;s pid</span><br><span class="line">	ret = proc-&gt;pid;</span><br><span class="line"></span><br><span class="line">fork_out:</span><br><span class="line">    return ret;</span><br><span class="line"></span><br><span class="line">bad_fork_cleanup_kstack:</span><br><span class="line">    put_kstack(proc);</span><br><span class="line">bad_fork_cleanup_proc:</span><br><span class="line">    kfree(proc);</span><br><span class="line">    goto fork_out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，以上代码中复制的主要内容是<code>mm_struct</code>内存管理结构（相当于复制了一份虚拟内存及其中的内容）。</p>
<hr>
<p><strong>进程复制过程中有哪些修改？为什么要修改？</strong></p>
<p>参见上一题的代码，需要修改的内容包括：</p>
<ul>
<li>为新进程分配一个新的进程控制块</li>
<li>分配一个新的内核栈</li>
<li>修改内核栈中存储的<code>trapframe</code>的内容</li>
<li>分配一个新的PID</li>
</ul>
<hr>
<p><strong>分析第一个用户进程的创建流程，说明进程切换后执行的第一条是什么。</strong></p>
<p>以下内容摘自ucore docs Lab5：</p>
<blockquote>
<p>在确定了用户进程的执行代码和数据，以及用户进程的虚拟空间布局后，我们可以来创建用户进程了。在本实验中第一个用户进程是由第二个内核线程initproc通过把hello应用程序执行码覆盖到initproc的用户虚拟内存空间来创建的。<br>
initproc的执行主体是<code>init_main</code>函数，这个函数在缺省情况下是执行宏<code>KERNEL_EXECVE(hello)</code>，而这个宏最终会调用<code>kernel_execve</code>函数来执行SYS_exec系统调用。<br>
ucore收到此系统调用后，最终通过<code>do_execve</code>函数来完成用户进程的创建工作。此函数的主要工作流程如下：</p>
</blockquote>
<ol>
<li>首先为加载新的执行码做好用户态内存空间清空准备。如果mm不为NULL，则设置页表为内核空间页表，且进一步判断mm的引用计数减1后是否为0，如果为0，则表明没有进程再需要此进程所占用的内存空间，为此将根据mm中的记录，释放进程所占用户空间内存和进程页表本身所占空间。最后把当前进程的mm内存管理指针为空。由于此处的initproc是内核线程，所以mm为NULL，整个处理都不会做。</li>
<li>接下来的一步是加载应用程序执行码到当前进程的新创建的用户态虚拟空间中。这里涉及到读ELF格式的文件，申请内存空间，建立用户态虚存空间，加载应用程序执行码等。load_icode函数完成了整个复杂的工作。<br>
load_icode函数的主要工作就是给用户进程建立一个能够让用户进程正常运行的用户环境。此函数有一百多行，完成了如下重要工作：</li>
<li>调用<code>mm_create</code>函数来申请进程的内存管理数据结构mm所需内存空间，并对mm进行初始化；</li>
<li>调用<code>setup_pgdir</code>来申请一个页目录表所需的一个页大小的内存空间，并把描述ucore内核虚空间映射的内核页表（<code>boot_pgdir</code>所指）的内容拷贝到此新目录表中，最后让<code>mm-&gt;pgdir</code>指向此页目录表，这就是进程新的页目录表了，且能够正确映射内核虚空间；</li>
<li>根据应用程序执行码的起始位置来解析此ELF格式的执行程序，并调用<code>mm_map</code>函数根据ELF格式的执行程序说明的各个段（代码段、数据段、BSS段等） 的起始位置和大小建立对应的vma结构，并把vma插入到mm结构中，从而表明了用户进程的合法用户态虚拟地址空间；</li>
<li>调用根据执行程序各个段的大小分配物理内存空间，并根据执行程序各个段的起始位置确定虚拟地址，并在页表中建立好物理地址和虚拟地址的映射关系，然后把执行程序各个段的内容拷贝到相应的内核虚拟地址中，至此应用程序执行码和数据已经根据编译时设定地址放置到虚拟内存中了；</li>
<li>需要给用户进程设置用户栈，为此调用mm_mmap函数建立用户栈的vma结构，明确用户栈的位置在用户虚空间的顶端，大小为256个页，即1MB，并分配一定数量的物理内存且建立好栈的虚地址&lt;–&gt;物理地址映射关系；</li>
<li>至此,进程内的内存管理vma和mm数据结构已经建立完成，于是把mm-&gt;pgdir赋值到cr3寄存器中，即更新了用户进程的虚拟内存空间，此时的initproc已经被hello的代码和数据覆盖，成为了第一个用户进程，但此时这个用户进程的执行现场还没建立好；</li>
<li>先清空进程的中断帧，再重新设置进程的中断帧，使得在执行中断返回指令“iret”后，能够让CPU转到用户态特权级，并回到用户态内存空间，使用用户态的代码段、数据段和堆栈，且能够跳转到用户进程的第一条指令执行，并确保在用户态能够响应中断；<br>
至此，用户进程的用户环境已经搭建完毕。此时initproc将按产生系统调用的函数调用路径原路返回，执行中断返回指令“iret”（位于trapentry.S的最后一句）后，将切换到用户进程hello的第一条语句位置_start处（位于user/libs/initcode.S的第三句） 开始执行。</li>
</ol>
<hr>
<p><strong>什么是写时复制？</strong></p>
<blockquote>
<p>写时复制（Copy-on-Write，也缩写为COW），顾名思义，就是在写入时才真正复制一份内存进行修改。COW最早应用在*nix系统中对线程与内存使用的优化，后面广泛的被使用在各种编程语言中，如C++的STL等。在PHP内核中，COW也是主要的内存优化手段。在前面关于变量和内存的讨论中，引用计数对变量的销毁与回收中起着至关重要的标识作用。引用计数存在的意义，就是为了使得COW可以正常运作，从而实现对内存的优化使用。（<a href="https://blog.csdn.net/ghostlv/article/details/51249494" target="_blank" rel="noopener">50-写时复制COW机制</a>）</p>
</blockquote>
<hr>
<p><strong>写时复制的页表在什么时候进行复制？共享地址空间和写时复制有什么不同？</strong></p>
<p>在发生写操作时进行复制。共享地址空间并不在意是否发生写操作……</p>
<hr>
<p><strong>存在有多个（n&gt;2）进程具有父子关系，且采用了COW机制的情况。这个情况与只有父子两个进程的情况相比，在设计COW时，需要注意的新问题是什么？有何解决方案？</strong></p>
<p>大概发生一次写操作可能有多个页表发生修改。</p>
<h3 id="实践题"><a class="markdownIt-Anchor" href="#实践题"></a> 实践题</h3>
<p><strong>尝试在panic函数中获取并输出用户栈和内核栈的函数嵌套信息和函数调用参数信息，然后在你希望的地方人为触发panic函数，并输出上述信息。</strong></p>
<p>没写。</p>
<hr>
<p><strong>尝试在panic函数中获取和输出页表有效逻辑地址空间范围和在内存中的逻辑地址空间范围，然后在你希望的地方人为触发panic函数，并输出上述信息。</strong></p>
<p>没写。</p>
<hr>
<p><strong>尝试在进程运行过程中获取内核空间中各进程相同的页表项（代码段）和不同的页表项（内核堆栈）？</strong></p>
<p>没写。。。</p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/OS/"><i class="fas fa-hashtag fa-fw"></i>OS</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/post/os-mooc-lecture-18-summary/">
              
                  《操作系统》第18讲：“信号量与管程”总结
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://zhanghuimeng.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            张慕晖
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2018-05-25
          </a>
        </div>
      
      
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="课程内容概述"><a class="markdownIt-Anchor" href="#课程内容概述"></a> 课程内容概述</h2>
<ul>
<li>信号量
<ul>
<li>信号量简介</li>
<li>信号量使用
<ul>
<li>互斥访问</li>
<li>条件同步</li>
</ul>
</li>
</ul>
</li>
<li>管程
<ul>
<li>条件变量</li>
<li>管程的语义</li>
</ul>
</li>
<li>经典问题
<ul>
<li>生产者-消费者问题
<ul>
<li>信号量实现</li>
<li>管程实现</li>
</ul>
</li>
<li>哲学家就餐问题</li>
<li>读者-写者问题</li>
</ul>
</li>
</ul>
<h3 id="信号量semaphore"><a class="markdownIt-Anchor" href="#信号量semaphore"></a> 信号量（Semaphore）</h3>
<p>信号量是操作系统提供的一种协调共享资源访问的方法。它和软件同步的区别是：</p>
<ul>
<li>软件同步是平等线程间的一种同步协商机制</li>
<li>信号量是由操作系统进行管理的，它的地位高于进程（而非平等协商）</li>
</ul>
<p>信号量由Dijkstra在20世纪60年代提出，目前仍然在OS中被使用。</p>
<h4 id="信号量简介"><a class="markdownIt-Anchor" href="#信号量简介"></a> 信号量简介</h4>
<p>信号是一种抽象数据类型：</p>
<ul>
<li>由一个整型变量（<code>sem</code>）和两个原子操作组成</li>
<li><code>sem</code>：要共享的资源的数目</li>
<li><code>P()</code>操作（Prolaag，尝试减少，请求资源时进行）
<ul>
<li><code>sem-1</code></li>
<li>若<code>sem&lt;0</code>，进入等待，否则继续运行</li>
</ul>
</li>
<li><code>V()</code>操作（Verhoog，增加，释放资源时进行）
<ul>
<li><code>sem+1</code></li>
<li>若<code>sem&lt;=0</code>，则唤醒一个等待进程</li>
</ul>
</li>
</ul>
<p>信号量的一些特点：</p>
<ul>
<li>信号量可以被认为是被保护的整数变量
<ul>
<li>初始化完成后，只能通过P()和V()操作修改</li>
<li>由操作系统保证，PV操作是原子操作</li>
<li>可以保证不受应用进程的干扰</li>
</ul>
</li>
<li>P()操作可能阻塞，但V()操作不会阻塞</li>
<li>通常假定信号量是“公平的”
<ul>
<li>线程不会被无限期阻塞在P()操作（实际系统中有一个最长时限的参数，超时之后错误返回）</li>
<li>假定信号量等待按先进先出排队（但是在实际系统中公平有所偏差）</li>
</ul>
</li>
</ul>
<p>下面给出信号量在原理上的一个实现（之所以是原理上的实现，是因为实际实现时要考虑很多问题）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class Semaphore &#123;</span><br><span class="line">    int sem;</span><br><span class="line">    WaitQueue q;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Semaphore::P() &#123;</span><br><span class="line">    sem--;</span><br><span class="line">    if (sem &lt; 0) &#123;</span><br><span class="line">        Add this thread t to q;</span><br><span class="line">        block(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Semaphore::V() &#123;</span><br><span class="line">    sem++;</span><br><span class="line">    if (sem &gt;= 0) &#123;</span><br><span class="line">        Remove a thread t from q;</span><br><span class="line">        wakeup(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="信号量使用"><a class="markdownIt-Anchor" href="#信号量使用"></a> 信号量使用</h4>
<p>信号量一般可分为两类：</p>
<ul>
<li>二进制信号量：资源数目为0或1</li>
<li>资源信号量：资源数目为任何非负值</li>
</ul>
<p>下面讨论两个信号量的使用场景：</p>
<ul>
<li>互斥访问：临界区的互斥访问控制</li>
<li>条件同步：线程间的事件等待</li>
</ul>
<h5 id="互斥访问"><a class="markdownIt-Anchor" href="#互斥访问"></a> 互斥访问</h5>
<p>互斥访问的实现方法非常简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 每类资源设置一个信号量，其初值为1</span><br><span class="line">mutex = new Semaphore(1);</span><br><span class="line">// 临界区的控制代码如下：</span><br><span class="line">mutex-&gt;P();</span><br><span class="line">Critical Section;</span><br><span class="line">mutex-&gt;V();</span><br></pre></td></tr></table></figure>
<p>在这种情况下，信号量的使用和锁相同。需要注意以下几点：</p>
<ul>
<li>必须成对使用P()操作和V()操作</li>
<li>P()操作保证互斥访问临界资源</li>
<li>V()操作在使用后释放临界资源</li>
<li>PV操作不能次序颠倒、重复或遗漏</li>
</ul>
<h5 id="条件同步"><a class="markdownIt-Anchor" href="#条件同步"></a> 条件同步</h5>
<p>举例：线程A执行完X模块之后，线程B才能执行Y模块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 设置一个初值为0的信号量</span><br><span class="line">condition = new Semaphore(0);</span><br><span class="line"></span><br><span class="line">// Thread A</span><br><span class="line">Module X &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">condition.V();</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// Thread B</span><br><span class="line">...</span><br><span class="line">condition.P();</span><br><span class="line">Module Y &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="管程monitor"><a class="markdownIt-Anchor" href="#管程monitor"></a> 管程（Monitor）</h3>
<p>管程是一种用于多线程互斥访问共享资源的程序结构</p>
<ul>
<li>采用面向对象方法，简化了线程间的同步控制</li>
<li>任一时刻最多只有一个线程执行管程代码</li>
<li>正在管程中的线程可临时放弃管程的互斥访问，等待事件出现时恢复（这是最大的特点）</li>
</ul>
<p>管程的组成：</p>
<ul>
<li>一个锁：控制管程代码的互斥访问</li>
<li>入口队列：每次只能有一个线程进入</li>
<li>0或多个条件变量：管理共享数据的并发访问</li>
</ul>
<p>下面需要介绍一下条件变量了。</p>
<h4 id="条件变量condition-variable"><a class="markdownIt-Anchor" href="#条件变量condition-variable"></a> 条件变量（Condition Variable）</h4>
<p>条件变量是管程内的等待机制</p>
<ul>
<li>进入管程的线程因资源被占用而进入等待状态</li>
<li>每个条件变量表示一种等待原因，对应一个等待队列</li>
<li><code>Wait()</code>操作：
<ul>
<li>将自己阻塞在等待队列中</li>
<li>唤醒一个等待者或释放管程的互斥访问（即允许另外一个线程进入管程）</li>
</ul>
</li>
<li><code>Signal()</code>操作：
<ul>
<li>将等待队列中的一个线程唤醒</li>
<li>如果等待队列为空，这就相当于是一个空操作</li>
</ul>
</li>
</ul>
<p>条件变量在原理上的实现和信号量有些类似：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class Condition &#123;</span><br><span class="line">    int numWaiting = 0;</span><br><span class="line">    WaitQueue q;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Condition::Wait(Lock lock) &#123;</span><br><span class="line">    numWaiting++;</span><br><span class="line">    Add this thread t to q;</span><br><span class="line">    release(lock);</span><br><span class="line">    schedule(); // need mutex</span><br><span class="line">    acquire(lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Condition::Signal() &#123;</span><br><span class="line">    if (numWaiting &gt; 0) &#123;</span><br><span class="line">        Remove a thread t from q;</span><br><span class="line">        wakeup(t); // need mutex</span><br><span class="line">        numWaiting--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是有很多不同的地方，如：</p>
<ul>
<li>对管程的互斥锁的释放和获得</li>
<li>signal和P语义的不同：PV操作必须是成对的，但signal/wait操作完全不需要保证这一点</li>
<li>wait和V语义的不同：V操作后线程可能会继续执行，但wait操作后，线程必然进入等待队列并阻塞</li>
<li>执行signal/wait时，都默认已经获得了互斥锁</li>
</ul>
<h4 id="管程的语义"><a class="markdownIt-Anchor" href="#管程的语义"></a> 管程的语义</h4>
<p>事实上管程一共有三种语义：</p>
<ul>
<li>Mesa语义</li>
<li>Hoare语义</li>
<li>Hansen语义</li>
</ul>
<p>以下内容参考了<a href="https://piazza.com/class/i5j09fnsl7k5x0?cid=894" target="_blank" rel="noopener">Piazza上的讨论</a>和<a href="https://www.andrew.cmu.edu/course/15-440-kesden/applications/ln/lecture6.html" target="_blank" rel="noopener">CMU的课件</a>。</p>
<p>考虑如下情况：线程A在条件变量的等待队列中等待资源，此时线程B在该资源（或者说该条件变量）上执行signal操作。</p>
<h5 id="mesa语义"><a class="markdownIt-Anchor" href="#mesa语义"></a> Mesa语义</h5>
<ul>
<li>线程B执行signal之后，不会立刻退出管程，而是执行到lock.release()之后才进入就绪态</li>
<li>线程A会被移动到入口等待队列中</li>
<li>在wait后被唤醒的进程不一定会被立刻调度，因此需要用<code>while</code>来检查条件</li>
<li>大部分实际实现的管程采用的是这一语义</li>
</ul>
<p><img src="monitor_mesa.jpg" alt="Mesa语义下管程的执行过程"></p>
<h5 id="hoare语义"><a class="markdownIt-Anchor" href="#hoare语义"></a> Hoare语义</h5>
<ul>
<li>线程B执行signal之后，迅速唤醒等待中的线程A，自己进入signal队列中（这个队列是此语义特有的）</li>
<li>每次有线程退出时，先到signal队列中调度线程，如果signal队列空，才到入口等待队列调度线程</li>
<li>实际实现中一般不采用，因为需要多一个队列，代价增大了</li>
</ul>
<p><img src="monitor_hoare.jpg" alt="Hoare语义下管程的执行过程"></p>
<h5 id="brinch-hanson语义"><a class="markdownIt-Anchor" href="#brinch-hanson语义"></a> Brinch Hanson语义</h5>
<ul>
<li>线程B退出的同时才执行signal操作</li>
</ul>
<p><img src="monitor_bh.jpg" alt="Brinch Hanson语义下管程的执行过程"></p>
<h3 id="经典问题"><a class="markdownIt-Anchor" href="#经典问题"></a> 经典问题</h3>
<h4 id="生产者-消费者问题"><a class="markdownIt-Anchor" href="#生产者-消费者问题"></a> 生产者-消费者问题</h4>
<p>有界缓冲区的生产者-消费者问题描述：</p>
<ul>
<li>一个或多个生产者在生成数据后放在一个缓冲区里</li>
<li>单个消费者从缓冲区取出数据处理</li>
<li>任何时候只能有一个生产者或消费者可访问缓冲区</li>
</ul>
<h5 id="信号量实现"><a class="markdownIt-Anchor" href="#信号量实现"></a> 信号量实现</h5>
<p>问题分析：</p>
<ul>
<li>任何时刻只能有一个线程操作缓冲区，这是临界区（互斥访问）</li>
<li>缓冲区空时，消费者必须等待生产者（条件同步）</li>
<li>缓冲区满时，生产者必须等待消费者（条件同步）</li>
</ul>
<p>用信号量描述每个约束：</p>
<ul>
<li>二进制信号量<code>mutex</code>：互斥</li>
<li>资源信号量<code>fullBuffers</code>：缓冲区为满（信号量的值表示缓冲区中数据的个数）</li>
<li>资源信号量<code>emptyBuffers</code>：缓冲区为空（信号量的值表示缓冲区中空位的个数）</li>
<li>其中<code>fullBuffers+emptyBuffers=缓冲区大小</code></li>
</ul>
<p>（事实上，OSTEP中讨论了如果只使用一个资源信号量会导致死锁的问题，在此不再赘述了）</p>
<p>下面给出（原理上的）代码实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class BoundedBuffer &#123;</span><br><span class="line">    mutex = new Semaphore(1);</span><br><span class="line">    fullBuffers = new Semaphore(0);</span><br><span class="line">    emptyBuffers = new Semaphore(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BoundedBuffer::Deposit(c) &#123;</span><br><span class="line">    emptyBuffers-&gt;P();</span><br><span class="line">    mutex-&gt;P();</span><br><span class="line">    Add c to the buffer;</span><br><span class="line">    mutex-&gt;V();</span><br><span class="line">    fullBuffers-&gt;V();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BoundedBuffer::Remove(c) &#123;</span><br><span class="line">    fullBuffers-&gt;P();</span><br><span class="line">    mutex-&gt;P();</span><br><span class="line">    Remove c from buffer;</span><br><span class="line">    mutex-&gt;V();</span><br><span class="line">    emptyBuffers-&gt;V();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意P操作之间不能颠倒顺序。V操作不会阻塞，就无所谓了。</p>
<h5 id="管程实现"><a class="markdownIt-Anchor" href="#管程实现"></a> 管程实现</h5>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class BoundedBuffer &#123;</span><br><span class="line">    Lock lock;</span><br><span class="line">    int count = 0;</span><br><span class="line">    Condition notFull, notEmpty;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BoundedBuffer::Deposit(c) &#123;</span><br><span class="line">    lock-&gt;Acquire();</span><br><span class="line">    while (count == n)</span><br><span class="line">        notFull.Wait(&amp;lock);</span><br><span class="line">    Add c to the buffer;</span><br><span class="line">    count++;</span><br><span class="line">    notEmpty.signal();</span><br><span class="line">    lock-&gt;Release();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BoundedBuffer::Remove(c) &#123;</span><br><span class="line">    lock-&gt;Acquire();</span><br><span class="line">    while (count == 0)</span><br><span class="line">        notEmpty.Wait(&amp;lock);</span><br><span class="line">    Remove c from buffer;</span><br><span class="line">    count--;</span><br><span class="line">    notFull.signal();</span><br><span class="line">    lock-&gt;Release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="信号量和管程实现的对比"><a class="markdownIt-Anchor" href="#信号量和管程实现的对比"></a> 信号量和管程实现的对比</h5>
<p>（以下内容摘自<a href="https://piazza.com/class/i5j09fnsl7k5x0?cid=845" target="_blank" rel="noopener">Piazza</a>，修正了一些typo）</p>
<p><img src="sem-vs-monitor.png" alt="生产者-消费者问题的两种实现的对比"></p>
<p>如图，信号量中存有<code>int</code>变量<code>sem</code>以及<code>WaitQueue</code>变量<code>q</code>，根据信号量的实现代码（左下角ppt），我们可以得出<code>sem</code>和<code>q</code>的含义：</p>
<ul>
<li><code>q</code>代表当前正在等待资源的线程组成的等待队列，若当前资源足够所有进程使用，<code>q</code>为空；</li>
<li><code>sem</code>代表【到目前为止，若所有请求该资源的线程都能够获取该资源，那么资源还剩下多少（这里我们假设资源个数可以为负）】；</li>
<li>对<code>sem</code>也可以有另一种理解：当<code>sem</code>非负时，<code>sem</code>代表剩余资源的个数；当<code>sem</code>为负数时，<code>sem</code>的绝对值代表等待队列<code>q</code>的长度。</li>
</ul>
<p>而当我们使用条件变量解决有限资源问题时，我们通常会在条件变量之外，管程之中加入整型变量<code>count</code>（右上角ppt），来帮助条件变量记录当前剩余多少资源（非负）。查看条件变量的实现代码（右下角ppt），我们可以得出条件变量中整型变量<code>numWaiting</code>以及<code>WaitQueue</code>变量<code>q</code>的含义：</p>
<ul>
<li><code>q</code>代表当前正在等待资源的线程组成的等待队列，若当前资源足够所有进程使用，<code>q</code>为空；</li>
<li><code>numWaiting</code>代表等待队列<code>q</code>的长度（非负）。</li>
</ul>
<p>结合使用信号量以及条件变量解决有限资源问题的实例（左上及右上ppt），以及以上我们对信号量和条件变量的分析，我们可以得出以下结论：</p>
<ul>
<li>在任一状态，信号量中的<code>q</code>和条件变量中的<code>q</code>完全相同；</li>
<li>当<code>sem</code>非负时，含义与管程中的<code>count</code>相同，此时<code>numWaiting</code>为0；</li>
<li>当<code>sem</code>为负数时，<code>sem</code>的绝对值等于<code>numWaiting</code>，此时<code>count</code>为0。</li>
</ul>
<p>在生产者-消费者这个问题实例中：</p>
<ul>
<li>信号量<code>emptyBuffers</code>与条件变量<code>notFull</code>是匹配的，满足上面3个条件，此时<code>count</code>在代码中以<code>n - count</code>的形式出现；</li>
<li>信号量<code>fullBuffers</code>与条件变量<code>notEmpty</code>是匹配的，满足上面3个条件，此时<code>count</code>在代码中以<code>count</code>的形式出现；</li>
</ul>
<p>综上所述，两种解决方法是完全等价的，至于为什么用管程实现更加安全方便，个人认为老师在视频中并没有解释得很清楚，和老师讨论后得出结论如下：</p>
<ul>
<li>用信号量的时候（左上角ppt），所有信号量都要自己维护，并配对好PV；</li>
<li>用管程的时候，我们可以理解为<code>BoundedBuffer</code>继承了一个管程类，因此操作系统会给<code>BoundedBuffer</code>中每一个方法自动加上锁（即右上角ppt中的<code>lock-&gt;Acquire()</code>和<code>lock-&gt;Release()</code>函数并不用自己写，是系统加上的），因此更加安全可控，容易查错。</li>
</ul>
<p>但是个人认为使用条件变量也要根据条件配对好Wait和Signal函数，因此不比使用信号量更容易安全，这个问题见仁见智吧，但如果考试时候问到怎么回答大家懂的~</p>
<p>更新：ucore lab7中实现信号量的<code>sem</code>值非负，这样看来ucore中信号量的<code>sem</code>值和条件变量中的<code>count</code>值应该是完全相等的。</p>
<h4 id="哲学家就餐问题"><a class="markdownIt-Anchor" href="#哲学家就餐问题"></a> 哲学家就餐问题</h4>
<p>问题描述：</p>
<ul>
<li>
<p>5个哲学家围绕在一张圆桌周围</p>
</li>
<li>
<p>桌子上有5根筷子（或者说叉子……随便啦）</p>
</li>
<li>
<p>哲学家的动作包括思考和进餐</p>
</li>
<li>
<p>进餐时一个哲学家需要自己两边的两根筷子</p>
</li>
<li>
<p>如何保证哲学家们的动作有序进行，既不发生饥饿也不发生死锁？</p>
</li>
<li>
<p>方案1：</p>
<ul>
<li>每个筷子用一个信号量表示，sem=1</li>
<li>哲学家先拿第一根筷子，再拿第二根筷子，然后吃，最后放回两根筷子</li>
<li>多数情况下这一算法可行；但极端情况下会出现死锁，比如所有哲学家同时拿左边的筷子</li>
</ul>
</li>
<li>
<p>方案2：</p>
<ul>
<li>除了每根筷子的信号量之外，再加上一个互斥信号量，同时只能有一个哲学家就餐</li>
<li>能够保证顺序吃饭，但是浪费了资源和时间</li>
</ul>
</li>
<li>
<p>方案3：</p>
<ul>
<li>和方案1一样，使用5个信号量表示筷子</li>
<li>哲学家根据编号不同，拿取筷子的顺序不同</li>
<li>此时没有死锁，且允许两个人同时就餐</li>
</ul>
</li>
</ul>
<h5 id="信号量实现-2"><a class="markdownIt-Anchor" href="#信号量实现-2"></a> 信号量实现</h5>
<p>这一实现和ucore lab中给出的使用信号量的实现不太一样，而是参考了OSTEP中的做法（更准确地说是Dijkstra本人的做法）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialization</span></span><br><span class="line">Semaphore forks[<span class="number">5</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    forks[i] = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper functions</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">left</span><span class="params">(<span class="keyword">int</span> p)</span> </span>&#123; <span class="keyword">return</span> p; &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">right</span><span class="params">(<span class="keyword">int</span> p)</span> </span>&#123; <span class="keyword">return</span> (p + <span class="number">1</span>) % <span class="number">5</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Thread x</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Philosopher</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Switch between thinking and eating</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        think();</span><br><span class="line">        <span class="comment">// get forks</span></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="number">4</span>) &#123;  <span class="comment">// break dependency</span></span><br><span class="line">            forks[right(x)].P();</span><br><span class="line">            forks[left(x)].P();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            forks[left(x)].P();</span><br><span class="line">            forks[right(x)].P();</span><br><span class="line">        &#125;</span><br><span class="line">        eat();</span><br><span class="line">        <span class="comment">// put forks</span></span><br><span class="line">        forks[left(x)].V();</span><br><span class="line">        forks[right(x)].V();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="读者-写者问题"><a class="markdownIt-Anchor" href="#读者-写者问题"></a> 读者-写者问题</h4>
<p>问题描述：对于一个共享数据，有两类使用者</p>
<ul>
<li>读者：只读取数据，不修改（可以同时读）</li>
<li>写者：读取和修改数据（不可以同时写）</li>
<li>读写是互斥的</li>
</ul>
<p>事实上，也需要考虑到，至少有两种可能的策略（而且还会有更多）：</p>
<ul>
<li>读者优先策略：
<ul>
<li>只要有读者正在读状态，后来的读者就能直接进入</li>
<li>如果读者不断进入，则写者就处于饥饿</li>
</ul>
</li>
<li>写者优先策略
<ul>
<li>只要有写者就绪，写者应尽快执行写操作（后来的读者需要阻塞）</li>
<li>如果写者持续不断就绪，则读者就处于饥饿</li>
</ul>
</li>
</ul>
<h5 id="信号量实现-3"><a class="markdownIt-Anchor" href="#信号量实现-3"></a> 信号量实现</h5>
<p>用信号量描述每个约束：</p>
<ul>
<li>信号量<code>WriteMutex</code>
<ul>
<li>控制读写操作的互斥</li>
<li>初始化为1</li>
</ul>
</li>
<li>读者计数<code>Rcount</code>
<ul>
<li>正在进行读操作的读者数目</li>
<li>初始化为0</li>
</ul>
</li>
<li>信号量<code>CountMutex</code>
<ul>
<li>保护对读者计数的互斥修改</li>
<li>初始化为1</li>
</ul>
</li>
</ul>
<p>解决方案：</p>
<ul>
<li>读者的互斥锁只针对于第一个读者，之后不再判断</li>
<li>因为Rcount也需要保护，所以外面也加上互斥锁</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    WriteMutex.P();</span><br><span class="line">    write;</span><br><span class="line">    WriteMutex.V();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CountMutex.P();</span><br><span class="line">    <span class="keyword">if</span> (Rcount == <span class="number">0</span>)</span><br><span class="line">        WriteMutex.P();</span><br><span class="line">    Rcount++;</span><br><span class="line">    CountMutex.V();</span><br><span class="line"></span><br><span class="line">    read;</span><br><span class="line"></span><br><span class="line">    CountMutex.P();</span><br><span class="line">    Rcount--;</span><br><span class="line">    <span class="keyword">if</span> (Rcount == <span class="number">0</span>)</span><br><span class="line">        WriteMutex.V();</span><br><span class="line">    CountMutex.V();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这一实现中，只要有读者开始阅读，就必须等到全部读者都离开才能进行写操作。即使有写操作在等待，读者仍然先于写者，说明这是一种读者优先策略。</p>
<h5 id="管程实现-2"><a class="markdownIt-Anchor" href="#管程实现-2"></a> 管程实现</h5>
<p>管程中包括以下内容：</p>
<ul>
<li>一个互斥锁</li>
<li>4个状态变量</li>
<li>2个条件变量：可读/可写</li>
</ul>
<p>从判断条件可以看出，这一实现采用的是写者优先策略。不过其实我还没想明白能否把对<code>AW</code>和<code>WW</code>变量的修改移动到<code>while</code>循环外面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">class Database &#123;</span><br><span class="line">    Lock lock;  // 管程的互斥锁</span><br><span class="line">    int AR = 0;  // Active Readers</span><br><span class="line">    int AW = 0;  // Active Writers</span><br><span class="line">    int WR = 0;  // Waiting Readers</span><br><span class="line">    int WW = 0;  // Waiting Writers</span><br><span class="line">    Condition okToRead, okToWrite;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 两个基本操作</span><br><span class="line">Database::Read() &#123;</span><br><span class="line">    StartRead();  // Wait until no writers</span><br><span class="line">    read database;</span><br><span class="line">    DoneRead();  // Exit &amp; wake up waiting writers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Database::Write() &#123;</span><br><span class="line">    StartWrite();  // Waite until no readers/writers;</span><br><span class="line">    write database;</span><br><span class="line">    DoneWrite();  // Exit &amp; wake up waiting readers/writers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Private Database::StartRead() &#123;</span><br><span class="line">    lock.Acquire();</span><br><span class="line">    while (AW + WW &gt; 0) &#123;</span><br><span class="line">        WR++;</span><br><span class="line">        okToRead.wait(&amp;lock);</span><br><span class="line">        WR--;</span><br><span class="line">    &#125;</span><br><span class="line">    AR++;</span><br><span class="line">    lock.Release();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Private Database::DoneRead() &#123;</span><br><span class="line">    lock.Acquire();</span><br><span class="line">    AR--;</span><br><span class="line">    if (AR == 0 &amp;&amp; WW &gt; 0)</span><br><span class="line">        okToWrite.signal();</span><br><span class="line">    lock.Release();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Private Database::StartWrite() &#123;</span><br><span class="line">    lock.Acquire();</span><br><span class="line">    while (AW + AR &gt; 0) &#123;</span><br><span class="line">        WW++;</span><br><span class="line">        okToWrite.wait(&amp;lock);</span><br><span class="line">        WW--;</span><br><span class="line">    &#125;</span><br><span class="line">    AW++;</span><br><span class="line">    lock.Release();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Private Database::DoneWrite() &#123;</span><br><span class="line">    lock.Acquire();</span><br><span class="line">    AW--;</span><br><span class="line">    if (WW &gt; 0)</span><br><span class="line">        okToWrite.signal();</span><br><span class="line">    else if (AW &gt; 0)</span><br><span class="line">        okToRead.broadcast();</span><br><span class="line">    lock.Release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="练习"><a class="markdownIt-Anchor" href="#练习"></a> 练习</h2>
<p>来自<a href="https://github.com/chyyuu/os_course_exercises/blob/2018spring/all/07-2-quiz.md" target="_blank" rel="noopener">lec18 信号量与管程 在线练习</a>和<a href="https://github.com/chyyuu/os_course_exercises/blob/2018spring/all/07-2-spoc-discussion.md" target="_blank" rel="noopener">同步互斥(lec 18) spoc 思考题</a>。</p>
<h3 id="选择题"><a class="markdownIt-Anchor" href="#选择题"></a> 选择题</h3>
<p><strong>如果有5个进程共享同一程序段，每次允许3个进程进入该程序段，若用PV操作作为同步机制，则信号量S为-1时表示什么（）</strong></p>
<ul>
<li>有四个进程进入了该程序段</li>
<li>有一个进程在等待</li>
<li><strong>有三个进程进入了程序段，有一个进程在等待</strong></li>
<li>有一个进程进入了该程序段，其余四个进程在等待</li>
</ul>
<p>一般来说，信号量实现中会满足，它的整数值如果为负数，则负数的绝对值表示等待中的线程数量。当然似乎也有些实现不是这么做的。</p>
<hr>
<p><strong>2元信号量可以初始化为（）</strong></p>
<ul>
<li><strong>0或1</strong></li>
<li>0或-1</li>
<li>只能为1</li>
<li>任意值</li>
</ul>
<p>之所以可以初始化为0或1，是因为二元信号量至少有两种不同的使用场景：</p>
<ul>
<li>资源数目为1，如只能互斥访问的代码关键区</li>
<li>代码条件等待，这种情况下有可能会先执行V操作，再执行P操作</li>
</ul>
<hr>
<p><strong>多个进程对信号量S进行了6次P操作，2次V操作后，现在信号量的值是-3，与信号量S相关的处于阻塞状态的进程有几个（）</strong></p>
<ul>
<li>1个</li>
<li>2个</li>
<li><strong>3个</strong></li>
<li>4个</li>
</ul>
<p>等待进程的数量就是信号量的值的负数。不过这样可以推导出，请求过信号量资源的进程为6个，得到资源的为2个，现在仍在等待的进程为3个，说明信号量的初值为6-2-3=1。</p>
<hr>
<p><strong>(2011年全国统考)有两个并发执行的进程P1和P2，共享初值为1的变量x。P1对x加1，P2对x减1。加1和减1操作的指令序列分别如下所示；两个操作完成后，x的值（）。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">加一操作    		减一操作</span><br><span class="line">Load R1,x  		load R2,x</span><br><span class="line">inc R1     		dec R2</span><br><span class="line">store x,R1 		store x,R2</span><br></pre></td></tr></table></figure>
<ul>
<li>可能为-1或3</li>
<li>只能为1</li>
<li><strong>可能为0、1或2</strong></li>
<li>可能为-1、0、1、1或2</li>
</ul>
<p>分成以下几种情况讨论：</p>
<ul>
<li>P1和P2的执行完全错开（即加载了不同的x的值）：结果正确，x=1</li>
<li>P1和P2加载了相同的x的值：结果依赖于P1先写还是P2先写，如果P1先写则x=2，否则x=0</li>
</ul>
<hr>
<p><strong>管程的主要特点有（）</strong></p>
<ul>
<li><strong>局部数据变量只能被管程的过程访问</strong></li>
<li><strong>一个进程通过调用管程的一个过程进入管程</strong></li>
<li>不会出现死锁</li>
<li><strong>在任何时候，只能有一个进程在管程中执行</strong></li>
</ul>
<p>课上好像没有讲这么多管程的特点……</p>
<hr>
<p><strong>关于管程的叙述正确的是（）</strong></p>
<ul>
<li>管程中的局部数据变量可以被外部直接访问</li>
<li>当一个进程在管程中执行时，调用管程的其他进程都不会被阻塞</li>
<li>在管程中的signal()与信号量中的signal()操作实现及意义完全相同</li>
<li><strong>管程通过使用条件变量提供对同步的支持，这些条件变量包含在管程中，并且只有管程才能访问</strong></li>
</ul>
<p>管程中的局部变量只能通过管程的过程访问。一个进程在管程中执行时，调用管程的其他过程都会被阻塞。管程中的signal是通过条件变量实现的，而不是信号量，所以意义有微妙的不同。</p>
<h3 id="简答题"><a class="markdownIt-Anchor" href="#简答题"></a> 简答题</h3>
<p><strong>什么是信号量？它与软件同步方法的区别在什么地方？</strong></p>
<p>信号量是由操作系统提供的一种协调共享资源访问的方法。信号量是一种抽象数据类，由一个被保护的整形变量（sem）和P()、V()两个原子操作组成，表示系统资源的数量。</p>
<p>区别：</p>
<ul>
<li>软件同步是平等线程间的一种同步协商机制；</li>
<li>信号量是由地位高于进程的管理者OS协调的同步机制。</li>
</ul>
<hr>
<p><strong>自旋锁为什么无法按先来先服务方式使用资源？</strong></p>
<p>原因：自旋锁是由TS指令实现的临界区申请操作，第一个检测到临界区空闲的申请者而不是第一个开始检测的申请者进入。也就是说，访问顺序是由硬件随机决定的。如果要实现FIFO方式，一般都需要一个队列。</p>
<hr>
<p><strong>下面是一种P操作的实现伪码。它能按FIFO顺序进行信号量申请吗？</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">while (s.count == 0) &#123;  //没有可用资源时，进入挂起状态；</span><br><span class="line">        调用进程进入等待队列s.queue;</span><br><span class="line">        阻塞调用进程;</span><br><span class="line">&#125;</span><br><span class="line">s.count--;              //有可用资源，占用该资源；</span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考回答： 它的问题是，不能按FIFO进行信号量申请。<br>
它的一种出错的情况如下：</p>
</blockquote>
<ul>
<li>一个线程A调用P()原语时，由于线程B正在使用该信号量而进入阻塞状态；注意，这时value的值为0。</li>
<li>线程B放弃信号量的使用，线程A被唤醒而进入就绪状态，但没有立即进入运行状态；注意，这里value为1。</li>
<li>在线程A处于就绪状态时，处理机正在执行线程C的代码；线程C这时也正好调用P()原语访问同一个信号量，并得到使用权。注意，这时value又变回0。</li>
<li>线程A进入运行状态后，重新检查value的值，条件不成立，又一次进入阻塞状态。</li>
<li>至此，线程C比线程A后调用P原语，但线程C比线程A先得到信号量。</li>
</ul>
<p>虽然参考答案是这么说的，但我觉得这有些牵强：事实上这种错误情况取决于V操作的语义。如果V操作能够保证使唤醒的进程立刻抢占处理机，就不会发生以上问题了。这就类似于管程的Hoare语义和Mesa语义的区别。</p>
<p><a href="https://piazza.com/class/i5j09fnsl7k5x0?cid=1219" target="_blank" rel="noopener">Piazza</a>上有一个类似的讨论。事实上，在一般的Mesa语义下，使用<code>if</code>进行检查根本就是不正确的，需要用<code>while</code>。改用<code>while</code>之后，确实能保证正确性，但是FIFO无法保证了。</p>
<hr>
<p><strong>什么是条件同步？如何使用信号量来实现条件同步？</strong></p>
<p>条件同步是指线程间的事件等待。</p>
<p>条件同步的实现方法：定义初始值为<strong>0</strong>的信号量，事件触发进程使用V()操作表示事件出现，事件等待进程使用P()操作表示开始等待事件。</p>
<p>也就是说，此处P和V操作的顺序是颠倒的。</p>
<hr>
<p><strong>什么是生产者-消费者问题？</strong></p>
<ul>
<li>生产者生成数据，并放入缓冲区</li>
<li>消费者从缓冲区取出数据，进行处理</li>
<li>任何时间只有一个进程访问缓冲区</li>
</ul>
<hr>
<p><strong>为什么在生产者-消费者问题中先申请互斥信号量会导致死锁？</strong></p>
<p>如果先申请互斥信号量，后申请资源信号量，则在两种情况下可能会出现循环等待：</p>
<ul>
<li>生产者获得互斥信号量后检查<code>emptyBuffers</code>资源信号量，发现缓冲区满了，于是进入睡眠状态；此时消费者无法获得互斥信号量，于是无法消耗缓冲区内的资源</li>
<li>消费者获得互斥信号量后检查<code>fullBuffers</code>资源信号量，发现缓冲区空了，于是进入睡眠状态；此时生产者无法获得互斥信号量，于是无法将资源放入缓冲区内</li>
</ul>
<p>按答案中更抽象的说法就是这样：</p>
<blockquote></blockquote>
<ul>
<li>缓冲区空时，生产者等待缓冲区的互斥访问，以便放入数据；消费者占有缓冲区访问权，等待生产者放入的数据</li>
<li>缓冲区满时，生产者占有缓冲区访问权，等待空的缓冲块；消费者等待缓冲区的互斥访问，以便取出数据</li>
</ul>
<hr>
<p><strong>为什么互斥信号量的实现比资源信号量的实现要简单？请说明．</strong></p>
<blockquote>
<p>信号量中的整形变量的取值不同，互斥信号量的最大取值为1；而资源信号量的最大取值为资源总数。</p>
</blockquote>
<p>事实上，互斥信号量和互斥锁是等价的。（如果不考虑sem值和等待进程数量关系的问题）。</p>
<hr>
<p><strong>管程的组成包括哪几部分？入口队列和条件变量等待队列的作用是什么？</strong></p>
<blockquote>
<p>管程是一种并发程序的编程方法，由一个与入口队列对应的锁和若干个与共享数据访问的等待队列对应的条件变量组成，从而实现在任一时刻最多只有一个线程执行管程代码。</p>
</blockquote>
<p>管程的组成部分：</p>
<ul>
<li>一个锁：控制管程代码的互斥访问</li>
<li>入口队列：每次只能有一个线程进入</li>
<li>0或多个条件变量（及其对应的等待队列）：管理共享数据的并发访问</li>
</ul>
<p>入口的等待队列和锁保证任一时刻最多只有一个线程执行管程代码；每个条件变量等待队列表示一种等待的资源。</p>
<hr>
<p><strong>管程与临界区有什么异同？</strong></p>
<ul>
<li>相同点：在任一时刻最多只有一个线程执行管程代码或临界区代码</li>
<li>不同点：正在管程中的线程可临时放弃管程的互斥访问（进入条件变量的等待队列），等待事件出现时恢复；而临界区不支持临时退出</li>
</ul>
<p>（所以其实在管程的概念里面我们已经不谈临界区了？）</p>
<hr>
<p><strong>为什么用管程实现的生产者-消费者问题中，可以在进入管程后才判断缓冲区的状态？</strong></p>
<p>因为管程允许临时放弃管程的互斥访问，而信号量并不支持临时放弃互斥访问权。在具体实现上，在管程内部的条件变量上进行等待时，会将管程的锁作为<code>wait()</code>操作的参数传递过去，此操作会同时放弃锁（返回时又会重新获得锁），因此不会导致死锁。</p>
<hr>
<p><strong>请描述管程条件变量的三种释放处理方式的区别是什么？条件判断中的while和if是如何影响释放处理中的顺序的？</strong></p>
<ul>
<li>Mesa管程：占用管程的当前进程可在任何时刻释放占用资源并唤醒相应的等待进程，当前进程继续执行，被唤醒进程放回入口等待队列队首等待当前进程释放管程访问权</li>
<li>Hoare管程：占用管程的当前进程可在任何时刻释放占用资源并唤醒相应的等待进程，当前进程进入唤醒队列等待，被唤醒进程继续执行直到释放管程访问权；管程空闲时，优先查看唤醒队列中的等待进程，唤醒队列中没有等待进程时再查看入口队列</li>
<li>Hansen管程：占用管程的当前进程只在退出管程时释放占用资源并唤醒相应的等待进程，被唤醒进程继续执行直到释放管程访问权</li>
</ul>
<p>条件判断中while和if对释放处理中的执行顺序影响：</p>
<ul>
<li>在Hansen和Mesa管程中，由于条件变量释放操作signal时并没有立即放弃管程访问权，资源的可用状态可能变化，需使用while()进行重新检查；</li>
<li>在Hoare管程中，由于条件变量释放操作signal同时表示立即放弃管程访问权，资源的可用状态保持不变，可使用if判断，不需要再次检查。</li>
</ul>
<p>Ref: <a href="https://piazza.com/class/i5j09fnsl7k5x0?cid=894" target="_blank" rel="noopener">https://piazza.com/class/i5j09fnsl7k5x0?cid=894</a></p>
<p>Ref: <a href="https://www.andrew.cmu.edu/course/15-440-kesden/applications/ln/lecture6.html" target="_blank" rel="noopener">https://www.andrew.cmu.edu/course/15-440-kesden/applications/ln/lecture6.html</a></p>
<p>（不过在上述Piazza帖子中也有人提出了这样的问题：Hansen管程似乎是直接把访问权转移给了等待进程，这样还需要使用if来判断吗？）</p>
<hr>
<p><strong>哲学家就餐问题的方案2和方案3的性能有什么区别？</strong></p>
<ul>
<li>方案2中，最多只有一个哲学家在吃饭</li>
<li>方案3中，最多可以有两个哲学家在同时吃饭</li>
</ul>
<hr>
<p><strong>在读者-写者问题的读者优先和写者优先在行为上有什么不同？</strong></p>
<ul>
<li>读者优先策略：
<ul>
<li>只要有读者正在读状态，后来的读者就能直接进入</li>
<li>如果读者不断进入，则写者就处于饥饿</li>
</ul>
</li>
<li>写者优先策略
<ul>
<li>只要有写者就绪，写者应尽快执行写操作（后来的读者需要阻塞）</li>
<li>如果写者持续不断就绪，则读者就处于饥饿</li>
</ul>
</li>
</ul>
<hr>
<p><strong>在读者-写者问题的读者优先实现中优先于读者到达的写者在什么地方等待？</strong></p>
<p>互斥信号<code>WriteMutex</code>。因为这是控制读写互斥访问的锁。</p>
<h3 id="实践题"><a class="markdownIt-Anchor" href="#实践题"></a> 实践题</h3>
<p><strong>请用管程with条件变量来实现信号量。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class Semaphore &#123;</span><br><span class="line">    Lock lock;  // 管程的锁</span><br><span class="line">    int count;  // 剩余可用资源个数</span><br><span class="line">    Condition isEmpty;  // 表示是否有可用资源的事件的条件变量</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Semaphore::Semaphore(int numRes) &#123;</span><br><span class="line">    count = numRes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Semaphore::P() &#123;</span><br><span class="line">    lock.acquire();</span><br><span class="line">    while (count == 0)</span><br><span class="line">        isEmpty.wait(&amp;lock);</span><br><span class="line">    count--;</span><br><span class="line">    lock.release();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Semaphore::V() &#123;</span><br><span class="line">    lock.acquire();</span><br><span class="line">    count++;</span><br><span class="line">    isEmpty.signal();</span><br><span class="line">    lock.release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>考虑到可能是Mesa语义的管程，因此进行了<code>while</code>检查。参考了这个<a href="https://piazza.com/class/i5j09fnsl7k5x0?cid=845" target="_blank" rel="noopener">Piazza</a>帖子，我认为上述实现可以满足：</p>
<ul>
<li>在任一状态，条件变量的等待队列与信号量的等待队列完全相同</li>
<li>当<code>count != 0</code>时，其含义与信号量中的<code>sem</code>相同，此时条件变量的<code>numWaiting = 0</code></li>
<li>当<code>count = 0</code>时，条件变量的<code>numWaiting</code>等于信号量的<code>sem</code>的相反数（实现保证了count不会为负数）</li>
</ul>
<hr>
<p><strong>请用信号量来实现管程with条件变量。</strong></p>
<p>这个就有一定的难度了。当然，管程的核心是条件变量，其实实现条件变量就可以了。以下内容参考了<a href="https://birrell.org/andrew/papers/ImplementingCVs.pdf" target="_blank" rel="noopener">Implementing Condition Variables with Semaphores</a>这篇文章。</p>
<p>首先用信号量实现一个锁，这是非常容易的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Lock &#123;</span><br><span class="line">    Semaphore sm;</span><br><span class="line">    public Lock() &#123; // constructor</span><br><span class="line">        sm = new Semaphore(); sm.count =1; sm.limit = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    public void Acquire() &#123; sm.P(); &#125;</span><br><span class="line">    public void Release() &#123; sm.V(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面给出一种非常简单但是也非常错误的实现。该实现的显而易见的问题是，wait操作中对锁的释放和当前线程的睡眠不是原子的。然后好像会出现一个叫做“wake-up waiting race”的问题，不过此处好像并不会发生错误。以及，即使在没有线程正在等待时，signal操作也会使得信号量的值增加，这样，下一个等待进程就不会阻塞了，这是不正确的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class CV &#123;</span><br><span class="line">    Semaphore s;</span><br><span class="line">    public CV() &#123; // Constructor</span><br><span class="line">        s = new Semaphore();</span><br><span class="line">        s.count = 0;</span><br><span class="line">        s.limit = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    public void Wait(Lock m) &#123; // Pre-condition: this thread holds “m”</span><br><span class="line">        m.Release();</span><br><span class="line">        s.P();</span><br><span class="line">        m.Acquire();</span><br><span class="line">    &#125;</span><br><span class="line">    public void Signal() &#123;</span><br><span class="line">        s.V();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是我们用信号量x作为互斥锁来保护wait操作，同时统计等待进程的个数。但这个实现也有两个问题：</p>
<ul>
<li>由于s信号量的资源个数为1，因此最多只有一个调用wait的进程能够从s.P中返回，其余的都阻塞在s.P上；解决方法是把s的资源个数调到无限大</li>
<li>没有保证先进先出的语义</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">class CV &#123;</span><br><span class="line">    Semaphore s, x;</span><br><span class="line">    int waiters = 0;</span><br><span class="line">    public CV() &#123; // Constructor</span><br><span class="line">        s = new Semaphore(); s.count = 0; s.limit = 1;</span><br><span class="line">        x = new Semaphore(); x.count = 1; x.limit = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    public void Wait(Lock m) &#123; // Pre-condition: this thread holds “m”</span><br><span class="line">        x.P();</span><br><span class="line">        waiters++;</span><br><span class="line">        x.V();</span><br><span class="line">        m.Release();</span><br><span class="line">        s.P();</span><br><span class="line">        m.Acquire();</span><br><span class="line">    &#125;</span><br><span class="line">    public void Signal() &#123;</span><br><span class="line">        x.P();</span><br><span class="line">        if (waiters &gt; 0) &#123;</span><br><span class="line">            waiters--;</span><br><span class="line">            s.V();</span><br><span class="line">        &#125;</span><br><span class="line">        x.V();</span><br><span class="line">    &#125;</span><br><span class="line">    public void Broadcast() &#123;</span><br><span class="line">        x.P();</span><br><span class="line">        while (waiters &gt; 0) &#123;</span><br><span class="line">            waiters--;</span><br><span class="line">            s.V();</span><br><span class="line">        &#125;</span><br><span class="line">        x.V();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下一种实现中，加入了信号量h，它会使发出信号的线程在等待线程离开等待队列之前也阻塞。这个实现是正确的，但是似乎太麻烦了。论文最后表示，他们决定还是在OS中用硬件指令来实现条件变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">class CV &#123;</span><br><span class="line">    Semaphore s, x;</span><br><span class="line">    int waiters = 0;</span><br><span class="line">    Semaphore h;</span><br><span class="line">    public CV() &#123; // Constructor</span><br><span class="line">        this.m = m;</span><br><span class="line">        s = new Semaphore(); s.count = 0; s.limit = 999999;</span><br><span class="line">        x = new Semaphore(); x.count = 1; x.limit = 1;</span><br><span class="line">        h = new Semaphore(); h.count = 0; h.limit = 999999;</span><br><span class="line">    &#125;</span><br><span class="line">    public void Wait(Lock m) &#123; // Pre-condition: this thread holds “m”</span><br><span class="line">        x.P();</span><br><span class="line">        waiters++;</span><br><span class="line">        x.V();</span><br><span class="line">        m.Release();</span><br><span class="line">        s.P();</span><br><span class="line">        h.V();</span><br><span class="line">        m.Acquire();</span><br><span class="line">    &#125;</span><br><span class="line">    public void Signal() &#123;</span><br><span class="line">        x.P();</span><br><span class="line">        if (waiters &gt; 0) &#123;</span><br><span class="line">            waiters--;</span><br><span class="line">            s.V();</span><br><span class="line">            h.P();</span><br><span class="line">        &#125;</span><br><span class="line">        x.V();</span><br><span class="line">    &#125;</span><br><span class="line">    public void Broadcast() &#123;</span><br><span class="line">        x.P();</span><br><span class="line">        for (int i = 0; i &lt; waiters; i++)</span><br><span class="line">            s.V();</span><br><span class="line">        while (waiters &gt; 0) &#123;</span><br><span class="line">            waiters--;</span><br><span class="line">            h.P();</span><br><span class="line">        &#125;</span><br><span class="line">        x.V();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>请评价如下的实现(用信号量来实现管程with条件变量)是否合理？简要说明理由。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">Implementing a Monitor</span><br><span class="line"></span><br><span class="line">CONTROL VARIABLES:</span><br><span class="line"></span><br><span class="line">	mutex: semaphore, initial value 1 (FREE)</span><br><span class="line">	next: record, with 2 fields:</span><br><span class="line">		next.sem: semaphore, initial value 0</span><br><span class="line">		next.count: counter, initial value 0</span><br><span class="line"></span><br><span class="line">	FOR EACH CONDITION x:</span><br><span class="line"></span><br><span class="line">	x: record, with 2 fields:</span><br><span class="line">		x.sem: semaphore, initial value 0</span><br><span class="line">		x.count: counter, initial value 0</span><br><span class="line">ENTRY PROTOCOL (at the beginning of each monitor function):</span><br><span class="line"></span><br><span class="line">	/* wait for exclusive access to the monitor */</span><br><span class="line">	P(mutex);</span><br><span class="line">EXIT PROTOCOL (at the end of each monitor function):</span><br><span class="line"></span><br><span class="line">	/* if there are processes in the &quot;next&quot; queue, release one */</span><br><span class="line">	if (next.count &gt; 0) V(next.sem);</span><br><span class="line"></span><br><span class="line">	/* otherwise, release the monitor */</span><br><span class="line">	else V(mutex);</span><br><span class="line">WAIT ON CONDITION x (x.wait):</span><br><span class="line"></span><br><span class="line">	/* first perform the exit protocol */</span><br><span class="line">	if (next.count &gt; 0) V(next.sem);</span><br><span class="line">	else V(mutex);</span><br><span class="line"></span><br><span class="line">	/* now wait on the condition queue */</span><br><span class="line">	x.count++;</span><br><span class="line">	P(x.sem);</span><br><span class="line">	x.count--;</span><br><span class="line">SIGNAL CONDITION x (x.signal):</span><br><span class="line"></span><br><span class="line">	/* do nothing unless a process is waiting */</span><br><span class="line">	if (x.count &gt; 0) &#123;</span><br><span class="line"></span><br><span class="line">		/* release the next waiting process */</span><br><span class="line">		V(x.sem);</span><br><span class="line"></span><br><span class="line">		/* wait on the &quot;next&quot; queue */</span><br><span class="line">		next.count++;</span><br><span class="line">		P(next.sem);</span><br><span class="line">		next.count--;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>每人使用C++或python语言用信号量和条件变量两种手段分别实现<a href="https://github.com/chyyuu/os_course_exercises/blob/2018spring/all/07-2-spoc-pv-problems.md" target="_blank" rel="noopener">40个同步互斥问题</a>中的一题。请先理解<a href="https://github.com/chyyuu/ucore_os_lab/tree/master/related_info/lab7/semaphore_condition" target="_blank" rel="noopener">python threading 机制的介绍和实例</a></strong></p>
<p>参考：<a href="https://piazza.com/class/i5j09fnsl7k5x0?cid=391" target="_blank" rel="noopener">2015年操作系统课的信号量问题回答</a></p>
<p>建议参考梁锡豪同学的输出信息显示方式，这种方式的可读性很好。</p>
<p>建议重视测试用例的设计，以检查自己的实现是否有错。</p>
<hr>
<p><strong>设计某个方法，能够动态检查出对于两个或多个进程的同步互斥问题执行中，没有互斥问题，能够同步等，以说明实现的正确性。</strong></p>
<hr>
<p><strong>管程和信号量在解决同步互斥问题上是否等价？请证明/说明你的结论．</strong></p>
<p>Piazza上有两个非常优秀的讨论：</p>
<ul>
<li><a href="https://piazza.com/class/i5j09fnsl7k5x0?cid=845" target="_blank" rel="noopener">https://piazza.com/class/i5j09fnsl7k5x0?cid=845</a>：阐述了信号量和条件变量在具体实现和操作层面的异同</li>
<li><a href="https://piazza.com/class/i5j09fnsl7k5x0?cid=839" target="_blank" rel="noopener">https://piazza.com/class/i5j09fnsl7k5x0?cid=839</a>：对信号量和条件变量抽象的理解</li>
</ul>
<p>简单来说，就是：信号量可以实现管程，管程可以实现信号量，所以在这个层面，二者等价。</p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/OS/"><i class="fas fa-hashtag fa-fw"></i>OS</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/post/os-mooc-lecture-22-summary/">
              
                  《操作系统》第22讲：“实验8-文件系统”总结
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://zhanghuimeng.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            张慕晖
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2018-05-24
          </a>
        </div>
      
      
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="课程内容概述"><a class="markdownIt-Anchor" href="#课程内容概述"></a> 课程内容概述</h2>
<p>本讲介绍了ucore中的文件系统。</p>
<p>TODO</p>
<h2 id="练习"><a class="markdownIt-Anchor" href="#练习"></a> 练习</h2>
<p>来自<a href="https://github.com/chyyuu/os_course_exercises/blob/2018spring/all/09-2-lab8-quiz.md" target="_blank" rel="noopener">lec22 lab8 文件系统 在线练习</a>和<a href="https://github.com/chyyuu/os_course_exercises/blob/2018spring/all/09-2-lab8-spoc-discussion.md" target="_blank" rel="noopener">lab8 文件系统 (lec 22) spoc 思考题</a>。</p>
<h3 id="选择填空题"><a class="markdownIt-Anchor" href="#选择填空题"></a> 选择填空题</h3>
<p><strong>ucore实现的文件系统抽象包括（）</strong></p>
<ul>
<li><strong>文件</strong></li>
<li><strong>目录项</strong></li>
<li><strong>索引节点</strong></li>
<li><strong>安装点</strong></li>
</ul>
<p>我猜这里主要说的是VFS文件系统中的内容。</p>
<ul>
<li><code>struct file</code>：应用程序能够看到的各种文件信息</li>
<li><code>struct inode</code>：映射到特定文件系统的inode</li>
<li><code>struct fs</code>：保存了具体文件系统的结构、类型和信息</li>
</ul>
<p>然后安装点是个啥我也不知道。</p>
<blockquote>
<p>安装点是一个目录或文件，可在该处访问新文件系统、目录或文件。要安装文件系统或目录，安装点必须为一个目录；要安装文件，那么安装点必须为文件。（<a href="https://www.ibm.com/support/knowledgecenter/zh/ssw_aix_72/com.ibm.aix.osdevice/mountpoint.htm" target="_blank" rel="noopener">https://www.ibm.com/support/knowledgecenter/zh/ssw_aix_72/com.ibm.aix.osdevice/mountpoint.htm</a>）</p>
</blockquote>
<hr>
<p><strong>ucore实现的simple FS（简称SFS）采用的文件分配机制是（）</strong></p>
<ul>
<li>连续分配</li>
<li>链式分配</li>
<li><strong>索引分配</strong></li>
<li>位图分配</li>
</ul>
<p>SFS使用的是一级索引。</p>
<p>索引分配的定义：为每个文件创建一个索引数据块，指向文件数据块的指针列表；文件头包含了索引数据块指针。</p>
<hr>
<p><strong>关于ucore实现的SFS阐述正确的是（）</strong></p>
<ul>
<li><strong>SFS的超级块保存在硬盘上，在加载simple FS时会读入内存中</strong></li>
<li><strong>SFS的free map结构保存在硬盘上，表示硬盘可用的数据块（扇区）</strong></li>
<li><strong>SFS的root-dir inode结构保存在硬盘上，表示SFS的根目录的元数据信息</strong></li>
<li>硬盘上的SFS ，除保存上述三种结构外，剩下的都用于保存文件的数据内容</li>
</ul>
<p>除了前三种结构，剩下的用于保存文件的inode, dir/file的data。</p>
<hr>
<p><strong>关于ucore实现的Virtual FS（简称VFS）阐述正确的是()</strong></p>
<ul>
<li><strong>已支持磁盘文件系统</strong></li>
<li><strong>已支持设备文件系统</strong></li>
<li>已支持网络文件系统</li>
<li>已支持系统状态文件系统</li>
</ul>
<blockquote>
<p>后两种可实现，但现在还没实现</p>
</blockquote>
<p>哈哈哈哈哈哈……</p>
<hr>
<p><strong>关于ucore文件系统支持的I/O设备包括()</strong></p>
<ul>
<li><strong>串口设备</strong></li>
<li><strong>并口设备</strong></li>
<li><strong>CGA设备</strong></li>
<li><strong>键盘设备</strong></li>
</ul>
<p>总之这些都支持。不过好像从Lab1就有了。</p>
<h3 id="简答题"><a class="markdownIt-Anchor" href="#简答题"></a> 简答题</h3>
<p><strong>与文件系统相关的系统调用接口、虚拟文件系统VFS、简单文件系统SFS和设备I/O等四个部分各实现什么功能？</strong></p>
<ul>
<li>系统调用接口：向应用进程提供文件访问的系统调用</li>
<li>虚拟文件系统VFS：屏蔽具体文件系统差异，对上提供一个统一的文件系统访问接口</li>
<li>简单文件系统SFS：解析和读写磁盘数据块中具体的SFS文件系统存储结构</li>
<li>设备I/O：完成实际磁盘设备上数据块的访问</li>
</ul>
<hr>
<p><strong>文件系统中的文件、目录、索引节点(inode)和安装点(挂载点)这几种数据结构分别支持些什么操作？</strong></p>
<ul>
<li>文件：open/close, read/write</li>
<li>目录：open/close, read</li>
<li>索引节点：lookup, read/write</li>
<li>挂载点：mount/unmount</li>
</ul>
<hr>
<p><strong>请简要阐述ucore文件系统架构的四个组成部分。</strong></p>
<ul>
<li>系统调用接口：用户应用使用封装后的libc库函数，文件访问的libc库函数利用文件访问系统调用来实现</li>
<li>VFS：内核的系统调用（文件、目录接口）会转换成对VFS抽象的文件访问接口（索引节点、文件卷、设备等接口）的调用，VFS再把抽象的VFS接口转换成具体的文件系统SFS的访问接口</li>
<li>SFS：对具体文件系统存储结构进行解析，把SFS对接口（索引节点、文件卷、设备等接口）的访问请求转换成设备数据块的访问</li>
<li>I/O接口：不同具体设备上的数据块访问控制</li>
</ul>
<hr>
<p><strong>请简要说明进程proc_struct、文件file、inode之间的关系。</strong></p>
<ul>
<li>进程控制块数据结构<code>proc_struct</code>中，<code>struct files_struct *filesp</code>指向进程的打开文件表</li>
<li>进程打开文件表中<code>struct file *file</code>指向系统打开文件中的相应文件状态数据</li>
<li>VFS中的系统打开文件表中<code>struct inode *inode</code>维护打开文件的状态信息，并最终对应到磁盘上的存储数据块</li>
</ul>
<hr>
<p><strong>ucore中的进程打开文件表和系统打开文件表对应到具体的哪个数据结构上？</strong></p>
<ul>
<li>进程打开文件表：<code>proc_struct</code>中的<code>struct files_struct *filesp</code></li>
<li>系统打开文件表：不知道</li>
</ul>
<hr>
<p><strong>SFS在硬盘上的四大部分主要是什么，有何作用？</strong></p>
<ul>
<li>superblock：数据块大小、文件卷名字等文件卷信息</li>
<li>root-dir inode：根目录的inode信息（存储位置等）</li>
<li>freemap：数据块占用状态信息</li>
<li>data block：inode/文件数据/目录数据</li>
</ul>
<hr>
<p><strong>硬盘上的SFS是如何加载到ucore中并初始化的？</strong></p>
<p>ucore docs Lab8：</p>
<blockquote>
<p>在<code>sfs_fs.c</code>文件中的<code>sfs_do_mount</code>函数中，完成了加载位于硬盘上的SFS文件系统的超级块superblock和freemap的工作。这样，在内存中就有了SFS文件系统的全局信息。</p>
</blockquote>
<hr>
<p><strong>硬盘上的inode和内存中的inode的关系和区别是什么？</strong></p>
<p>内存中的inode数据结构sfs_inode中有一个字段sfs_disk_inode，它对应磁盘上的inode。</p>
<p>ucore docs Lab8：</p>
<blockquote>
<p>SFS中的磁盘索引节点代表了一个实际位于磁盘上的文件。<br>
……<br>
可以看到SFS中的内存inode包含了SFS的硬盘inode信息，而且还增加了其他一些信息，这属于是便于进行是判断否改写、互斥操作、回收和快速地定位等作用。需要注意，一个内存inode是在打开一个文件后才创建的，如果关机则相关信息都会消失。而硬盘inode的内容是保存在硬盘中的，只是在进程需要时才被读入到内存中，用于访问文件或目录的具体内容数据</p>
</blockquote>
<hr>
<p><strong>描述file, dir, inode在内存和磁盘上的格式和相关操作。</strong></p>
<p>每一种类型的数据块都在SFS层中有对应的操作函数指针和数据结构定义。</p>
<p>事实上，file、dir和inode在内存和磁盘上都以inode形式存储：</p>
<ul>
<li>内存：<code>struct sfs_disk_inode</code></li>
<li>磁盘：inode</li>
</ul>
<blockquote>
<p>通过上表可以看出，如果inode表示的是文件，则成员变量direct[]直接指向了保存文件内容数据的数据块索引值。indirect间接指向了保存文件内容数据的数据块，indirect指向的是间接数据块（indirect block），此数据块实际存放的全部是数据块索引，这些数据块索引指向的数据块才被用来存放文件内容数据。<br>
对于普通文件，索引值指向的block中保存的是文件中的数据。而对于目录，索引值指向的数据保存的是目录下所有的文件名以及对应的索引节点所在的索引块（磁盘块）所形成的数组。</p>
</blockquote>
<hr>
<p><strong>file数据结构的主要内容是什么？与进程的关系是什么？</strong></p>
<p><code>struct file</code>数据结构定义在<code>lab8/kern/fs/file.h</code>中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct file &#123;</span><br><span class="line">    enum &#123;</span><br><span class="line">        FD_NONE, FD_INIT, FD_OPENED, FD_CLOSED,</span><br><span class="line">    &#125; status;</span><br><span class="line">    bool readable;</span><br><span class="line">    bool writable;</span><br><span class="line">    int fd;</span><br><span class="line">    off_t pos;</span><br><span class="line">    struct inode *node;</span><br><span class="line">    int open_count;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>struct file</code>数据结构的内容包括：</p>
<ul>
<li><code>status</code>：文件状态</li>
<li><code>bool readable &amp; writable</code>：文件操作类型</li>
<li><code>int fd</code>：文件描述符</li>
<li><code>off_t pos</code>：文件指针</li>
<li><code>struct inode *node</code>：对应系统打开文件表项指针</li>
<li><code>int open_count</code>：文件打开计数</li>
</ul>
<p><code>struct file</code>就是进程打开文件表对应的数据结构。</p>
<hr>
<p><strong>inode数据结构的主要内容是什么？与file的数据结构的关系是什么？</strong></p>
<p><code>struct inode</code>数据结构定义在<code>lab8/kern/fs/vfs/inode.h</code>中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct inode &#123;</span><br><span class="line">    union &#123;</span><br><span class="line">        struct device __device_info;</span><br><span class="line">        struct sfs_inode __sfs_inode_info;</span><br><span class="line">    &#125; in_info;</span><br><span class="line">    enum &#123;</span><br><span class="line">        inode_type_device_info = 0x1234,</span><br><span class="line">        inode_type_sfs_inode_info,</span><br><span class="line">    &#125; in_type;</span><br><span class="line">    int ref_count;</span><br><span class="line">    int open_count;</span><br><span class="line">    struct fs *in_fs;</span><br><span class="line">    const struct inode_ops *in_ops;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>struct inode</code>数据结构的内容：</p>
<ul>
<li><code>in_info &amp; in_type</code>：文件类型</li>
<li><code>ref_count &amp; open_count</code>：引用计数</li>
<li><code>struct fs *in_fs</code>：对下具体文件操作函数指针</li>
<li><code>const struct inode_ops *in_ops</code>：对上inode操作函数指针</li>
</ul>
<p><code>struct inode</code>就是系统打开文件表对应的数据结构。</p>
<hr>
<p><strong>inode_ops包含哪些与文件相关的操作？</strong></p>
<p><code>struct inode_ops</code>数据结构定义在<code>lab8/kern/fs/vfs/inode.h</code>中，它是上层使用的inode操作函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">struct inode_ops &#123;</span><br><span class="line">    unsigned long vop_magic;</span><br><span class="line">    int (*vop_open)(struct inode *node, uint32_t open_flags);</span><br><span class="line">    int (*vop_close)(struct inode *node);</span><br><span class="line">    int (*vop_read)(struct inode *node, struct iobuf *iob);</span><br><span class="line">    int (*vop_write)(struct inode *node, struct iobuf *iob);</span><br><span class="line">    int (*vop_fstat)(struct inode *node, struct stat *stat);</span><br><span class="line">    int (*vop_fsync)(struct inode *node);</span><br><span class="line">    int (*vop_namefile)(struct inode *node, struct iobuf *iob);</span><br><span class="line">    int (*vop_getdirentry)(struct inode *node, struct iobuf *iob);</span><br><span class="line">    int (*vop_reclaim)(struct inode *node);</span><br><span class="line">    int (*vop_gettype)(struct inode *node, uint32_t *type_store);</span><br><span class="line">    int (*vop_tryseek)(struct inode *node, off_t pos);</span><br><span class="line">    int (*vop_truncate)(struct inode *node, off_t len);</span><br><span class="line">    int (*vop_create)(struct inode *node, const char *name, bool excl, struct inode **node_store);</span><br><span class="line">    int (*vop_lookup)(struct inode *node, char *path, struct inode **node_store);</span><br><span class="line">    int (*vop_ioctl)(struct inode *node, int op, void *data);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>文件中有每个操作的详细注释</p>
<ul>
<li>open：打开文件</li>
<li>close：关闭文件</li>
<li>read：读文件</li>
<li>write：写文件</li>
<li>fstat：读文件信息</li>
<li>fsync：将脏缓存写回持久化存储介质</li>
<li>namefile：计算文件相对于文件系统根目录的路径</li>
<li>getdirentry：从目录中读一个文件名</li>
<li>reclaim：回收inode</li>
<li>gettype：文件种类</li>
<li>tryseek：检查移动文件指针是否合法</li>
<li>truncate：重设文件大小，丢弃多余的数据</li>
<li>create：在目录中新建文件</li>
<li>lookup：在给定目录中按文件名查找文件</li>
<li>ioctl：管理I/O通道（？？）</li>
</ul>
<hr>
<p><strong>VFS是如何把键盘、显示输出和磁盘文件统一到一个系统调用访问框架下的？</strong></p>
<ul>
<li>VFS把键盘、显示和磁盘文件都视为文件，VFS对上提供的访问接口都是文件访问接口</li>
<li>VFS通过区别文件类型、文件操作类型、设备类型等来区别同类操作在不同设备的不同实现</li>
</ul>
<hr>
<p><strong>device数据结构的主要内容是什么？与fs的关系是什么？与inode的关系是什么？</strong></p>
<p>这里的<code>device</code>指的应该是<code>lab8/kern/fs/devs/dev.h</code>中定义的<code>struct device</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Filesystem-namespace-accessible device.</span><br><span class="line"> * d_io is for both reads and writes; the iobuf will indicates the direction.</span><br><span class="line"> */</span><br><span class="line">struct device &#123;</span><br><span class="line">    size_t d_blocks;</span><br><span class="line">    size_t d_blocksize;</span><br><span class="line">    int (*d_open)(struct device *dev, uint32_t open_flags);</span><br><span class="line">    int (*d_close)(struct device *dev);</span><br><span class="line">    int (*d_io)(struct device *dev, struct iobuf *iob, bool write);</span><br><span class="line">    int (*d_ioctl)(struct device *dev, int op, void *data);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>struct device</code>数据结构的内容：</p>
<ul>
<li><code>size_t d_blocks</code>：数据块个数</li>
<li><code>size_t d_blocksize</code>：数据块大小</li>
<li>设备操作函数指针（<code>d_open</code>, <code>d_close</code>, <code>d_io</code>, <code>d_ioctl</code>）</li>
</ul>
<p>fs和inode通过device数据结构中的设备操作函数指针实现对设备数据块的访问。</p>
<hr>
<p><strong>比较ucore中I/O接口、SFS文件系统接口和文件系统的系统调用接口的操作函数有什么异同？</strong></p>
<ul>
<li>文件系统的系统调用接口（<code>lab8/kern/syscall/syscall.c</code>）：sys_open, sys_close, sys_read, sys_write, sys_seek, sys_fstat, sys_fsync, sys_chdir, sys_getcwd, sys_mkdir, sys_link, sys_rename, sys_unlink, sys_getdirentry, sys_dup, sys_pipe, sys_mkfifo, sys_mount, sys_umount, sys_ioctl</li>
<li>VFS文件系统接口（<code>lab8/kern/vfs/vfs.h</code>）：vfs_open, vfs_close, vfs_link, vfs_symlink, vfs_readlink, vfs_mkdir, vfs_unlink, vfs_rename, vfs_chdir, vfs_getcwd</li>
<li>SFS文件系统接口（<code>lab8/kern/sfs/sfs.h</code>）：sfs_rblock, sfs_wblock, sfs_rbuf, sfs_wbuf, sfs_sync_super, sfs_sync_freemap, sfs_clear_block, sfs_load_inode</li>
<li>I/O接口（<code>lab8/kern/devs/dev.h</code>）：d_open, d_close, d_io, d_ioctl</li>
</ul>
<h3 id="实践题"><a class="markdownIt-Anchor" href="#实践题"></a> 实践题</h3>
<p><strong>理解文件访问的执行过程，即在ucore运行过程中通过<code>cprintf</code>函数来完整地展现出来读一个文件在ucore中的整个执行过程，(越全面细致越好) 完成代码填写，并形成spoc练习报告，需写练习报告和简单编码，完成后放到git server 对应的git repo中。</strong></p>
<p>啊，这个完全没有时间去写了……</p>
<hr>
<p><strong>在下面的实验代码的基础上，实现基于文件系统的pipe IPC机制。练习用的<a href="https://github.com/chyyuu/ucore_lab/tree/master/labcodes_answer/lab8_result" target="_blank" rel="noopener">lab8 spoc exercise project source code</a></strong></p>
<p>呃，这是lab8的附加题……</p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/OS/"><i class="fas fa-hashtag fa-fw"></i>OS</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/post/os-mooc-lecture-23-summary/">
              
                  《操作系统》第23讲：“I/O子系统”总结
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://zhanghuimeng.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            张慕晖
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            2018-05-24
          </a>
        </div>
      
      
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="课程内容概述"><a class="markdownIt-Anchor" href="#课程内容概述"></a> 课程内容概述</h2>
<ul>
<li>常见设备I/O接口</li>
<li>进程的I/O方法</li>
<li>CPU与设备之间的I/O方法
<ul>
<li>连接方法</li>
<li>传输方法</li>
<li>通知方法</li>
</ul>
</li>
<li>I/O请求生存周期</li>
<li>一类具体的I/O设备：磁盘
<ul>
<li>磁盘的工作机制和传输时间</li>
<li>磁盘调度算法</li>
<li>磁盘缓存</li>
</ul>
</li>
</ul>
<h3 id="常见设备io接口"><a class="markdownIt-Anchor" href="#常见设备io接口"></a> 常见设备I/O接口</h3>
<p>常见的接口分为三类。</p>
<table>
<thead>
<tr>
<th>设备接口类型</th>
<th>例子</th>
<th>访问特征</th>
<th>I/O命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>字符设备</td>
<td>键盘、鼠标、串口</td>
<td>以字节为单位顺序访问</td>
<td>文件访问接口</td>
</tr>
<tr>
<td>块设备</td>
<td>磁盘驱动器、磁带驱动器、光驱</td>
<td>均匀的数据块访问</td>
<td>文件系统接口、内存映射</td>
</tr>
<tr>
<td>网络设备</td>
<td>以太网、无线、蓝牙</td>
<td>格式化报文交换</td>
<td>网络报文、网络协议</td>
</tr>
</tbody>
</table>
<h3 id="进程的io方法"><a class="markdownIt-Anchor" href="#进程的io方法"></a> 进程的I/O方法</h3>
<p>从进程的角度来看，I/O方法分为三种类型。</p>
<table>
<thead>
<tr>
<th>I/O类型</th>
<th>特点</th>
<th>读写方法</th>
<th>图示</th>
</tr>
</thead>
<tbody>
<tr>
<td>阻塞I/O</td>
<td>Wait</td>
<td>读写时，进程将进入等待状态，直到设备完成数据处理</td>
<td><img src="block-io.png" alt></td>
</tr>
<tr>
<td>非阻塞I/O</td>
<td>Don’t Wait</td>
<td>读写时立即从read或write系统调用返回，返回值为成功传输字节数；可能不成功</td>
<td><img src="unblock-io.png" alt></td>
</tr>
<tr>
<td>异步I/O</td>
<td>Tell Me Later</td>
<td>读写数据时，使用指针标记好用户缓冲区，立即返回；稍后内核将填充缓冲区/处理数据并通知用户</td>
<td><img src="async-io.png" alt></td>
</tr>
</tbody>
</table>
<h3 id="cpu与设备之间的io方法"><a class="markdownIt-Anchor" href="#cpu与设备之间的io方法"></a> CPU与设备之间的I/O方法</h3>
<p><img src="kernel-io-structure.png" alt="内核I/O结构"></p>
<p>内核通过I/O子系统控制各种硬件。</p>
<h4 id="连接方法"><a class="markdownIt-Anchor" href="#连接方法"></a> 连接方法</h4>
<p>一般来说，北桥芯片连接的是高速I/O设备，如内存和显卡；南桥芯片连接的是普通I/O设备，如磁盘和网络。</p>
<p>设备上的设备控制器是CPU和I/O设备间的接口，它向CPU提供特殊指令和寄存器，也就是CPU用来控制I/O设备的I/O地址，分为两种：</p>
<ul>
<li>I/O指令：通过I/O端口号访问设备寄存器</li>
<li>内存映射I/O：设备的寄存器/存储空间被映射到内存物理地址空间中，通过内存load/store指令完成I/O操作</li>
</ul>
<h4 id="传输方法"><a class="markdownIt-Anchor" href="#传输方法"></a> 传输方法</h4>
<p>CPU与设备控制器之间的数据传输分为两种方式：</p>
<ul>
<li>程序控制I/O（PIO，Programmed I/O）
<ul>
<li>通过CPU的in/out或者load/store传输所有数据（内存映射）
<ul>
<li>特点：</li>
<li>硬件简单，编程容易</li>
<li>消耗的CPU时间和数据量成正比</li>
</ul>
</li>
<li>适用于简单的、小型的设备I/O</li>
</ul>
</li>
<li>直接内存访问（DMA）
<ul>
<li>设备控制器可直接访问系统总线</li>
<li>控制器直接与内存互相传输数据</li>
<li>特点：
<ul>
<li>设备传输数据不影响CPU</li>
<li>需要CPU参与设置（这是必然的）</li>
<li>适用于高吞吐量I/O</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="通过dma读取磁盘数据的例子"><a class="markdownIt-Anchor" href="#通过dma读取磁盘数据的例子"></a> 通过DMA读取磁盘数据的例子</h5>
<p><img src="dma-read-disk-data.png" alt></p>
<p>具体步骤如下：</p>
<ol>
<li>设备驱动收到读取磁盘数据到内存地址X的请求</li>
<li>设备驱动控制磁盘控制器从磁盘读取数据</li>
<li>磁盘控制器初始化DMA传送</li>
<li>磁盘控制器传送数据到DMA控制器</li>
<li>DMA控制器传送C字节数据到内存地址X</li>
<li>DMA控制器完成数据传送后，产生中断请求，通知CPU传送完成</li>
</ol>
<h4 id="通知方法"><a class="markdownIt-Anchor" href="#通知方法"></a> 通知方法</h4>
<p>设备通知CPU（I/O操作完成时间、I/O操作是否发生错误、设备状态等）主要分为两种方式：</p>
<ul>
<li>CPU主动轮询</li>
<li>设备中断</li>
</ul>
<h5 id="轮询"><a class="markdownIt-Anchor" href="#轮询"></a> 轮询</h5>
<p>处理流程：</p>
<ul>
<li>I/O设备在特定的状态寄存器中放置状态和错误信息</li>
<li>操作系统定期检测状态寄存器</li>
</ul>
<p>特点：</p>
<ul>
<li>简单</li>
<li>I/O操作频繁或不可预测时，开销大和延时长</li>
</ul>
<h5 id="设备中断"><a class="markdownIt-Anchor" href="#设备中断"></a> 设备中断</h5>
<p>处理流程：</p>
<ul>
<li>CPU在I/O之前设置任务参数</li>
<li>CPU在发出I/O请求后，继续执行其他任务</li>
<li>I/O设备处理I/O请求</li>
<li>I/O设备处理完成时，触发CPU中断请求</li>
<li>CPU接收中断，分发到相应中断处理例程</li>
</ul>
<p><img src="device-interrupt-io.png" alt="设备中断I/O处理流程图示"></p>
<p>特点：</p>
<ul>
<li>处理不可预测事件效果好（CPU在每两条指令中间处理一次中断请求）</li>
<li>开销相对较高</li>
</ul>
<h3 id="io请求生存周期"><a class="markdownIt-Anchor" href="#io请求生存周期"></a> I/O请求生存周期</h3>
<p><img src="io-request-life-cycle.png" alt="I/O请求生存周期"></p>
<p>显然，这是异步I/O请求。</p>
<h3 id="一类具体的io设备磁盘"><a class="markdownIt-Anchor" href="#一类具体的io设备磁盘"></a> 一类具体的I/O设备：磁盘</h3>
<h4 id="磁盘的工作机制和传输时间"><a class="markdownIt-Anchor" href="#磁盘的工作机制和传输时间"></a> 磁盘的工作机制和传输时间</h4>
<p><img src="disk-structure.png" alt="磁盘的组成"></p>
<p>磁盘的主要组成部分包括：</p>
<ul>
<li>磁盘轴</li>
<li>若干个盘片（围绕磁盘轴旋转）
<ul>
<li>磁道</li>
<li>扇区</li>
</ul>
</li>
<li>磁头（上面有读写头）</li>
</ul>
<p>在读取或写入时，磁头必须被定位在期望的磁道，并从所期望的柱面和扇区开始读写。在这一过程中，花时间最长的是磁头的移动。我们称<strong>寻道时间</strong>为定位到期望的磁道所花费的时间，<strong>旋转延迟</strong>为从0扇区开始处到达目的地花费的时间。一般来说，<strong>平均旋转延迟时间</strong> 是磁盘旋转一周时间的一半。</p>
<p>磁盘I/O传输一般分为以下5个步骤：</p>
<ol>
<li>等待设备可用</li>
<li>等待通道（PIO或DMA通道）可用</li>
<li>寻道</li>
<li>旋转延迟</li>
<li>数据传输</li>
</ol>
<p>后四个步骤被称为“设备忙”状态，所占用的时间一般认为是传输时间，公式为</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>T</mi><mi>a</mi></msub><mo>=</mo><msub><mi>T</mi><mi>s</mi></msub><mo>+</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>r</mi></mrow></mfrac><mo>+</mo><mfrac><mi>b</mi><mrow><mi>r</mi><mi>N</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">T_a = T_s+ \frac{1}{2r} + \frac{b}{rN}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.05744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>公式各个部分的含义：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>T</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">T_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>：传输时间</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>T</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">T_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>：寻道时间（和磁头移动距离有关，花费的时间最多）</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mn>1</mn><mrow><mn>2</mn><mi>r</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{2r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>：旋转延迟（<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mn>1</mn><mi>r</mi></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>=旋转一周的时间）</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mi>b</mi><mrow><mi>r</mi><mi>N</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{b}{rN}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>：传输时间
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span></span></span></span>：传输的比特数</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span>：磁道上的比特数</li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span></span>：磁盘转速</li>
</ul>
</li>
</ul>
<p>显然，最需要优化的是寻道时间。磁盘调度算法解决的就是这一问题。</p>
<h4 id="磁盘调度算法"><a class="markdownIt-Anchor" href="#磁盘调度算法"></a> 磁盘调度算法</h4>
<p>磁盘调度算法的目的：通过优化磁盘访问请求顺序来提高磁盘访问性能</p>
<p>进行磁盘调度的原因：</p>
<ul>
<li>寻道时间是磁盘访问最耗时的部分</li>
<li>同时会有多个在同一磁盘上的I/O请求（所以可以调整顺序）</li>
<li>随机处理磁盘访问请求的性能表现很差</li>
</ul>
<p>下列算法中使用的例子：</p>
<ul>
<li>磁盘访问序列：<code>98, 183, 37, 122, 14, 124, 65, 67</code></li>
<li>初始磁头位置：<code>53</code></li>
</ul>
<table>
<thead>
<tr>
<th>算法名称</th>
<th>做法</th>
<th>特征</th>
<th>例子</th>
<th>移动距离</th>
</tr>
</thead>
<tbody>
<tr>
<td>先进先出（FIFO）算法</td>
<td>按顺序处理请求</td>
<td>能够保证公平；性能较差</td>
<td><code>53-&gt;98-&gt;183-&gt;37-&gt;122-&gt;14-&gt;124-&gt;65-&gt;67</code></td>
<td>640</td>
</tr>
<tr>
<td>最短服务时间优先（SSTF）算法</td>
<td>选择从磁臂当前位置需要移动最少的I/O请求</td>
<td>很不公平</td>
<td><code>53-&gt;65-&gt;67-&gt;14-&gt;98-&gt;122-&gt;124-&gt;183</code></td>
<td>236</td>
</tr>
<tr>
<td>扫描（SCAN）算法</td>
<td>磁臂在一个方向上移动，访问所有未完成的请求，直到磁臂到达该方向上最后的<strong>磁道</strong>；然后调换方向</td>
<td>判断简单；不公平，偏好中间位置磁道</td>
<td><code>53-&gt;37-&gt;14-&gt;0-&gt;65-&gt;67-&gt;98-&gt;122-&gt;124-&gt;183-&gt;199</code></td>
<td>236</td>
</tr>
<tr>
<td>循环扫描（C-SCAN）算法</td>
<td>对SCAN算法的改进：限制仅在一个方向上扫描；当最后一个磁道也被访问过了后，磁臂返回到磁盘的另外一端再次进行</td>
<td>比SCAN算法更公平</td>
<td><code>53-&gt;37-&gt;14-&gt;0-&gt;199-&gt;183-&gt;124-&gt;122-&gt;98-&gt;67-&gt;65</code></td>
<td>386</td>
</tr>
<tr>
<td>C-LOOK算法</td>
<td>对C-SCAN算法的改进：不走到磁盘的头，而是只走到最远的请求</td>
<td>同样能保证公平性</td>
<td><code>53-&gt;37-&gt;14-&gt;183-&gt;124-&gt;122-&gt;98-&gt;67-&gt;65</code></td>
<td>326</td>
</tr>
<tr>
<td>N步扫描（N-step-SCAN）算法</td>
<td>将磁盘请求队列分成长度为N的子队列，按FIFO算法依次处理所有子队列；再用扫描算法处理每个队列</td>
<td>防止磁头粘着现象</td>
<td><code>53-&gt;37-&gt;183-&gt;98-&gt;14-&gt;124-&gt;122-&gt;67-&gt;65</code></td>
<td>500</td>
</tr>
<tr>
<td>双队列扫描（FSCAN）算法</td>
<td>将磁盘请求队列分成两个子队列，交替使用扫描算法处理每一个队列；处理一个队列时，所有新生成的磁盘I/O请求都被放入另一队列中</td>
<td>比N步扫描更简单</td>
<td><code>53-&gt;37-&gt;183-&gt;122-&gt;98-&gt;67-&gt;65-&gt;14-&gt;124</code></td>
<td>441</td>
</tr>
</tbody>
</table>
<p>一些细节：</p>
<ul>
<li>认为SCAN、C-SCAN、C-LOOK和N步扫描算法都是先向低编号移动</li>
<li>N步扫描算法的N为3，使用的是C-LOOK扫描方法</li>
<li>FSCAN算法中假设后四个请求位于下一个队列，使用的也是C-LOOK扫描算法</li>
<li>课件上没有指出C-SCAN算法返回时到底是返回到另外一端还是“另外一端最靠边的请求”。鉴于有C-LOOK的改进，我就认为C-SCAN傻得直接走到另一端了。类似地，我也认为C-LOOK算法反转时只会走到另一端最远的请求，而不是另一端。</li>
</ul>
<h4 id="磁盘缓存"><a class="markdownIt-Anchor" href="#磁盘缓存"></a> 磁盘缓存</h4>
<p><strong>缓存</strong>是数据传输双方访问速度差异较大时，引入的速度匹配中间层。<strong>磁盘缓存</strong> 是磁盘扇区在内存中的缓冲区。磁盘缓存的调度算法很类似虚拟存储调度算法（不过倒了过来，虚拟存储是把内存缓存到磁盘，磁盘缓存是把磁盘缓存到内存==）。</p>
<h5 id="单缓存与双缓存"><a class="markdownIt-Anchor" href="#单缓存与双缓存"></a> 单缓存与双缓存</h5>
<p>根据缓冲区个数分类：</p>
<ul>
<li>单缓存（Single Buffer Cache）：I/O设备写入时，CPU不能进行读操作（类似生产者-消费者问题）</li>
<li>双缓存（Double Buffer Cache）：有两个缓冲区，可以同时分别读写；结束之后可以交换</li>
</ul>
<h5 id="访问频率置换frequency-based-replacement算法"><a class="markdownIt-Anchor" href="#访问频率置换frequency-based-replacement算法"></a> 访问频率置换（Frequency-based Replacement）算法</h5>
<p>问题：在一段密集磁盘访问后，LFU算法的引用计数变化无法反映当前的引用情况</p>
<p>算法思路：</p>
<ul>
<li>考虑磁盘访问的密集特征，对密集引用不计数</li>
<li>在短周期中使用LRU算法，而在长周期中使用LFU算法</li>
</ul>
<p><img src="fbr-stack.png" alt="访问频率置换算法的特殊栈"></p>
<p>算法具体步骤：</p>
<ul>
<li>把LRU算法中的特殊栈分成3部分，并为每个缓存块增加一个引用计数
<ul>
<li>新区域（New Section）：栈顶</li>
<li>中间区域（Middle Section）</li>
<li>旧区域（Old Section）：栈底</li>
</ul>
</li>
<li>每次访问时：
<ul>
<li>栈中被访问的缓存块移到栈顶（这个是LRU的原始要求）；如果该块原来在新区域，引用计数不变（这个是符合LRU的）；否则引用计数+1
<ul>
<li>在新区域中引用计数不变的目的是避免密集访问对引用计数产生不利影响</li>
<li>在中间区域和旧区域中引用计数+1是为了使用LFU算法</li>
</ul>
</li>
<li>未缓存数据块读入后放在栈顶，引用计数为1</li>
<li>在旧区域中引用计数最小的缓存块被置换（这是LFU的要求；但并不会在整个栈里找计数最小的）
<ul>
<li>中间区域的定义是为了避免新读入的缓存块在第一次离开新区域时马上被置换，有一个过渡期</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>例子：懒得想了，不写了</p>
<h2 id="练习"><a class="markdownIt-Anchor" href="#练习"></a> 练习</h2>
<p>来自<a href="https://github.com/chyyuu/os_course_exercises/blob/2018spring/all/10-1-quiz.md" target="_blank" rel="noopener">lec23 IO设备 在线练习</a>和<a href="https://github.com/chyyuu/os_course_exercises/blob/2018spring/all/10-1-spoc-discussion.md" target="_blank" rel="noopener">IO设备(lec 23) spoc 思考题</a>。</p>
<h3 id="选择填空题"><a class="markdownIt-Anchor" href="#选择填空题"></a> 选择填空题</h3>
<p><strong>字符设备包括（）</strong></p>
<ul>
<li><strong>键盘</strong></li>
<li><strong>鼠标</strong></li>
<li><strong>并口</strong></li>
<li><strong>串口</strong></li>
</ul>
<p>都是。因为它们的访问特征都是以字节为单位顺序访问。</p>
<hr>
<p><strong>块设备包括（）</strong></p>
<ul>
<li><strong>硬盘</strong></li>
<li><strong>软盘</strong></li>
<li><strong>光盘</strong></li>
<li><strong>U盘</strong></li>
</ul>
<p>都是。因为它们的访问特征都是均匀的数据块访问。</p>
<hr>
<p><strong>网络设备包括（）</strong></p>
<ul>
<li><strong>以太网卡</strong></li>
<li><strong>wifi网卡</strong></li>
<li><strong>蓝牙设备</strong></li>
<li>网盘设备</li>
</ul>
<p>网络设备的访问特征是格式化报文交换。而网盘在模拟实现上应该算块设备。</p>
<hr>
<p><strong>关于CPU与设备的通信方式包括（）</strong></p>
<ul>
<li><strong>轮询</strong></li>
<li><strong>设备中断</strong></li>
<li><strong>DMA</strong></li>
<li>PIPE</li>
</ul>
<p>PIPE是用于进程间通信的。虽然DMA听起来是直接把数据写入到内存，不过还是需要CPU参与设置的。</p>
<hr>
<p><strong>关于IO数据传输的阐述正确的是（）</strong></p>
<ul>
<li><strong>程序控制I/O(PIO, Programmed I/O)通过CPU的in/out或者load/store传输所有数据</strong></li>
<li><strong>DMA设备控制器可直接访问系统总线并直接与内存互相传输数据</strong></li>
<li>DMA机制适合字符设备</li>
<li>PIO机制适合块设备</li>
</ul>
<p>DMA机制适合块设备，PIO机制适合简单，低速的字符设备等。最后两个选项反了。</p>
<hr>
<p><strong>常用移臂调度算法包括（）</strong></p>
<ul>
<li><strong>先来先服务（FIFO）算法</strong></li>
<li><strong>最短寻道时间优先（SSTF）算法</strong></li>
<li><strong>电梯调度（SCAN）算法</strong></li>
<li><strong>单向扫描（C-SCAN）算法</strong></li>
</ul>
<p>都对。除此之外还有CLOOK和N-step-SCAN算法。</p>
<hr>
<p><strong>在设备管理子系统中，引入缓冲区的目的主要有()</strong></p>
<ul>
<li><strong>缓和CPU与I/O设备间速度不匹配的矛盾</strong></li>
<li><strong>减少对CPU的中断频率，放宽对CPU中断响应时间的限制</strong></li>
<li><strong>解决基本数据单元大小（即数据粒度）不匹配的问题</strong></li>
<li><strong>提高CPU和I/O设备之间的并行性</strong></li>
</ul>
<p>都对。</p>
<h3 id="简答题"><a class="markdownIt-Anchor" href="#简答题"></a> 简答题</h3>
<p><strong>字符设备的特点是什么？</strong></p>
<p>以字节为单位顺序访问。</p>
<hr>
<p><strong>块设备的特点是什么？</strong></p>
<p>以均匀的数据块为单位随机访问。</p>
<hr>
<p><strong>网络设备的特点是什么？</strong></p>
<p>以格式化报文为单位的复杂交互访问。</p>
<hr>
<p><strong>阻塞I/O、非阻塞I/O和异步I/O这三种I/O方式有什么区别？</strong></p>
<ul>
<li>阻塞I/O：数据读写操作后，进程将进入等待状态，直到完成操作时返回；</li>
<li>非阻塞I/O：数据读写操作后，进程将立即返回；</li>
<li>异步I/O：数据读写操作后，进程将立即返回；内核在完成操作时通知进程；</li>
</ul>
<p>区别：</p>
<ul>
<li>进程发出操作命令后，进程是否等待；</li>
<li>操作结果反馈方式</li>
</ul>
<hr>
<p><strong>请描述I/O请求到完成的整个执行过程。</strong></p>
<p>CPU通过总线与设备相连；CPU通过主动的I/O端口和映射内存读写操作与设备进行信息交互；设备通过中断请求来响应CPU的操作；在CPU的控制下，DMA可直接在设备接口与内存间的数据传输。</p>
<ol>
<li>进程通过系统调用发送对设备的抽象操作命令</li>
<li>内核把抽象的设备操作命令转换成具体的设备I/O端口和映射内存读写序列，并在设备驱动中实施读写操作</li>
<li>当这个读写序列较长时，CPU会控制DMA进行内存与设备接口的直接数据传送</li>
<li>设备在收到控制序列后，执行操作动作，并在完成时向CPU发出中断请求</li>
<li>CPU通过中断服务例程响应设备的中断请求，并进行后续处理，直到系统调用返回，从而完成整个I/O操作过程。</li>
</ol>
<hr>
<p><strong>IO数据传输有哪几种？</strong></p>
<ul>
<li>程序控制I/O：
<ul>
<li>CPU通过显式的IO指令，如x86的in, out等传输数据</li>
<li>memory读写方式，即把device的寄存器，内存等映射到物理内存中</li>
</ul>
</li>
<li>直接内存访问（DMA）：在CPU的控制下，DMA控制器直接在内存与设备接口间传输数据</li>
</ul>
<hr>
<p><strong>轮询方式的特点是什么？</strong></p>
<ul>
<li>简单</li>
<li>I/O操作频繁或不可预测时，开销大和延时长</li>
</ul>
<hr>
<p><strong>中断方式的特点是什么？</strong></p>
<ul>
<li>处理不可预测事件效果好</li>
<li>开销相对较高</li>
</ul>
<hr>
<p><strong>DMA方式的特点是什么？</strong></p>
<ul>
<li>直接在内存与设备接口间进行数据传输</li>
<li>适合高速和简单的数据传输</li>
<li>CPU的开销小</li>
</ul>
<hr>
<p><strong>请简要阐述磁盘的工作过程。</strong></p>
<ul>
<li>磁头移动到期望的磁道</li>
<li>盘片旋转定位到期望的柱面和扇区</li>
<li>开始读写</li>
</ul>
<hr>
<p><strong>请描述磁盘I/O操作时间组成。</strong></p>
<p>磁盘I/O操作一般分成五个步骤：</p>
<ul>
<li>等待设备可用</li>
<li>等待通道（PIO或DMA通道）可用</li>
<li>寻道</li>
<li>旋转延迟</li>
<li>数据传输</li>
</ul>
<p>其中后四个步骤被称为“设备忙”状态，一般认为是传输时间，公式为：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>T</mi><mi>a</mi></msub><mo>=</mo><msub><mi>T</mi><mi>s</mi></msub><mo>+</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>r</mi></mrow></mfrac><mo>+</mo><mfrac><mi>b</mi><mrow><mi>r</mi><mi>N</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">T_a = T_s+ \frac{1}{2r} + \frac{b}{rN}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.05744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<hr>
<p><strong>请说明磁盘调度算法的评价指标。</strong></p>
<ul>
<li>总的I/O时间开销（显然）</li>
<li>公平性</li>
<li>平均等待时间（似乎这对磁盘调度不是很重要）</li>
</ul>
<hr>
<p><strong>请描述FIFO、SSTF、SCAN、CSCAN、LOOK、C-LOOK、N-step-SCAN和FSCAN等磁盘调度算法的工作原理。</strong></p>
<p>磁盘调度算法就是优化磁盘数据块的访问顺序。</p>
<ul>
<li>先进先出（FIFO）算法：按请求顺序访问</li>
<li>最短寻道时间优先（SSTF）算法：从当前位置找当前最近的访问数据块位置</li>
<li>扫描（SCAN）算法：保持磁头移动方向到最远处，并顺序访问需要访问的数据块</li>
<li>循环扫描（C-SCAN）算法：只在一个方向上移动时访问数据的SCAN算法</li>
<li>LOOK算法：保持磁头移动方向到已有的最后一个请求，并顺序访问需要访问的数据块</li>
<li>C-LOOK算法：只在一个方向上移动时访问数据的LOOK算法；</li>
<li>N步扫描（N-step-SCAN）算法：
<ol>
<li>将磁盘请求队列分成长度为N的子队列</li>
<li>按FIFO算法依次处理所有子队列</li>
<li>按扫描算法处理每个队列</li>
</ol>
</li>
<li>双队列扫描（FSCAN）算法：
<ol>
<li>把磁盘I/O请求分成两个队列，交替使用扫描算法处理一个队列</li>
<li>新生成的磁盘I/O请求放入另一队列中</li>
</ol>
</li>
</ul>
<hr>
<p><strong>磁盘缓存的作用是什么？</strong></p>
<p>磁盘缓存是磁盘扇区在内存中的缓存区。作用是通过缓存访问，减少磁盘访问。</p>
<hr>
<p><strong>请描述单缓存(Single Buffer Cache)的工作原理。</strong></p>
<p>只有一个缓存区，用户进程和I/O设备只能交替访问缓存区。</p>
<hr>
<p><strong>请描述双缓存(Double Buffer Cache)的工作原理。</strong></p>
<p>设置两个缓存区，任何时刻用户进程和I/O设备可同时访问不同的缓存区。</p>
<hr>
<p><strong>请描述访问频率置换算法(Frequency-based Replacement)的基本原理。</strong></p>
<p>思路：</p>
<ul>
<li>考虑磁盘访问的密集特征，对密集引用不计数</li>
<li>短周期内采用LRU，长周期内采用LFU</li>
</ul>
<p>做法：</p>
<ul>
<li>把栈分成三个区域：新区域（栈顶）、中间区域、旧区域（栈底）</li>
<li>新区域中数据块的引用，不计数</li>
<li>中间区域和旧区域中数据块的引用，引用计数加</li>
<li>淘汰只在旧区域中找引用计数最小的数据块</li>
</ul>
<h3 id="实践题"><a class="markdownIt-Anchor" href="#实践题"></a> 实践题</h3>
<p><strong>请以键盘输入、到标准输出设备stdout的printf输出、串口输出、磁盘文件复制为例，描述ucore操作系统I/O从请求到完成的整个执行过程，并分析I/O过程的时间开销。</strong></p>
<p>没做，现在还没做完lab8，感觉实在过于麻烦了。</p>
<hr>
<p><strong>完成磁盘访问与磁盘寻道算法的作业，然后实现CSCAN、LOOK、C-LOOK、FSCAN等磁盘调度算法中的一个。具体帮助和要求信息请看<a href="http://pages.cs.wisc.edu/~remzi/OSTEP/file-disks.pdf" target="_blank" rel="noopener">Chapter 37: Hard Disk Drives</a>、<a href="https://github.com/chyyuu/ucore_os_lab/blob/master/related_info/lab8/disksim-homework.md" target="_blank" rel="noopener">disksim指导信息</a>和<a href="https://github.com/chyyuu/ucore_os_lab/blob/master/related_info/lab8/disksim-homework.py" target="_blank" rel="noopener">disksim参考代码</a></strong></p>
<p>看起来不难，但现在做起来意义不大，所以不做了。</p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/OS/"><i class="fas fa-hashtag fa-fw"></i>OS</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
      

  </section>






  
      <br>
      <div class="prev-next">
          <div class="prev-next">
              
                  <a class="prev" rel="prev" href="/archives/2018/page/23/">
                      <section class="post prev">
                          <i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页&nbsp;
                      </section>
                  </a>
              
              <p class="current">
                  24 / 29
              </p>
              
                  <a class="next" rel="next" href="/archives/2018/page/25/">
                      <section class="post next">
                          &nbsp;下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i>
                      </section>
                  </a>
              

          </div>
      </div>

  

  <!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
  

  
    <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX","TeX"],
      linebreaks: { automatic:true },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: { autoNumber: "AMS" },
      noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
      Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += (all[i].SourceElement().parentNode.className ? ' ' : '') + 'has-jax';
    }
    console.log("mathjax did loaded!");
  });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

  





<!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->



    <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX","TeX"],
      linebreaks: { automatic:true },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: { autoNumber: "AMS" },
      noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
      Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += (all[i].SourceElement().parentNode.className ? ' ' : '') + 'has-jax';
    }
    console.log("mathjax did loaded!");
  });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



        </div>
        <aside class='l_side'>
            
  
  
    
      
      
        <section class="author">
  <div class="content pure">
    
    
    
      <div class="social-wrapper">
        
          
            <a href="mailto:zhanghuimeng1997@gmail.com" class="social flat-btn" target="_blank" rel="external"><i class="social fas fa-envelope" aria-hidden="true"></i></a>
          
        
          
            <a href="https://github.com/zhanghuimeng" class="social flat-btn" target="_blank" rel="external"><i class="social fab fa-github" aria-hidden="true"></i></a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=261028414" class="social flat-btn" target="_blank" rel="external"><i class="social fas fa-music" aria-hidden="true"></i></a>
          
        
      </div>
    
  </div>
</section>

      
    
  
    
      
      
        

      
    
  
    
      
      
        
  <section class="category">
    
<header class="pure">
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;所有分类</div>
  
</header>

    <div class="content pure">
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/Codeforces/" href="/categories/Codeforces/"><div class="name">Codeforces</div><div class="badge">(3)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Leetcode/" href="/categories/Leetcode/"><div class="name">Leetcode</div><div class="badge">(9)</div></a></li>
        
          <li><a class="flat-box" title="/categories/USACO/" href="/categories/USACO/"><div class="name">USACO</div><div class="badge">(1)</div></a></li>
        
      </ul>
    </div>
  </section>


      
    
  
    
      
      
        
  <section class="tagcloud">
    
<header class="pure">
  <div><i class="fas fa-fire fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
</header>

    <div class="content pure">
      <a href="/tags/A-Munday/" style="font-size: 14px; color: #999">A.Munday</a> <a href="/tags/Blogging/" style="font-size: 14px; color: #999">Blogging</a> <a href="/tags/C-Marlowe/" style="font-size: 14px; color: #999">C.Marlowe</a> <a href="/tags/CSP/" style="font-size: 15.11px; color: #919191">CSP</a> <a href="/tags/Codeforces/" style="font-size: 19.56px; color: #737373">Codeforces</a> <a href="/tags/Codeforces-Contest/" style="font-size: 19.19px; color: #767676">Codeforces Contest</a> <a href="/tags/Counseling/" style="font-size: 14px; color: #999">Counseling</a> <a href="/tags/Cryptography/" style="font-size: 14px; color: #999">Cryptography</a> <a href="/tags/D-Drayton/" style="font-size: 14px; color: #999">D.Drayton</a> <a href="/tags/Deep-Learning/" style="font-size: 14px; color: #999">Deep Learning</a> <a href="/tags/Depth-first-Search/" style="font-size: 14px; color: #999">Depth-first Search</a> <a href="/tags/DigitCircuit/" style="font-size: 14px; color: #999">DigitCircuit</a> <a href="/tags/E-Vere/" style="font-size: 14px; color: #999">E. Vere</a> <a href="/tags/E-Spencer/" style="font-size: 14px; color: #999">E.Spencer</a> <a href="/tags/Essay/" style="font-size: 14.37px; color: #969696">Essay</a> <a href="/tags/Github/" style="font-size: 14.74px; color: #949494">Github</a> <a href="/tags/GoldenTreasury/" style="font-size: 23.26px; color: #5a5a5a">GoldenTreasury</a> <a href="/tags/H-Constable/" style="font-size: 14px; color: #999">H.Constable</a> <a href="/tags/J-Donne/" style="font-size: 14px; color: #999">J.Donne</a> <a href="/tags/J-Lyly/" style="font-size: 14px; color: #999">J.Lyly</a> <a href="/tags/J-Sylvester/" style="font-size: 14px; color: #999">J.Sylvester</a> <a href="/tags/J-Webster/" style="font-size: 14px; color: #999">J.Webster</a> <a href="/tags/Leetcode/" style="font-size: 24px; color: #555">Leetcode</a> <a href="/tags/Leetcode-Contest/" style="font-size: 23.63px; color: #585858">Leetcode Contest</a> <a href="/tags/Lyric/" style="font-size: 17.33px; color: #828282">Lyric</a> <a href="/tags/Machine-Learning/" style="font-size: 15.11px; color: #919191">Machine Learning</a> <a href="/tags/Machine-Translation/" style="font-size: 16.59px; color: #878787">Machine Translation</a> <a href="/tags/Natural-Language-Processing/" style="font-size: 17.33px; color: #828282">Natural Language Processing</a> <a href="/tags/OS/" style="font-size: 21.78px; color: #646464">OS</a> <a href="/tags/OSTEP/" style="font-size: 18.07px; color: #7d7d7d">OSTEP</a> <a href="/tags/OldBlog/" style="font-size: 15.11px; color: #919191">OldBlog</a> <a href="/tags/P-Sidney/" style="font-size: 14px; color: #999">P.Sidney</a> <a href="/tags/Paper/" style="font-size: 16.59px; color: #878787">Paper</a> <a href="/tags/Paul-Simon/" style="font-size: 14px; color: #999">Paul Simon</a> <a href="/tags/PhysicsExperiment/" style="font-size: 14.37px; color: #969696">PhysicsExperiment</a> <a href="/tags/Psychology/" style="font-size: 14px; color: #999">Psychology</a> <a href="/tags/Quality-Estimation/" style="font-size: 15.48px; color: #8f8f8f">Quality Estimation</a> <a href="/tags/R-Barnfield/" style="font-size: 14px; color: #999">R.Barnfield</a> <a href="/tags/Raspberry-Pi/" style="font-size: 14px; color: #999">Raspberry Pi</a> <a href="/tags/Reading-Report/" style="font-size: 17.7px; color: #808080">Reading Report</a> <a href="/tags/S-Daniel/" style="font-size: 14px; color: #999">S.Daniel</a> <a href="/tags/SGU/" style="font-size: 14.37px; color: #969696">SGU</a> <a href="/tags/Sonnet/" style="font-size: 20.67px; color: #6c6c6c">Sonnet</a> <a href="/tags/Spokes/" style="font-size: 14.74px; color: #949494">Spokes</a> <a href="/tags/SystemAnalysis-Control/" style="font-size: 14px; color: #999">SystemAnalysis&Control</a> <a href="/tags/T-Dekker/" style="font-size: 14px; color: #999">T.Dekker</a> <a href="/tags/T-Heywood/" style="font-size: 14px; color: #999">T.Heywood</a> <a href="/tags/T-Lodge/" style="font-size: 14px; color: #999">T.Lodge</a> <a href="/tags/T-Nashe/" style="font-size: 14px; color: #999">T.Nashe</a> <a href="/tags/T-Wyatt/" style="font-size: 14px; color: #999">T.Wyatt</a> <a href="/tags/THUMT/" style="font-size: 14.37px; color: #969696">THUMT</a> <a href="/tags/TensorFlow/" style="font-size: 15.11px; color: #919191">TensorFlow</a> <a href="/tags/Translation/" style="font-size: 18.44px; color: #7b7b7b">Translation</a> <a href="/tags/Tree/" style="font-size: 14px; color: #999">Tree</a> <a href="/tags/USACO/" style="font-size: 22.52px; color: #5f5f5f">USACO</a> <a href="/tags/W-Alexander/" style="font-size: 14px; color: #999">W.Alexander</a> <a href="/tags/W-Drummond/" style="font-size: 15.11px; color: #919191">W.Drummond</a> <a href="/tags/W-Shakespeare/" style="font-size: 22.15px; color: #626262">W.Shakespeare</a> <a href="/tags/object-Object/" style="font-size: 14px; color: #999">[object Object]</a> <a href="/tags/alg-Array/" style="font-size: 21.04px; color: #696969">alg:Array</a> <a href="/tags/alg-Automata/" style="font-size: 14px; color: #999">alg:Automata</a> <a href="/tags/alg-Backtracking/" style="font-size: 15.85px; color: #8c8c8c">alg:Backtracking</a> <a href="/tags/alg-Binary-Indexed-Tree/" style="font-size: 14px; color: #999">alg:Binary Indexed Tree</a> <a href="/tags/alg-Binary-Search/" style="font-size: 15.48px; color: #8f8f8f">alg:Binary Search</a> <a href="/tags/alg-Binary-Search-Tree/" style="font-size: 16.59px; color: #878787">alg:Binary Search Tree</a> <a href="/tags/alg-Binray-Search/" style="font-size: 14px; color: #999">alg:Binray Search</a> <a href="/tags/alg-Bit-Manipulation/" style="font-size: 15.48px; color: #8f8f8f">alg:Bit Manipulation</a> <a href="/tags/alg-Bitmasks/" style="font-size: 14px; color: #999">alg:Bitmasks</a> <a href="/tags/alg-Breadth-first-Search/" style="font-size: 17.33px; color: #828282">alg:Breadth-first Search</a> <a href="/tags/alg-Breadth-firth-Search/" style="font-size: 14.37px; color: #969696">alg:Breadth-firth Search</a> <a href="/tags/alg-Brute-Force/" style="font-size: 16.96px; color: #858585">alg:Brute Force</a> <a href="/tags/alg-Centroid-Decomposition/" style="font-size: 14px; color: #999">alg:Centroid Decomposition</a> <a href="/tags/alg-Depth-first-Search/" style="font-size: 20.3px; color: #6e6e6e">alg:Depth-first Search</a> <a href="/tags/alg-Divide-and-Conquer/" style="font-size: 14px; color: #999">alg:Divide and Conquer</a> <a href="/tags/alg-Dynamic-Porgramming/" style="font-size: 14px; color: #999">alg:Dynamic Porgramming</a> <a href="/tags/alg-Dynamic-Programming/" style="font-size: 21.04px; color: #696969">alg:Dynamic Programming</a> <a href="/tags/alg-Games/" style="font-size: 14px; color: #999">alg:Games</a> <a href="/tags/alg-Geometry/" style="font-size: 14px; color: #999">alg:Geometry</a> <a href="/tags/alg-Graph/" style="font-size: 15.48px; color: #8f8f8f">alg:Graph</a> <a href="/tags/alg-Greedy/" style="font-size: 21.41px; color: #676767">alg:Greedy</a> <a href="/tags/alg-Hash-Table/" style="font-size: 20.67px; color: #6c6c6c">alg:Hash Table</a> <a href="/tags/alg-Heap/" style="font-size: 15.11px; color: #919191">alg:Heap</a> <a href="/tags/alg-In-Order-Traversal/" style="font-size: 14.37px; color: #969696">alg:In-Order Traversal</a> <a href="/tags/alg-Linked-List/" style="font-size: 15.48px; color: #8f8f8f">alg:Linked List</a> <a href="/tags/alg-Math/" style="font-size: 22.89px; color: #5d5d5d">alg:Math</a> <a href="/tags/alg-Matrix/" style="font-size: 14px; color: #999">alg:Matrix</a> <a href="/tags/alg-Meet-in-the-Middle/" style="font-size: 14.37px; color: #969696">alg:Meet in the Middle</a> <a href="/tags/alg-Minimax/" style="font-size: 14px; color: #999">alg:Minimax</a> <a href="/tags/alg-Monotonic-Stack/" style="font-size: 15.48px; color: #8f8f8f">alg:Monotonic Stack</a> <a href="/tags/alg-Priority-Queue/" style="font-size: 14px; color: #999">alg:Priority Queue</a> <a href="/tags/alg-Queue/" style="font-size: 14.74px; color: #949494">alg:Queue</a> <a href="/tags/alg-Random/" style="font-size: 14.74px; color: #949494">alg:Random</a> <a href="/tags/alg-Recursion/" style="font-size: 15.48px; color: #8f8f8f">alg:Recursion</a> <a href="/tags/alg-Recursive/" style="font-size: 14.37px; color: #969696">alg:Recursive</a> <a href="/tags/alg-Rejection-Sampling/" style="font-size: 14px; color: #999">alg:Rejection Sampling</a> <a href="/tags/alg-Reservoir-Sampling/" style="font-size: 14px; color: #999">alg:Reservoir Sampling</a> <a href="/tags/alg-Segmentation-Tree/" style="font-size: 14px; color: #999">alg:Segmentation Tree</a> <a href="/tags/alg-Set/" style="font-size: 14px; color: #999">alg:Set</a> <a href="/tags/alg-Sort/" style="font-size: 14.74px; color: #949494">alg:Sort</a> <a href="/tags/alg-Stack/" style="font-size: 18.44px; color: #7b7b7b">alg:Stack</a> <a href="/tags/alg-String/" style="font-size: 18.81px; color: #787878">alg:String</a> <a href="/tags/alg-Topological-Sort/" style="font-size: 14px; color: #999">alg:Topological Sort</a> <a href="/tags/alg-Tree/" style="font-size: 19.93px; color: #717171">alg:Tree</a> <a href="/tags/alg-Trie/" style="font-size: 14px; color: #999">alg:Trie</a> <a href="/tags/alg-Two-Pointers/" style="font-size: 18.07px; color: #7d7d7d">alg:Two Pointers</a> <a href="/tags/alg-Union-find-Forest/" style="font-size: 15.48px; color: #8f8f8f">alg:Union-find Forest</a> <a href="/tags/artist-Ceremony/" style="font-size: 14px; color: #999">artist:Ceremony</a> <a href="/tags/artist-Cruel-Hand/" style="font-size: 14.37px; color: #969696">artist:Cruel Hand</a> <a href="/tags/artist-Have-Heart/" style="font-size: 14px; color: #999">artist:Have Heart</a> <a href="/tags/artist-Johnny-Cash/" style="font-size: 14px; color: #999">artist:Johnny Cash</a> <a href="/tags/artist-Touche-Amore/" style="font-size: 14px; color: #999">artist:Touche Amore</a> <a href="/tags/artist-Wir-Sind-Helden/" style="font-size: 14.74px; color: #949494">artist:Wir Sind Helden</a> <a href="/tags/translation/" style="font-size: 14px; color: #999">translation</a> <a href="/tags/ucore/" style="font-size: 14px; color: #999">ucore</a> <a href="/tags/付勇林/" style="font-size: 15.85px; color: #8c8c8c">付勇林</a> <a href="/tags/卞之琳/" style="font-size: 14px; color: #999">卞之琳</a> <a href="/tags/屠岸/" style="font-size: 16.22px; color: #8a8a8a">屠岸</a> <a href="/tags/戴镏龄/" style="font-size: 15.85px; color: #8c8c8c">戴镏龄</a> <a href="/tags/曹明伦/" style="font-size: 15.48px; color: #8f8f8f">曹明伦</a> <a href="/tags/朱生豪/" style="font-size: 17.7px; color: #808080">朱生豪</a> <a href="/tags/李霁野/" style="font-size: 15.11px; color: #919191">李霁野</a> <a href="/tags/杨熙龄/" style="font-size: 14px; color: #999">杨熙龄</a> <a href="/tags/林天斗/" style="font-size: 14px; color: #999">林天斗</a> <a href="/tags/梁宗岱/" style="font-size: 16.96px; color: #858585">梁宗岱</a> <a href="/tags/梁葆成/" style="font-size: 14px; color: #999">梁葆成</a> <a href="/tags/袁广达/" style="font-size: 14px; color: #999">袁广达</a> <a href="/tags/郭沫若/" style="font-size: 14px; color: #999">郭沫若</a> <a href="/tags/黄新渠/" style="font-size: 14px; color: #999">黄新渠</a>
    </div>
  </section>


      
    
  
    
      
      
        <section class="list">
  
<header class="pure">
  <div><i class="fas fa-link fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;特别链接</div>
  
</header>

  <div class="content pure">
    <ul class="entry">
      
        <li><a class="flat-box" title="https://wenj.github.io/" href="https://wenj.github.io/">
          <div class="name">
            
              <i class="fas fa-comment-dots fa-fw" aria-hidden="true"></i>
            
            &nbsp;&nbsp;wenj
          </div>
          
        </a></li>
      
        <li><a class="flat-box" title="http://bellasong.site/" href="http://bellasong.site/">
          <div class="name">
            
              <i class="fas fa-comment-dots fa-fw" aria-hidden="true"></i>
            
            &nbsp;&nbsp;ssh
          </div>
          
        </a></li>
      
    </ul>
  </div>
</section>

      
    
  


        </aside>
        <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
    </div>
    <footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="mailto:zhanghuimeng1997@gmail.com" class="social fas fa-envelope flat-btn" target="_blank" rel="external"></a>
        
      
        
          <a href="https://github.com/zhanghuimeng" class="social fab fa-github flat-btn" target="_blank" rel="external"></a>
        
      
        
          <a href="https://music.163.com/#/user/home?id=261028414" class="social fas fa-music flat-btn" target="_blank" rel="external"></a>
        
      
    </div>
  
  <br>
  <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>本站使用 <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a> 作为主题，总访问量为 <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span> 次。
  </div>
</footer>

    <script>setLoadingBarProgress(80);</script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>


  
    <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
    <script type="text/javascript">
      $(function() {
        const $reveal = $('.reveal');
    		if ($reveal.length === 0) return;
    		const sr = ScrollReveal({ distance: 0 });
    		sr.reveal('.reveal');
      });
    </script>
  
  
    <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
    <script type="text/javascript">
      $(function() {
        Waves.attach('.flat-btn', ['waves-button']);
        Waves.attach('.float-btn', ['waves-button', 'waves-float']);
        Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
        Waves.attach('.flat-box', ['waves-block']);
        Waves.attach('.float-box', ['waves-block', 'waves-float']);
        Waves.attach('.waves-image');
        Waves.init();
      });
    </script>
  
  
    <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>
  
  
  


  
  
  
    
  
  
    <script src="/js/app.js"></script>
<script src="/js/search.js"></script>
  








    <script>setLoadingBarProgress(100);</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
